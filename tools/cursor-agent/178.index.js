try{!function(){var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:{},t=(new e.Error).stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="35f2509e-5b96-4379-8fbf-7de25bf4043c",e._sentryDebugIdIdentifier="sentry-dbid-35f2509e-5b96-4379-8fbf-7de25bf4043c")}()}catch(e){}!function(){try{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:{}).SENTRY_RELEASE={id:"agent-cli@2026.01.28-fd13201"}}catch(e){}}(),exports.id=178,exports.ids=[178],exports.modules={"../../node_modules/.pnpm/hono@4.11.4/node_modules/hono/dist/utils lazy recursive":e=>{function t(e){return Promise.resolve().then((()=>{var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}))}t.keys=()=>[],t.resolve=t,t.id="../../node_modules/.pnpm/hono@4.11.4/node_modules/hono/dist/utils lazy recursive",e.exports=t},"./src/bridge/bridge.ts":(e,t,n)=>{"use strict";n.d(t,{Q:()=>Ft});var r,s,i,o,a=n("node:child_process"),c=n("../context/dist/index.js"),l=n("node:crypto"),d=n("node:fs"),u=n("node:fs/promises"),h=n("node:path"),m=n("node:stream"),f=n("../../node_modules/.pnpm/@bufbuild+protobuf@1.10.0/node_modules/@bufbuild/protobuf/dist/esm/proto3.js"),p=n("../../node_modules/.pnpm/@bufbuild+protobuf@1.10.0/node_modules/@bufbuild/protobuf/dist/esm/message.js"),g=n("../../node_modules/.pnpm/@bufbuild+protobuf@1.10.0/node_modules/@bufbuild/protobuf/dist/esm/proto-int64.js");!function(e){e[e.UNSPECIFIED=0]="UNSPECIFIED",e[e.FILE=1]="FILE",e[e.DIRECTORY=2]="DIRECTORY",e[e.SYMLINK=3]="SYMLINK"}(r||(r={})),f.C.util.setEnumType(r,"agent.v1.EntryType",[{no:0,name:"ENTRY_TYPE_UNSPECIFIED"},{no:1,name:"ENTRY_TYPE_FILE"},{no:2,name:"ENTRY_TYPE_DIRECTORY"},{no:3,name:"ENTRY_TYPE_SYMLINK"}]),function(e){e[e.UNSPECIFIED=0]="UNSPECIFIED",e[e.NOT_STARTED=1]="NOT_STARTED",e[e.IN_PROGRESS=2]="IN_PROGRESS",e[e.COMPLETED=3]="COMPLETED",e[e.FAILED=4]="FAILED"}(s||(s={})),f.C.util.setEnumType(s,"agent.v1.ArtifactUploadStatus",[{no:0,name:"ARTIFACT_UPLOAD_STATUS_UNSPECIFIED"},{no:1,name:"ARTIFACT_UPLOAD_STATUS_NOT_STARTED"},{no:2,name:"ARTIFACT_UPLOAD_STATUS_IN_PROGRESS"},{no:3,name:"ARTIFACT_UPLOAD_STATUS_COMPLETED"},{no:4,name:"ARTIFACT_UPLOAD_STATUS_FAILED"}]),function(e){e[e.UNSPECIFIED=0]="UNSPECIFIED",e[e.MISSING=1]="MISSING",e[e.PERMISSION=2]="PERMISSION",e[e.NOT_A_FILE=3]="NOT_A_FILE",e[e.INVALID_PATH=4]="INVALID_PATH",e[e.UNKNOWN=5]="UNKNOWN"}(i||(i={})),f.C.util.setEnumType(i,"agent.v1.ArtifactPathErrorKind",[{no:0,name:"ARTIFACT_PATH_ERROR_KIND_UNSPECIFIED"},{no:1,name:"ARTIFACT_PATH_ERROR_KIND_MISSING"},{no:2,name:"ARTIFACT_PATH_ERROR_KIND_PERMISSION"},{no:3,name:"ARTIFACT_PATH_ERROR_KIND_NOT_A_FILE"},{no:4,name:"ARTIFACT_PATH_ERROR_KIND_INVALID_PATH"},{no:5,name:"ARTIFACT_PATH_ERROR_KIND_UNKNOWN"}]),function(e){e[e.UNSPECIFIED=0]="UNSPECIFIED",e[e.ACCEPTED=1]="ACCEPTED",e[e.REJECTED=2]="REJECTED",e[e.SKIPPED_ALREADY_IN_PROGRESS=3]="SKIPPED_ALREADY_IN_PROGRESS"}(o||(o={})),f.C.util.setEnumType(o,"agent.v1.ArtifactUploadDispatchStatus",[{no:0,name:"ARTIFACT_UPLOAD_DISPATCH_STATUS_UNSPECIFIED"},{no:1,name:"ARTIFACT_UPLOAD_DISPATCH_STATUS_ACCEPTED"},{no:2,name:"ARTIFACT_UPLOAD_DISPATCH_STATUS_REJECTED"},{no:3,name:"ARTIFACT_UPLOAD_DISPATCH_STATUS_SKIPPED_ALREADY_IN_PROGRESS"}]);class w extends p.Q{constructor(e){super(),f.C.util.initPartial(e,this)}static runtime=f.C;static typeName="agent.v1.PingRequest";static fields=f.C.util.newFieldList((()=>[]));static fromBinary(e,t){return(new w).fromBinary(e,t)}static fromJson(e,t){return(new w).fromJson(e,t)}static fromJsonString(e,t){return(new w).fromJsonString(e,t)}static equals(e,t){return f.C.util.equals(w,e,t)}}class y extends p.Q{constructor(e){super(),f.C.util.initPartial(e,this)}static runtime=f.C;static typeName="agent.v1.PingResponse";static fields=f.C.util.newFieldList((()=>[]));static fromBinary(e,t){return(new y).fromBinary(e,t)}static fromJson(e,t){return(new y).fromJson(e,t)}static fromJsonString(e,t){return(new y).fromJsonString(e,t)}static equals(e,t){return f.C.util.equals(y,e,t)}}class v extends p.Q{command="";cwd;args=[];environment={};constructor(e){super(),f.C.util.initPartial(e,this)}static runtime=f.C;static typeName="agent.v1.ExecRequest";static fields=f.C.util.newFieldList((()=>[{no:1,name:"command",kind:"scalar",T:9},{no:2,name:"cwd",kind:"scalar",T:9,opt:!0},{no:3,name:"args",kind:"scalar",T:9,repeated:!0},{no:4,name:"environment",kind:"map",K:9,V:{kind:"scalar",T:9}}]));static fromBinary(e,t){return(new v).fromBinary(e,t)}static fromJson(e,t){return(new v).fromJson(e,t)}static fromJsonString(e,t){return(new v).fromJsonString(e,t)}static equals(e,t){return f.C.util.equals(v,e,t)}}class b extends p.Q{event={case:void 0};constructor(e){super(),f.C.util.initPartial(e,this)}static runtime=f.C;static typeName="agent.v1.ExecResponse";static fields=f.C.util.newFieldList((()=>[{no:1,name:"stdout_event",kind:"message",T:E,oneof:"event"},{no:2,name:"stderr_event",kind:"message",T:C,oneof:"event"},{no:3,name:"exit_event",kind:"message",T:S,oneof:"event"}]));static fromBinary(e,t){return(new b).fromBinary(e,t)}static fromJson(e,t){return(new b).fromJson(e,t)}static fromJsonString(e,t){return(new b).fromJsonString(e,t)}static equals(e,t){return f.C.util.equals(b,e,t)}}class E extends p.Q{data="";constructor(e){super(),f.C.util.initPartial(e,this)}static runtime=f.C;static typeName="agent.v1.StdoutEvent";static fields=f.C.util.newFieldList((()=>[{no:1,name:"data",kind:"scalar",T:9}]));static fromBinary(e,t){return(new E).fromBinary(e,t)}static fromJson(e,t){return(new E).fromJson(e,t)}static fromJsonString(e,t){return(new E).fromJsonString(e,t)}static equals(e,t){return f.C.util.equals(E,e,t)}}class C extends p.Q{data="";constructor(e){super(),f.C.util.initPartial(e,this)}static runtime=f.C;static typeName="agent.v1.StderrEvent";static fields=f.C.util.newFieldList((()=>[{no:1,name:"data",kind:"scalar",T:9}]));static fromBinary(e,t){return(new C).fromBinary(e,t)}static fromJson(e,t){return(new C).fromJson(e,t)}static fromJsonString(e,t){return(new C).fromJsonString(e,t)}static equals(e,t){return f.C.util.equals(C,e,t)}}class S extends p.Q{exitCode=0;constructor(e){super(),f.C.util.initPartial(e,this)}static runtime=f.C;static typeName="agent.v1.ExitEvent";static fields=f.C.util.newFieldList((()=>[{no:1,name:"exit_code",kind:"scalar",T:5}]));static fromBinary(e,t){return(new S).fromBinary(e,t)}static fromJson(e,t){return(new S).fromJson(e,t)}static fromJsonString(e,t){return(new S).fromJsonString(e,t)}static equals(e,t){return f.C.util.equals(S,e,t)}}class k extends p.Q{path="";includeHidden=!1;constructor(e){super(),f.C.util.initPartial(e,this)}static runtime=f.C;static typeName="agent.v1.ListDirectoryRequest";static fields=f.C.util.newFieldList((()=>[{no:1,name:"path",kind:"scalar",T:9},{no:2,name:"include_hidden",kind:"scalar",T:8}]));static fromBinary(e,t){return(new k).fromBinary(e,t)}static fromJson(e,t){return(new k).fromJson(e,t)}static fromJsonString(e,t){return(new k).fromJsonString(e,t)}static equals(e,t){return f.C.util.equals(k,e,t)}}class x extends p.Q{entries=[];constructor(e){super(),f.C.util.initPartial(e,this)}static runtime=f.C;static typeName="agent.v1.ListDirectoryResponse";static fields=f.C.util.newFieldList((()=>[{no:1,name:"entries",kind:"message",T,repeated:!0}]));static fromBinary(e,t){return(new x).fromBinary(e,t)}static fromJson(e,t){return(new x).fromJson(e,t)}static fromJsonString(e,t){return(new x).fromJsonString(e,t)}static equals(e,t){return f.C.util.equals(x,e,t)}}class T extends p.Q{name="";path="";type=r.UNSPECIFIED;sizeBytes=g.M.zero;modifiedAtUnixMs=g.M.zero;constructor(e){super(),f.C.util.initPartial(e,this)}static runtime=f.C;static typeName="agent.v1.DirectoryEntry";static fields=f.C.util.newFieldList((()=>[{no:1,name:"name",kind:"scalar",T:9},{no:2,name:"path",kind:"scalar",T:9},{no:3,name:"type",kind:"enum",T:f.C.getEnumType(r)},{no:4,name:"size_bytes",kind:"scalar",T:4},{no:5,name:"modified_at_unix_ms",kind:"scalar",T:3}]));static fromBinary(e,t){return(new T).fromBinary(e,t)}static fromJson(e,t){return(new T).fromJson(e,t)}static fromJsonString(e,t){return(new T).fromJsonString(e,t)}static equals(e,t){return f.C.util.equals(T,e,t)}}class P extends p.Q{path="";constructor(e){super(),f.C.util.initPartial(e,this)}static runtime=f.C;static typeName="agent.v1.ReadTextFileRequest";static fields=f.C.util.newFieldList((()=>[{no:1,name:"path",kind:"scalar",T:9}]));static fromBinary(e,t){return(new P).fromBinary(e,t)}static fromJson(e,t){return(new P).fromJson(e,t)}static fromJsonString(e,t){return(new P).fromJsonString(e,t)}static equals(e,t){return f.C.util.equals(P,e,t)}}class _ extends p.Q{content="";constructor(e){super(),f.C.util.initPartial(e,this)}static runtime=f.C;static typeName="agent.v1.ReadTextFileResponse";static fields=f.C.util.newFieldList((()=>[{no:1,name:"content",kind:"scalar",T:9}]));static fromBinary(e,t){return(new _).fromBinary(e,t)}static fromJson(e,t){return(new _).fromJson(e,t)}static fromJsonString(e,t){return(new _).fromJsonString(e,t)}static equals(e,t){return f.C.util.equals(_,e,t)}}class I extends p.Q{path="";content="";constructor(e){super(),f.C.util.initPartial(e,this)}static runtime=f.C;static typeName="agent.v1.WriteTextFileRequest";static fields=f.C.util.newFieldList((()=>[{no:1,name:"path",kind:"scalar",T:9},{no:2,name:"content",kind:"scalar",T:9}]));static fromBinary(e,t){return(new I).fromBinary(e,t)}static fromJson(e,t){return(new I).fromJson(e,t)}static fromJsonString(e,t){return(new I).fromJsonString(e,t)}static equals(e,t){return f.C.util.equals(I,e,t)}}class A extends p.Q{constructor(e){super(),f.C.util.initPartial(e,this)}static runtime=f.C;static typeName="agent.v1.WriteTextFileResponse";static fields=f.C.util.newFieldList((()=>[]));static fromBinary(e,t){return(new A).fromBinary(e,t)}static fromJson(e,t){return(new A).fromJson(e,t)}static fromJsonString(e,t){return(new A).fromJsonString(e,t)}static equals(e,t){return f.C.util.equals(A,e,t)}}class F extends p.Q{path="";constructor(e){super(),f.C.util.initPartial(e,this)}static runtime=f.C;static typeName="agent.v1.ReadBinaryFileRequest";static fields=f.C.util.newFieldList((()=>[{no:1,name:"path",kind:"scalar",T:9}]));static fromBinary(e,t){return(new F).fromBinary(e,t)}static fromJson(e,t){return(new F).fromJson(e,t)}static fromJsonString(e,t){return(new F).fromJsonString(e,t)}static equals(e,t){return f.C.util.equals(F,e,t)}}class D extends p.Q{content=new Uint8Array(0);constructor(e){super(),f.C.util.initPartial(e,this)}static runtime=f.C;static typeName="agent.v1.ReadBinaryFileResponse";static fields=f.C.util.newFieldList((()=>[{no:1,name:"content",kind:"scalar",T:12}]));static fromBinary(e,t){return(new D).fromBinary(e,t)}static fromJson(e,t){return(new D).fromJson(e,t)}static fromJsonString(e,t){return(new D).fromJsonString(e,t)}static equals(e,t){return f.C.util.equals(D,e,t)}}class R extends p.Q{path="";content=new Uint8Array(0);constructor(e){super(),f.C.util.initPartial(e,this)}static runtime=f.C;static typeName="agent.v1.WriteBinaryFileRequest";static fields=f.C.util.newFieldList((()=>[{no:1,name:"path",kind:"scalar",T:9},{no:2,name:"content",kind:"scalar",T:12}]));static fromBinary(e,t){return(new R).fromBinary(e,t)}static fromJson(e,t){return(new R).fromJson(e,t)}static fromJsonString(e,t){return(new R).fromJsonString(e,t)}static equals(e,t){return f.C.util.equals(R,e,t)}}class L extends p.Q{constructor(e){super(),f.C.util.initPartial(e,this)}static runtime=f.C;static typeName="agent.v1.WriteBinaryFileResponse";static fields=f.C.util.newFieldList((()=>[]));static fromBinary(e,t){return(new L).fromBinary(e,t)}static fromJson(e,t){return(new L).fromJson(e,t)}static fromJsonString(e,t){return(new L).fromJsonString(e,t)}static equals(e,t){return f.C.util.equals(L,e,t)}}class N extends p.Q{rootPath="";baseRef="";constructor(e){super(),f.C.util.initPartial(e,this)}static runtime=f.C;static typeName="agent.v1.GetWorkspaceChangesHashRequest";static fields=f.C.util.newFieldList((()=>[{no:1,name:"root_path",kind:"scalar",T:9},{no:2,name:"base_ref",kind:"scalar",T:9}]));static fromBinary(e,t){return(new N).fromBinary(e,t)}static fromJson(e,t){return(new N).fromJson(e,t)}static fromJsonString(e,t){return(new N).fromJsonString(e,t)}static equals(e,t){return f.C.util.equals(N,e,t)}}class U extends p.Q{hash="";constructor(e){super(),f.C.util.initPartial(e,this)}static runtime=f.C;static typeName="agent.v1.GetWorkspaceChangesHashResponse";static fields=f.C.util.newFieldList((()=>[{no:1,name:"hash",kind:"scalar",T:9}]));static fromBinary(e,t){return(new U).fromBinary(e,t)}static fromJson(e,t){return(new U).fromJson(e,t)}static fromJsonString(e,t){return(new U).fromJsonString(e,t)}static equals(e,t){return f.C.util.equals(U,e,t)}}class O extends p.Q{githubAccessToken="";hostname="";constructor(e){super(),f.C.util.initPartial(e,this)}static runtime=f.C;static typeName="agent.v1.RefreshGithubAccessTokenRequest";static fields=f.C.util.newFieldList((()=>[{no:1,name:"github_access_token",kind:"scalar",T:9},{no:2,name:"hostname",kind:"scalar",T:9}]));static fromBinary(e,t){return(new O).fromBinary(e,t)}static fromJson(e,t){return(new O).fromJson(e,t)}static fromJsonString(e,t){return(new O).fromJsonString(e,t)}static equals(e,t){return f.C.util.equals(O,e,t)}}class $ extends p.Q{constructor(e){super(),f.C.util.initPartial(e,this)}static runtime=f.C;static typeName="agent.v1.RefreshGithubAccessTokenResponse";static fields=f.C.util.newFieldList((()=>[]));static fromBinary(e,t){return(new $).fromBinary(e,t)}static fromJson(e,t){return(new $).fromJson(e,t)}static fromJsonString(e,t){return(new $).fromJsonString(e,t)}static equals(e,t){return f.C.util.equals($,e,t)}}class M extends p.Q{commit="";port=0;connectionToken="";constructor(e){super(),f.C.util.initPartial(e,this)}static runtime=f.C;static typeName="agent.v1.WarmRemoteAccessServerRequest";static fields=f.C.util.newFieldList((()=>[{no:1,name:"commit",kind:"scalar",T:9},{no:2,name:"port",kind:"scalar",T:5},{no:3,name:"connection_token",kind:"scalar",T:9}]));static fromBinary(e,t){return(new M).fromBinary(e,t)}static fromJson(e,t){return(new M).fromJson(e,t)}static fromJsonString(e,t){return(new M).fromJsonString(e,t)}static equals(e,t){return f.C.util.equals(M,e,t)}}class B extends p.Q{constructor(e){super(),f.C.util.initPartial(e,this)}static runtime=f.C;static typeName="agent.v1.WarmRemoteAccessServerResponse";static fields=f.C.util.newFieldList((()=>[]));static fromBinary(e,t){return(new B).fromBinary(e,t)}static fromJson(e,t){return(new B).fromJson(e,t)}static fromJsonString(e,t){return(new B).fromJsonString(e,t)}static equals(e,t){return f.C.util.equals(B,e,t)}}class J extends p.Q{extraPaths=[];constructor(e){super(),f.C.util.initPartial(e,this)}static runtime=f.C;static typeName="agent.v1.ListArtifactsRequest";static fields=f.C.util.newFieldList((()=>[{no:1,name:"extra_paths",kind:"scalar",T:9,repeated:!0}]));static fromBinary(e,t){return(new J).fromBinary(e,t)}static fromJson(e,t){return(new J).fromJson(e,t)}static fromJsonString(e,t){return(new J).fromJsonString(e,t)}static equals(e,t){return f.C.util.equals(J,e,t)}}class G extends p.Q{absolutePath="";sizeBytes=g.M.zero;updatedAtUnixMs=g.M.zero;status=s.UNSPECIFIED;bytesUploaded=g.M.zero;lastError="";uploadAttempts=0;lastStartedAtUnixMs=g.M.zero;lastFinishedAtUnixMs=g.M.zero;uploadId="";constructor(e){super(),f.C.util.initPartial(e,this)}static runtime=f.C;static typeName="agent.v1.ArtifactUploadMetadata";static fields=f.C.util.newFieldList((()=>[{no:1,name:"absolute_path",kind:"scalar",T:9},{no:2,name:"size_bytes",kind:"scalar",T:4},{no:3,name:"updated_at_unix_ms",kind:"scalar",T:3},{no:4,name:"status",kind:"enum",T:f.C.getEnumType(s)},{no:5,name:"bytes_uploaded",kind:"scalar",T:4},{no:6,name:"last_error",kind:"scalar",T:9},{no:7,name:"upload_attempts",kind:"scalar",T:13},{no:8,name:"last_started_at_unix_ms",kind:"scalar",T:3},{no:9,name:"last_finished_at_unix_ms",kind:"scalar",T:3},{no:10,name:"upload_id",kind:"scalar",T:9}]));static fromBinary(e,t){return(new G).fromBinary(e,t)}static fromJson(e,t){return(new G).fromJson(e,t)}static fromJsonString(e,t){return(new G).fromJsonString(e,t)}static equals(e,t){return f.C.util.equals(G,e,t)}}class q extends p.Q{kind=i.UNSPECIFIED;code="";message="";constructor(e){super(),f.C.util.initPartial(e,this)}static runtime=f.C;static typeName="agent.v1.ArtifactPathError";static fields=f.C.util.newFieldList((()=>[{no:1,name:"kind",kind:"enum",T:f.C.getEnumType(i)},{no:2,name:"code",kind:"scalar",T:9},{no:3,name:"message",kind:"scalar",T:9}]));static fromBinary(e,t){return(new q).fromBinary(e,t)}static fromJson(e,t){return(new q).fromJson(e,t)}static fromJsonString(e,t){return(new q).fromJsonString(e,t)}static equals(e,t){return f.C.util.equals(q,e,t)}}class j extends p.Q{artifacts=[];pathErrors={};constructor(e){super(),f.C.util.initPartial(e,this)}static runtime=f.C;static typeName="agent.v1.ListArtifactsResponse";static fields=f.C.util.newFieldList((()=>[{no:1,name:"artifacts",kind:"message",T:G,repeated:!0},{no:2,name:"path_errors",kind:"map",K:9,V:{kind:"message",T:q}}]));static fromBinary(e,t){return(new j).fromBinary(e,t)}static fromJson(e,t){return(new j).fromJson(e,t)}static fromJsonString(e,t){return(new j).fromJsonString(e,t)}static equals(e,t){return f.C.util.equals(j,e,t)}}class H extends p.Q{uploads=[];constructor(e){super(),f.C.util.initPartial(e,this)}static runtime=f.C;static typeName="agent.v1.UploadArtifactsRequest";static fields=f.C.util.newFieldList((()=>[{no:1,name:"uploads",kind:"message",T:W,repeated:!0}]));static fromBinary(e,t){return(new H).fromBinary(e,t)}static fromJson(e,t){return(new H).fromJson(e,t)}static fromJsonString(e,t){return(new H).fromJsonString(e,t)}static equals(e,t){return f.C.util.equals(H,e,t)}}class W extends p.Q{absolutePath="";uploadUrl="";method="";headers={};contentType;slackUploadUrl;slackFileId;constructor(e){super(),f.C.util.initPartial(e,this)}static runtime=f.C;static typeName="agent.v1.ArtifactUploadInstruction";static fields=f.C.util.newFieldList((()=>[{no:1,name:"absolute_path",kind:"scalar",T:9},{no:2,name:"upload_url",kind:"scalar",T:9},{no:3,name:"method",kind:"scalar",T:9},{no:4,name:"headers",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:5,name:"content_type",kind:"scalar",T:9,opt:!0},{no:6,name:"slack_upload_url",kind:"scalar",T:9,opt:!0},{no:7,name:"slack_file_id",kind:"scalar",T:9,opt:!0}]));static fromBinary(e,t){return(new W).fromBinary(e,t)}static fromJson(e,t){return(new W).fromJson(e,t)}static fromJsonString(e,t){return(new W).fromJsonString(e,t)}static equals(e,t){return f.C.util.equals(W,e,t)}}class z extends p.Q{absolutePath="";status=o.UNSPECIFIED;message="";slackFileId;constructor(e){super(),f.C.util.initPartial(e,this)}static runtime=f.C;static typeName="agent.v1.ArtifactUploadDispatchResult";static fields=f.C.util.newFieldList((()=>[{no:1,name:"absolute_path",kind:"scalar",T:9},{no:2,name:"status",kind:"enum",T:f.C.getEnumType(o)},{no:3,name:"message",kind:"scalar",T:9},{no:4,name:"slack_file_id",kind:"scalar",T:9,opt:!0}]));static fromBinary(e,t){return(new z).fromBinary(e,t)}static fromJson(e,t){return(new z).fromJson(e,t)}static fromJsonString(e,t){return(new z).fromJsonString(e,t)}static equals(e,t){return f.C.util.equals(z,e,t)}}class Q extends p.Q{results=[];constructor(e){super(),f.C.util.initPartial(e,this)}static runtime=f.C;static typeName="agent.v1.UploadArtifactsResponse";static fields=f.C.util.newFieldList((()=>[{no:1,name:"results",kind:"message",T:z,repeated:!0}]));static fromBinary(e,t){return(new Q).fromBinary(e,t)}static fromJson(e,t){return(new Q).fromJson(e,t)}static fromJsonString(e,t){return(new Q).fromJsonString(e,t)}static equals(e,t){return f.C.util.equals(Q,e,t)}}class Y extends p.Q{constructor(e){super(),f.C.util.initPartial(e,this)}static runtime=f.C;static typeName="agent.v1.GetMcpRefreshTokensRequest";static fields=f.C.util.newFieldList((()=>[]));static fromBinary(e,t){return(new Y).fromBinary(e,t)}static fromJson(e,t){return(new Y).fromJson(e,t)}static fromJsonString(e,t){return(new Y).fromJsonString(e,t)}static equals(e,t){return f.C.util.equals(Y,e,t)}}class K extends p.Q{refreshTokens={};constructor(e){super(),f.C.util.initPartial(e,this)}static runtime=f.C;static typeName="agent.v1.GetMcpRefreshTokensResponse";static fields=f.C.util.newFieldList((()=>[{no:1,name:"refresh_tokens",kind:"map",K:9,V:{kind:"scalar",T:9}}]));static fromBinary(e,t){return(new K).fromBinary(e,t)}static fromJson(e,t){return(new K).fromJson(e,t)}static fromJsonString(e,t){return(new K).fromJsonString(e,t)}static equals(e,t){return f.C.util.equals(K,e,t)}}class V extends p.Q{env={};replace=!1;constructor(e){super(),f.C.util.initPartial(e,this)}static runtime=f.C;static typeName="agent.v1.UpdateEnvironmentVariablesRequest";static fields=f.C.util.newFieldList((()=>[{no:1,name:"env",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:2,name:"replace",kind:"scalar",T:8}]));static fromBinary(e,t){return(new V).fromBinary(e,t)}static fromJson(e,t){return(new V).fromJson(e,t)}static fromJsonString(e,t){return(new V).fromJsonString(e,t)}static equals(e,t){return f.C.util.equals(V,e,t)}}class X extends p.Q{applied=0;removed=0;constructor(e){super(),f.C.util.initPartial(e,this)}static runtime=f.C;static typeName="agent.v1.UpdateEnvironmentVariablesResponse";static fields=f.C.util.newFieldList((()=>[{no:1,name:"applied",kind:"scalar",T:13},{no:2,name:"removed",kind:"scalar",T:13}]));static fromBinary(e,t){return(new X).fromBinary(e,t)}static fromJson(e,t){return(new X).fromJson(e,t)}static fromJsonString(e,t){return(new X).fromJsonString(e,t)}static equals(e,t){return f.C.util.equals(X,e,t)}}const Z=(0,c.h)("exec-daemon-artifacts");class ee{artifactsDir;stateFilePath;stateLoaded=!1;state={};inFlightUploads=new Map;isPersistingState=!1;pendingPersistPayload=null;constructor(e,t="/opt/cursor/artifacts"){Z.info(e,"Artifacts: setting up artifact upload manager",{artifactsRootPath:t}),this.artifactsDir=h.resolve(t),this.stateFilePath=h.join(this.artifactsDir,".cursor","exec-daemon-artifacts.json")}async listArtifacts(e){return Z.info(e,"Artifacts: Listing artifacts"),(await this.readArtifactsFromDisk(e)).map((e=>{const t=this.state[e.absolutePath];return new G({absolutePath:e.absolutePath,sizeBytes:BigInt(e.sizeBytes),updatedAtUnixMs:BigInt(e.updatedAtUnixMs),status:t?.status??s.NOT_STARTED,bytesUploaded:BigInt(t?.bytesUploaded??0),lastError:t?.lastError??"",uploadAttempts:t?.uploadAttempts??0,lastStartedAtUnixMs:BigInt(t?.lastStartedAtUnixMs??0),lastFinishedAtUnixMs:BigInt(t?.lastFinishedAtUnixMs??0),uploadId:t?.uploadId??""})}))}async uploadArtifacts(e,t){const n=t.some((e=>e.slackUploadUrl));Z.info(e,"Artifacts: starting artifact uploads",{absolutePaths:t.map((e=>e.absolutePath)),hasSlackUploads:n});const r=t.map((async t=>{const n=this.sanitizeAbsolutePath(t.absolutePath),r=new z({absolutePath:n,status:o.UNSPECIFIED,message:"",slackFileId:t.slackFileId});try{const s=await this.safeStat(n);if(!s?.isFile())return r.status=o.REJECTED,r.message="File not found or not a file",r;if(this.inFlightUploads.has(n))return r.status=o.SKIPPED_ALREADY_IN_PROGRESS,r.message="Upload already in progress",r;const i=this.performUpload(e,n,s.size,t).finally((()=>{this.inFlightUploads.delete(n)}));return this.inFlightUploads.set(n,i),r.status=o.ACCEPTED,r}catch(e){const t=e instanceof Error?e:new Error(String(e));return r.status=o.REJECTED,r.message=t.message,r}})),s=await Promise.all(r);if(n){const t=Array.from(this.inFlightUploads.values());t.length>0&&(Z.info(e,"Artifacts: Waiting for Slack uploads to complete",{count:t.length}),await Promise.allSettled(t),Z.info(e,"Artifacts: All uploads completed"))}const i=s.filter((e=>e.status===o.REJECTED));return i.length>0&&Z.error(e,`Artifacts: Failed to dispatch ${i.length} artifact upload(s)`,new Error(`Multiple upload dispatch failures: ${i.map((e=>`${e.absolutePath}: ${e.message}`)).join("; ")}`),{errors:i.map((e=>({absolutePath:e.absolutePath,message:e.message})))}),Z.info(e,"Artifacts: finished uploading artifacts",{results:s}),new Q({results:s})}async performUpload(e,t,n,r){const i=(0,l.randomUUID)();Z.info(e,"Starting artifact upload",{absolutePath:t,uploadId:i,hasSlackUpload:Boolean(r.slackUploadUrl)}),await this.updateState(t,{status:s.IN_PROGRESS,bytesUploaded:0,uploadAttempts:(this.state[t]?.uploadAttempts??0)+1,lastError:"",lastStartedAtUnixMs:Date.now(),uploadId:i});const o=this.uploadToS3(e,t,n,r),a=r.slackUploadUrl?this.uploadToSlack(e,t,r).catch((n=>{const s=n instanceof Error?n.message:String(n);Z.warn(e,"Artifacts: Slack upload failed (non-critical)",{absolutePath:t,uploadId:i,slackFileId:r.slackFileId,error:s})})):Promise.resolve();try{await o,await this.updateState(t,{status:s.COMPLETED,bytesUploaded:n,uploadAttempts:this.state[t]?.uploadAttempts??1,lastStartedAtUnixMs:this.state[t]?.lastStartedAtUnixMs??0,lastFinishedAtUnixMs:Date.now(),lastError:"",uploadId:i}),Z.info(e,"Artifacts: Artifact upload complete",{absolutePath:t,uploadId:i,sizeBytes:n,hadSlackUpload:Boolean(r.slackUploadUrl)})}catch(n){const r=n instanceof Error?n.message:String(n);Z.error(e,"Artifact upload failed",n,{absolutePath:t,uploadId:i}),await this.updateState(t,{status:s.FAILED,bytesUploaded:0,uploadAttempts:this.state[t]?.uploadAttempts??1,lastStartedAtUnixMs:this.state[t]?.lastStartedAtUnixMs??0,lastFinishedAtUnixMs:Date.now(),lastError:r,uploadId:i})}await a}async uploadToS3(e,t,n,r){const s=new Headers;if(r.headers)for(const[e,t]of Object.entries(r.headers))s.set(e,t);r.contentType&&!s.has("content-type")&&s.set("content-type",r.contentType),s.has("content-length")||s.set("content-length",String(n));const i=m.Readable.toWeb((0,d.createReadStream)(t)),o=await fetch(r.uploadUrl,{method:r.method||"PUT",headers:s,body:i,duplex:"half"});if(!o.ok)throw new Error(`S3 upload failed with status ${o.status} ${o.statusText}`);Z.info(e,"Artifacts: S3 upload complete",{absolutePath:t})}async uploadToSlack(e,t,n){if(!n.slackUploadUrl)return;Z.info(e,"Artifacts: Starting Slack upload",{absolutePath:t,slackFileId:n.slackFileId});const r=m.Readable.toWeb((0,d.createReadStream)(t)),s=await fetch(n.slackUploadUrl,{method:"POST",body:r,duplex:"half"});if(!s.ok)throw new Error(`Slack upload failed with status ${s.status} ${s.statusText}`);Z.info(e,"Artifacts: Slack upload complete",{absolutePath:t,slackFileId:n.slackFileId})}async readArtifactsFromDisk(e){const t=[];return await this.directoryExists(this.artifactsDir)?(await this.walkArtifacts(e,"",t),Z.info(e,"Artifacts: Walked artifacts",{entries:t}),t):t}async walkArtifacts(e,t,n){Z.info(e,`Artifacts: Walking artifacts in directory: ${t}`);const r=h.join(this.artifactsDir,t),s=await u.readdir(r,{withFileTypes:!0});for(const i of s){const s=h.posix.join(t,i.name),o=h.join(r,i.name);if(i.isDirectory())await this.walkArtifacts(e,s,n);else if(i.isFile()){if(o===this.stateFilePath)continue;const e=await u.stat(o);n.push({absolutePath:o,sizeBytes:e.size,updatedAtUnixMs:Math.trunc(e.mtimeMs)})}}}sanitizeAbsolutePath(e){return h.posix.normalize(e.replace(/\\/g,"/"))}async initialize(e){this.stateLoaded||(Z.info(e,"Artifacts: initializing fresh artifact upload state",{stateFilePath:this.stateFilePath}),this.state={},await this.persistState(),this.stateLoaded=!0)}async updateState(e,t){this.state[e]={...this.state[e],...t},await this.persistState()}async persistState(){const e={version:1,artifacts:{...this.state}};if(this.pendingPersistPayload=e,!this.isPersistingState){this.isPersistingState=!0;try{for(;null!==this.pendingPersistPayload;){const e=this.pendingPersistPayload;this.pendingPersistPayload=null;const t=h.dirname(this.stateFilePath);await u.mkdir(t,{recursive:!0}),await u.writeFile(this.stateFilePath,JSON.stringify(e,null,2),"utf8")}}finally{this.isPersistingState=!1}}}async directoryExists(e){try{return(await u.stat(e)).isDirectory()}catch(e){if("ENOENT"===e.code)return!1;throw e}}async safeStat(e){try{return await u.stat(e)}catch(e){if("ENOENT"===e.code)return null;throw e}}}var te=n("../proto/dist/generated/aiserver/v1/utils_pb.js"),ne=n("../utils/dist/index.js"),re=n("../../node_modules/.pnpm/@connectrpc+connect@1.6.1_patch_hash=a4b9a5e69295313832387f25b708426bcf53041a2f50bc7b95_a276813e7efa8e1efb8a7b0efc1d56a0/node_modules/@connectrpc/connect/dist/esm/connect-error.js"),se=n("../../node_modules/.pnpm/@connectrpc+connect@1.6.1_patch_hash=a4b9a5e69295313832387f25b708426bcf53041a2f50bc7b95_a276813e7efa8e1efb8a7b0efc1d56a0/node_modules/@connectrpc/connect/dist/esm/code.js");function ie(e){if(!(e instanceof Error))return!1;const t=e.code;return"ERR_STREAM_DESTROYED"===t||"ERR_STREAM_PREMATURE_CLOSE"===t||"ECONNRESET"===t||"EPIPE"===t}p.Q,f.C,f.C.util.newFieldList((()=>[{no:1,name:"refresh_token",kind:"scalar",T:9,opt:!0},{no:2,name:"client_id",kind:"scalar",T:9},{no:3,name:"client_secret",kind:"scalar",T:9,opt:!0},{no:4,name:"redirect_uris",kind:"scalar",T:9,repeated:!0},{no:5,name:"access_token",kind:"scalar",T:9,opt:!0}])),p.Q,f.C,f.C.util.newFieldList((()=>[{no:1,name:"client_id",kind:"scalar",T:9},{no:2,name:"client_secret",kind:"scalar",T:9,opt:!0},{no:3,name:"redirect_uris",kind:"scalar",T:9,repeated:!0}]));class oe extends p.Q{name="";description="";icon="";endpoint="";isFeatured=!1;constructor(e){super(),f.C.util.initPartial(e,this)}static runtime=f.C;static typeName="aiserver.v1.MCPKnownServerInfo";static fields=f.C.util.newFieldList((()=>[{no:1,name:"name",kind:"scalar",T:9},{no:2,name:"description",kind:"scalar",T:9},{no:3,name:"icon",kind:"scalar",T:9},{no:4,name:"endpoint",kind:"scalar",T:9},{no:5,name:"is_featured",kind:"scalar",T:8}]));static fromBinary(e,t){return(new oe).fromBinary(e,t)}static fromJson(e,t){return(new oe).fromJson(e,t)}static fromJsonString(e,t){return(new oe).fromJsonString(e,t)}static equals(e,t){return f.C.util.equals(oe,e,t)}}class ae extends p.Q{domains=[];info;constructor(e){super(),f.C.util.initPartial(e,this)}static runtime=f.C;static typeName="aiserver.v1.MCPServerRegistration";static fields=f.C.util.newFieldList((()=>[{no:1,name:"domains",kind:"scalar",T:9,repeated:!0},{no:2,name:"info",kind:"message",T:oe}]));static fromBinary(e,t){return(new ae).fromBinary(e,t)}static fromJson(e,t){return(new ae).fromJson(e,t)}static fromJsonString(e,t){return(new ae).fromJsonString(e,t)}static equals(e,t){return f.C.util.equals(ae,e,t)}}p.Q,f.C,f.C.util.newFieldList((()=>[])),p.Q,f.C,f.C.util.newFieldList((()=>[{no:1,name:"servers",kind:"message",T:ae,repeated:!0}]));const ce={},le=(0,c.h)("exec-daemon"),de=(0,c.h)("filesystem");function ue(e,t){const n=t instanceof Error?t.message:String(t),r=t instanceof Error?t.stack:void 0,s=`${e}: ${n}${r?`\n\nStack trace:\n${r}`:""}`;return new re.T(s,se.C.Internal,void 0,void 0,t)}function he(e,t,n){if(n instanceof re.T)de.error(e,`${t} failed`,new Error("ConnectError"),{connectCode:n.code});else if(n instanceof Error&&"code"in n){const r=n;de.error(e,`${t} failed`,new Error("FsError"),{fsCode:r.code})}else de.error(e,`${t} failed`,new Error("UnknownError"))}class me{gitService;remoteAccessService;artifactUploadManager;managedEnvKeys=new Set;constructor(e,t,n){this.gitService=e,this.remoteAccessService=t,this.artifactUploadManager=n}async ping(e,t){return le.debug(e,"Ping"),new y({})}async*exec(e,t){const n=(0,c.fR)(e.withName("exec_daemon.exec")),r=(0,c.fU)(n);try{le.debug(n,"Running command",{command:t.command,args:t.args,cwd:t.cwd});const e=(0,ne.Jt)(),s=(0,a.spawn)(t.command,t.args,{env:{...process.env,...t.environment},stdio:["pipe","pipe","pipe"],cwd:t.cwd});s.stdout?.on("data",(async t=>{const n=new E({data:t.toString()}),r=new b({event:{case:"stdoutEvent",value:n}});await e.write(r)})),s.stderr?.on("data",(async t=>{const n=new C({data:t.toString()}),r=new b({event:{case:"stderrEvent",value:n}});await e.write(r)})),s.on("close",(async t=>{r?.setAttribute("exec.exit_code",t??0),r?.end();const n=new S({exitCode:t??0}),s=new b({event:{case:"exitEvent",value:n}});await e.write(s),e.close()})),s.on("error",(t=>{le.error(n,"Process spawn error",t),r?.recordException(t),r?.end(),e.throw(t)})),yield*e}catch(t){if(ie(t))return le.debug(e,"Client disconnected during streaming",{code:t.code}),void r?.end();throw le.error(n,"Exec request failed",t),r?.recordException(t),r?.end(),t}}async listDirectory(e,t){const n=t.path||"",s=t.includeHidden;try{const e=0===n.length?".":n,t=await(0,u.readdir)(e,{withFileTypes:!0}),i=[],o=t.filter((e=>!!s||!e.name.startsWith("."))),a=64;for(let t=0;t<o.length;t+=a){const n=o.slice(t,t+a),s=await Promise.all(n.map((async t=>{const n=h.resolve(e,t.name);let s;s=t.isSymbolicLink()?r.SYMLINK:t.isDirectory()?r.DIRECTORY:r.FILE;try{const e=await(0,u.lstat)(n);return new T({name:t.name,path:n,type:s,sizeBytes:BigInt(e.size),modifiedAtUnixMs:BigInt(Math.trunc(e.mtimeMs))})}catch(e){if(e instanceof Error&&"code"in e&&"ENOENT"===e.code)return null;throw e}})));for(const e of s)e&&i.push(e)}return i.sort(((e,t)=>{const n=e.type===r.DIRECTORY,s=t.type===r.DIRECTORY;return n&&!s?-1:!n&&s?1:e.name.localeCompare(t.name)})),new x({entries:i})}catch(t){throw he(e,"ListDirectory",t),function(e,t){if(e instanceof re.T)return e;if(e instanceof Error&&"code"in e)switch(e.code){case"ENOENT":return new re.T(`${t}: not found`,se.C.NotFound);case"EACCES":case"EPERM":return new re.T(`${t}: permission denied`,se.C.PermissionDenied);case"ENOTDIR":return new re.T(`${t}: not a directory`,se.C.InvalidArgument);case"EISDIR":return new re.T(`${t}: is a directory`,se.C.InvalidArgument);case"ELOOP":case"ENAMETOOLONG":return new re.T(`${t}: invalid path`,se.C.InvalidArgument);default:return new re.T(`${t} failed`,se.C.Internal)}return new re.T(`${t} failed`,se.C.Internal)}(t,"ListDirectory")}}async readTextFile(e,t){const n=(0,c.fR)(e.withName("exec_daemon.readTextFile")),r=(0,c.fU)(n);r?.setAttribute("file.path",t.path);try{le.debug(n,"Reading file",{path:t.path});const e=await(0,u.readFile)(t.path,"utf8");r?.setAttribute("file.size",e.length);const s=new _;return s.content=e,r?.end(),s}catch(e){if(le.error(n,"Read file failed",e,{path:t.path}),r?.recordException(e),r?.end(),e instanceof Error&&"code"in e){const t=e;if("ENOENT"===t.code)throw new re.T("File not found",se.C.NotFound);if("EACCES"===t.code)throw new re.T("Permission denied",se.C.PermissionDenied);if("EISDIR"===t.code)throw new re.T("Path is a directory",se.C.InvalidArgument)}throw ue("Failed to read file",e)}}async writeTextFile(e,t){const n=(0,c.fR)(e.withName("exec_daemon.writeTextFile")),r=(0,c.fU)(n);try{return le.debug(n,"Writing file",{path:t.path}),await(0,u.writeFile)(t.path,t.content,"utf8"),r?.end(),new A}catch(e){if(le.error(n,"Write file failed",e,{path:t.path}),r?.recordException(e),r?.end(),e instanceof Error&&"code"in e){const t=e;if("ENOENT"===t.code)throw new re.T("Directory not found",se.C.NotFound);if("EACCES"===t.code)throw new re.T("Permission denied",se.C.PermissionDenied);if("EISDIR"===t.code)throw new re.T("Path is a directory",se.C.InvalidArgument)}throw ue("Failed to write file",e)}}async readBinaryFile(e,t){try{le.debug(e,"Reading binary file",{path:t.path});const n=await(0,u.readFile)(t.path),r=new D;return r.content=new Uint8Array(n),r}catch(n){if(le.error(e,"Read binary file failed",n,{path:t.path}),n instanceof Error&&"code"in n){const e=n;if("ENOENT"===e.code)throw new re.T("File not found",se.C.NotFound);if("EACCES"===e.code)throw new re.T("Permission denied",se.C.PermissionDenied);if("EISDIR"===e.code)throw new re.T("Path is a directory",se.C.InvalidArgument)}throw ue("Failed to read binary file",n)}}async writeBinaryFile(e,t){try{return le.debug(e,"Writing binary file",{path:t.path}),await(0,u.writeFile)(t.path,t.content),new L}catch(n){if(le.error(e,"Write binary file failed",n,{path:t.path}),n instanceof Error&&"code"in n){const e=n;if("ENOENT"===e.code)throw new re.T("Directory not found",se.C.NotFound);if("EACCES"===e.code)throw new re.T("Permission denied",se.C.PermissionDenied);if("EISDIR"===e.code)throw new re.T("Path is a directory",se.C.InvalidArgument)}throw ue("Failed to write binary file",n)}}async getDiff(e,t){const n=(0,c.fR)(e.withName("exec_daemon.getDiff")),r=(0,c.fU)(n);r?.setAttribute("git.cwd",t.cwd),r?.setAttribute("git.base_ref",t.baseRef),r?.setAttribute("git.ref",t.ref);try{le.debug(n,"Getting git diff",{cwd:t.cwd,baseRef:t.baseRef,ref:t.ref});const e={ref:t.ref,baseRef:t.baseRef,mergeBase:t.mergeBase,targetPaths:t.targetPaths,unifiedContextLines:t.unifiedContextLines??3,maxUntrackedFiles:t.maxUntrackedFiles,submoduleRecurseDepth:t.submoduleRecurseDepth,includeSpaceChanges:t.includeSpaceChanges,outputFormat:t.outputFormat??te.ek.FILE_DIFFS},s=await this.gitService.getDiff(t.cwd,e);return r?.end(),s}catch(e){throw le.error(n,"Get diff failed",e,{request:t}),r?.recordException(e),r?.end(),ue("Failed to get diff",e)}}async getWorkspaceChangesHash(e,t){try{le.debug(e,"Getting workspace changes hash",{rootPath:t.rootPath,baseRef:t.baseRef});const n=await this.gitService.getWorkspaceChangesHash(t.rootPath,t.baseRef);return new U({hash:n})}catch(n){throw le.error(e,"Get workspace changes hash failed",n,{request:t}),ue("Failed to get workspace changes hash",n)}}async refreshGithubAccessToken(e,t){try{return await this.gitService.refreshGithubAccessToken(t.githubAccessToken,t.hostname),new $}catch(e){throw new re.T("Failed to refresh access token",se.C.Internal)}}async warmRemoteAccessServer(e,t){try{return await this.remoteAccessService.warmCursorServer(e,t.commit,t.port,t.connectionToken),new B}catch(e){throw ue("Failed to warm remote access server",e)}}async listArtifacts(e,t){try{const n=await this.artifactUploadManager.listArtifacts(e),r=t.extraPaths??[];if(0===r.length)return new j({artifacts:n});const o=new Set(n.map((e=>h.posix.normalize(e.absolutePath.replace(/\\/g,"/"))))),a=new Set(o),c=[],l={};for(const t of r){const n=h.posix.normalize(t.replace(/\\/g,"/"));if(!a.has(n))if(a.add(n),n.startsWith("/")&&!n.startsWith("//"))try{const e=await(0,u.lstat)(n);if(!e.isFile()){l[n]=new q({kind:i.NOT_A_FILE,code:"NOT_A_FILE",message:"Path is not a file"});continue}c.push(new G({absolutePath:n,sizeBytes:BigInt(e.size),updatedAtUnixMs:BigInt(Math.trunc(e.mtimeMs)),status:s.NOT_STARTED,bytesUploaded:BigInt(0),lastError:"",uploadAttempts:0,lastStartedAtUnixMs:BigInt(0),lastFinishedAtUnixMs:BigInt(0),uploadId:""}))}catch(t){if(t instanceof Error&&"code"in t){const e=t;switch(e.code){case"ENOENT":l[n]=new q({kind:i.MISSING,code:e.code,message:e.message});continue;case"EACCES":case"EPERM":l[n]=new q({kind:i.PERMISSION,code:e.code,message:e.message});continue;case"ENOTDIR":case"EISDIR":l[n]=new q({kind:i.NOT_A_FILE,code:e.code,message:e.message});continue}}he(e,"listArtifacts extra path stat",t);const r=t instanceof Error?t:new Error(String(t));l[n]=new q({kind:i.UNKNOWN,code:"UNKNOWN",message:r.message})}else l[n]=new q({kind:i.INVALID_PATH,code:"INVALID_PATH",message:"Path must be absolute"})}return new j({artifacts:[...n,...c],pathErrors:l})}catch(t){throw le.error(e,"Failed to list artifacts",t),ue("Failed to list artifacts",t)}}async uploadArtifacts(e,t){try{return await this.artifactUploadManager.uploadArtifacts(e,t.uploads)}catch(t){throw le.error(e,"Failed to start artifact uploads",t),ue("Failed to start artifact uploads",t)}}async getMcpRefreshTokens(e,t){try{const e=function(){const e={...ce};for(const e of Object.keys(ce))delete ce[e];return e}(),t={};for(const[n,r]of Object.entries(e))t[n]=r.refreshToken;return new K({refreshTokens:t})}catch(t){throw le.error(e,"Failed to get MCP OAuth tokens",t),ue("Failed to get MCP OAuth tokens",t)}}async updateEnvironmentVariables(e,t){const n=t.env,r=!0===t.replace,s=new Set;for(const e of Object.keys(n))s.add(e);let i=0;if(r){for(const e of this.managedEnvKeys)s.has(e)||(delete process.env[e],i+=1);this.managedEnvKeys=s}else for(const e of s)this.managedEnvKeys.add(e);let o=0;for(const[e,t]of Object.entries(n))process.env[e]=t,o+=1;return le.info(e,"Updated exec-daemon environment",{requested:Object.keys(n).length,applied:o,removed:i,replace:r}),new X({applied:o,removed:i})}}var fe=n("../agent-exec/dist/index.js"),pe=n("../proto/dist/generated/agent/v1/exec_pb.js");class ge extends p.Q{element={case:void 0};constructor(e){super(),f.C.util.initPartial(e,this)}static runtime=f.C;static typeName="agent.v1.ExecStreamElement";static fields=f.C.util.newFieldList((()=>[{no:1,name:"exec_client_message",kind:"message",T:pe.yT,oneof:"element"},{no:2,name:"exec_client_control_message",kind:"message",T:pe.$Y,oneof:"element"}]));static fromBinary(e,t){return(new ge).fromBinary(e,t)}static fromJson(e,t){return(new ge).fromJson(e,t)}static fromJsonString(e,t){return(new ge).fromJsonString(e,t)}static equals(e,t){return f.C.util.equals(ge,e,t)}}const we=(0,c.h)("exec-daemon");class ye{controlledExecManager;constructor(e,t){this.controlledExecManager=fe.n6.fromResources(t)}async*exec(e,t){try{const n=this.controlledExecManager.handle(e,t);for await(const e of n)e instanceof pe.yT?yield new ge({element:{case:"execClientMessage",value:e}}):e instanceof pe.$Y&&(yield new ge({element:{case:"execClientControlMessage",value:e}}))}catch(t){if(ie(t))return void we.debug(e,"Client disconnected during streaming",{code:t.code});throw we.error(e,"Request failed",t),t}}}var ve=n("node:os"),be=n("node:util");const Ee=/(a|i|w|c|o|1|2)\/.*(?=["']? ["']?(b|i|w|c|o|1|2)\/)|(b|i|w|c|o|1|2)\/.*$/g,Ce=/^(a|b|i|w|c|o|1|2)\//,Se=e=>{const t=e?.match(Ee);return t?.map((e=>e.replace(Ce,"").replace(/("|')$/,"")))},ke=/^\\?['"]|\\?['"]$/g,xe=e=>{let t=Te(e,"-+").trim();return t=_e(t),t.replace(ke,"").replace(Ce,"")},Te=(e,t)=>{if(e=Ae(e),!t&&String.prototype.trimLeft)return e.trimLeft();const n=Ie(t);return e.replace(new RegExp(`^${n}+`),"")},Pe=/\t.*|\d{4}-\d\d-\d\d\s\d\d:\d\d:\d\d(.\d+)?\s(\+|-)\d\d\d\d/,_e=e=>{const t=Pe.exec(e);return t&&(e=e.substring(0,t.index).trim()),e},Ie=e=>null==e?"\\s":e instanceof RegExp?e.source:`[${Ae(e).replace(/([.*+?^=!:${}()|[\]/\\])/g,"\\$1")}]`,Ae=e=>`${e??""}`;async function Fe(e){const{repoRoot:t,filePaths:n,getContent:r}=e,s=new Map;if(0===n.length)return s;const i=await async function(e,t){const n=new Map;if(0===t.length)return n;try{const r=await new Promise(((n,r)=>{const s=(0,a.spawn)("git",["check-attr","linguist-generated","--stdin"],{cwd:e});let i="";s.stdout.on("data",(e=>{i+=e.toString()})),s.stdin.write(`${t.join("\n")}\n`),s.stdin.end(),s.on("close",(e=>{n(i)})),s.on("error",(e=>{r(e)}))}));for(const e of r.trim().split("\n")){const t=e.match(/^(.+): linguist-generated: (.+)$/);if(t){const e=t[1],r=t[2];"true"===r||"set"===r?n.set(e,!0):"false"!==r&&"unset"!==r||n.set(e,!1)}}}catch{}return n}(t,n);return await Promise.all(n.map((async e=>{const t=i.get(e);if(!0!==t)if(!1!==t)if(function(e){return new De(e).isGeneratedByPath()}(e))s.set(e,{isGenerated:!0,source:"path-heuristic"});else{if(r){const t=await r(e);if(void 0!==t&&function(e,t){return new De(e,(()=>t)).isGeneratedByContent()}(e,t))return void s.set(e,{isGenerated:!0,source:"content-heuristic"})}s.set(e,{isGenerated:!1,source:"none"})}else s.set(e,{isGenerated:!1,source:"gitattributes"});else s.set(e,{isGenerated:!0,source:"gitattributes"})}))),s}class De{name;extname;getContent;cachedLines;constructor(e,t){this.name=e,this.extname=h.extname(e).toLowerCase(),this.getContent=t}get lines(){if(void 0===this.cachedLines){const e=this.getContent?.();this.cachedLines=e?e.split("\n"):[]}return this.cachedLines}get data(){return this.getContent?.()}isGeneratedByPath(){return this.xcodeFile()||this.intellijFile()||this.cocoapods()||this.carthageBuild()||this.generatedGraphqlRelay()||this.generatedNetDesignerFile()||this.generatedNetSpecflowFeatureFile()||this.composerLock()||this.cargoLock()||this.cargoOrig()||this.denoLock()||this.flakeLock()||this.bazelLock()||this.nodeModules()||this.goVendor()||this.goLock()||this.packageResolved()||this.poetryLock()||this.pdmLock()||this.uvLock()||this.pixiLock()||this.esyLock()||this.npmShrinkwrapOrPackageLock()||this.pnpmLock()||this.bunLock()||this.terraformLock()||this.generatedYarnPlugnplay()||this.godeps()||this.generatedByZephir()||this.htmlcov()||this.gradleWrapper()||this.mavenWrapper()||this.pipenvLock()||this.generatedPascalTlb()||this.generatedSqlxQuery()||this.sourceMapByName()}isGeneratedByContent(){return!!this.getContent&&(this.minifiedFiles()||this.hasSourceMap()||this.sourceMap()||this.compiledCoffeescript()||this.generatedParser()||this.generatedNetDocfile()||this.generatedPostscript()||this.compiledCythonFile()||this.generatedGo()||this.generatedProtocolBufferFromGo()||this.generatedProtocolBuffer()||this.generatedJavascriptProtocolBuffer()||this.generatedTypescriptProtocolBuffer()||this.generatedApacheThrift()||this.generatedJniHeader()||this.vcrCassette()||this.generatedAntlr()||this.generatedModule()||this.generatedUnity3dMeta()||this.generatedRacc()||this.generatedJflex()||this.generatedGrammarkit()||this.generatedRoxygen2()||this.generatedHtml()||this.generatedJison()||this.generatedGrpcCpp()||this.generatedDart()||this.generatedPerlPpportHeader()||this.generatedGamemakerstudio()||this.generatedGimp()||this.generatedVisualstudio6()||this.generatedHaxe()||this.generatedJooq()||this.generatedSorbetRbi()||this.generatedMysqlViewDefinitionFormat())}xcodeFile(){return[".nib",".xcworkspacedata",".xcuserstate"].includes(this.extname)}intellijFile(){return/(?:^|\/)\.idea\//.test(this.name)}cocoapods(){return/(^Pods|\/Pods)\//.test(this.name)}carthageBuild(){return/(^|\/)Carthage\/Build\//.test(this.name)}generatedGraphqlRelay(){return/__generated__\//.test(this.name)}generatedNetDesignerFile(){return/\.designer\.(cs|vb)$/i.test(this.name)}generatedNetSpecflowFeatureFile(){return/\.feature\.cs$/i.test(this.name)}composerLock(){return/composer\.lock/.test(this.name)}cargoLock(){return/Cargo\.lock/.test(this.name)}cargoOrig(){return/Cargo\.toml\.orig/.test(this.name)}denoLock(){return/deno\.lock/.test(this.name)}flakeLock(){return/(^|\/)flake\.lock$/.test(this.name)}bazelLock(){return/(^|\/)MODULE\.bazel\.lock$/.test(this.name)}nodeModules(){return/node_modules\//.test(this.name)}goVendor(){return/vendor\/((?!-)[-0-9A-Za-z]+(?<!-)\.)+(com|edu|gov|in|me|net|org|fm|io)/.test(this.name)}goLock(){return/(Gopkg|glide)\.lock/.test(this.name)}packageResolved(){return/Package\.resolved/.test(this.name)}poetryLock(){return/poetry\.lock/.test(this.name)}pdmLock(){return/pdm\.lock/.test(this.name)}uvLock(){return/uv\.lock/.test(this.name)}pixiLock(){return/pixi\.lock/.test(this.name)}esyLock(){return/(^|\/)(\w+\.)?esy\.lock$/.test(this.name)}npmShrinkwrapOrPackageLock(){return/npm-shrinkwrap\.json/.test(this.name)||/package-lock\.json/.test(this.name)}pnpmLock(){return/pnpm-lock\.yaml/.test(this.name)}bunLock(){return/(?:^|\/)bun\.lockb?$/.test(this.name)}terraformLock(){return/(?:^|\/)\.terraform\.lock\.hcl$/.test(this.name)}generatedYarnPlugnplay(){return/(^|\/)\.pnp\..*$/.test(this.name)}godeps(){return/Godeps\//.test(this.name)}generatedByZephir(){return/\.zep\.(c|h|php)$/.test(this.name)}htmlcov(){return/(?:^|\/)htmlcov\//.test(this.name)}gradleWrapper(){return/(?:^|\/)gradlew(?:\.bat)?$/i.test(this.name)}mavenWrapper(){return/(?:^|\/)mvnw(?:\.cmd)?$/i.test(this.name)}pipenvLock(){return/Pipfile\.lock/.test(this.name)}generatedPascalTlb(){return/_tlb\.pas$/i.test(this.name)}generatedSqlxQuery(){return/(?:^|\/)\.sqlx\/query-[a-f\d]{64}\.json$/.test(this.name)}sourceMapByName(){return/\.(css|js)\.map$/i.test(this.name)}maybeMinified(){return[".js",".css"].includes(this.extname)}minifiedFiles(){return!(!this.maybeMinified()||0===this.lines.length)&&this.lines.reduce(((e,t)=>e+t.length),0)/this.lines.length>110}hasSourceMap(){return!!this.maybeMinified()&&this.lines.slice(-2).some((e=>/^\/[*/][#@] source(?:Mapping)?URL|sourceURL=/.test(e)))}sourceMap(){if(".map"!==this.extname)return!1;if(/\.(css|js)\.map$/i.test(this.name))return!0;const e=this.lines[0]||"";return/^{"version":\d+,/.test(e)||/^\/\*\* Begin line maps\. \*\*\/{/.test(e)}compiledCoffeescript(){if(".js"!==this.extname)return!1;const e=this.lines[0]||"";if(/^\/\/ Generated by /.test(e))return!0;if("(function() {"===e&&"}).call(this);"===(this.lines[this.lines.length-2]||"")&&""===(this.lines[this.lines.length-1]||"")){let e=0;for(const t of this.lines)if(/var /.test(t)){const n=t.match(/_fn|_i|_len|_ref|_results/g);e+=1*(n?.length||0);const r=t.match(/__bind|__extends|__hasProp|__indexOf|__slice/g);e+=3*(r?.length||0)}return e>=3}return!1}generatedNetDocfile(){return".xml"===this.extname&&!(this.lines.length<=3)&&(this.lines[1]||"").includes("<doc>")&&(this.lines[2]||"").includes("<assembly>")&&(this.lines[this.lines.length-2]||"").includes("</doc>")}generatedParser(){if(".js"!==this.extname)return!1;const e=this.lines.slice(0,5).join("");return/^(?:[^/]|\/[^*])*\/\*(?:[^*]|\*[^/])*Generated by PEG\.js/.test(e)}generatedPostscript(){if(![".ps",".eps",".pfa"].includes(this.extname))return!1;const e=this.data;if(!e)return!1;if(/^\s*(?:currentfile eexec\s+|\/sfnts\s+\[\s<)/.test(e))return!0;const t=this.lines.slice(0,10).find((e=>/^%%Creator: /.test(e)));return!!t&&(!(!/[0-9]|draw|mpage|ImageMagick|inkscape|MATLAB/.test(t)&&!/PCBNEW|pnmtops|\(Unknown\)|Serif Affinity|Filterimage -tops/.test(t))||!!t.includes("EAGLE")&&this.lines.slice(0,5).some((e=>/^%%Title: EAGLE Drawing /.test(e))))}generatedGo(){return".go"===this.extname&&!(this.lines.length<=1)&&this.lines.slice(0,40).some((e=>/^\/\/ Code generated .*/.test(e)))}generatedProtocolBufferFromGo(){return".proto"===this.extname&&!(this.lines.length<=1)&&this.lines.slice(0,20).some((e=>e.includes("This file was autogenerated by go-to-protobuf")))}generatedProtocolBuffer(){return!![".py",".java",".h",".cc",".cpp",".m",".rb",".php"].includes(this.extname)&&!(this.lines.length<=1)&&this.lines.slice(0,3).some((e=>e.includes("Generated by the protocol buffer compiler.  DO NOT EDIT!")))}generatedJavascriptProtocolBuffer(){return".js"===this.extname&&!(this.lines.length<=6)&&(this.lines[5]||"").includes("GENERATED CODE -- DO NOT EDIT!")}generatedTypescriptProtocolBuffer(){return".ts"===this.extname&&!(this.lines.length<=4)&&(this.lines[0]||"").includes("Code generated by protoc-gen-ts_proto. DO NOT EDIT.")}generatedApacheThrift(){return!![".rb",".py",".go",".js",".m",".java",".h",".cc",".cpp",".php"].includes(this.extname)&&this.lines.slice(0,6).some((e=>e.includes("Autogenerated by Thrift Compiler")))}generatedJniHeader(){return".h"===this.extname&&!(this.lines.length<=2)&&(this.lines[0]||"").includes("/* DO NOT EDIT THIS FILE - it is machine generated */")&&(this.lines[1]||"").includes("#include <jni.h>")}vcrCassette(){return".yml"===this.extname&&!(this.lines.length<=2)&&(this.lines[this.lines.length-2]||"").includes("recorded_with: VCR")}generatedAntlr(){return".g"===this.extname&&!(this.lines.length<=2)&&(this.lines[1]||"").includes("generated by Xtest")}compiledCythonFile(){return!![".c",".cpp"].includes(this.extname)&&!(this.lines.length<=1)&&(this.lines[0]||"").includes("Generated by Cython")}generatedModule(){if(".mod"!==this.extname)return!1;if(this.lines.length<=1)return!1;const e=this.lines[0]||"";return e.includes("PCBNEW-LibModule-V")||e.includes("GFORTRAN module version '")}generatedUnity3dMeta(){return".meta"===this.extname&&!(this.lines.length<=1)&&(this.lines[0]||"").includes("fileFormatVersion: ")}generatedRacc(){return".rb"===this.extname&&!(this.lines.length<=2)&&(this.lines[2]||"").startsWith("# This file is automatically generated by Racc")}generatedJflex(){return".java"===this.extname&&!(this.lines.length<=1)&&(this.lines[0]||"").startsWith("/* The following code was generated by JFlex ")}generatedGrammarkit(){return".java"===this.extname&&!(this.lines.length<=1)&&(this.lines[0]||"").startsWith("// This is a generated file. Not intended for manual editing.")}generatedRoxygen2(){return".rd"===this.extname&&!(this.lines.length<=1)&&(this.lines[0]||"").includes("% Generated by roxygen2: do not edit by hand")}generatedHtml(){if(![".html",".htm",".xhtml"].includes(this.extname))return!1;if(this.lines.length<=1)return!1;if(this.lines.slice(0,2).some((e=>/<!-- Generated by pkgdown: do not edit by hand -->/.test(e))))return!0;if(this.lines.length>2&&(this.lines[2]||"").startsWith("\x3c!-- This is an automatically generated file."))return!0;if(this.lines.slice(0,31).some((e=>/<!--\s+Generated by Doxygen\s+[.0-9]+\s*-->/i.test(e))))return!0;const e=this.lines.slice(0,31).join(" ").match(/<meta(\s+[^>]+)>/gi);if(!e)return!1;for(const t of e){const e=this.extractHtmlMeta(t);if("generator"===e.name?.toLowerCase()&&(e.content||e.value)){const t=e.content||e.value||"";if(/^(org\s+mode|j?latex2html|groff|makeinfo|texi2html|ronn)\b/i.test(t))return!0}}return!1}extractHtmlMeta(e){const t={},n=e.matchAll(/(?<=^|\s)(name|content|value)\s*=\s*("[^"]+"|'[^']+'|[^\s"']+)/gi);for(const e of n){const n=e[1].toLowerCase();let r=e[2];(r.startsWith('"')&&r.endsWith('"')||r.startsWith("'")&&r.endsWith("'"))&&(r=r.slice(1,-1)),t[n]=r}return t}generatedJison(){if(".js"!==this.extname)return!1;if(this.lines.length<=1)return!1;const e=this.lines[0]||"";return e.startsWith("/* parser generated by jison ")||e.startsWith("/* generated by jison-lex ")}generatedGrpcCpp(){return!![".cpp",".hpp",".h",".cc"].includes(this.extname)&&!(this.lines.length<=1)&&(this.lines[0]||"").startsWith("// Generated by the gRPC")}generatedDart(){return".dart"===this.extname&&!(this.lines.length<=1)&&this.lines.slice(0,3).some((e=>/generated code\W{2,3}do not modify/i.test(e)))}generatedPerlPpportHeader(){return!!/ppport\.h$/.test(this.name)&&!(this.lines.length<=10)&&(this.lines[8]||"").includes("Automatically created by Devel::PPPort")}generatedGamemakerstudio(){if(![".yy",".yyp"].includes(this.extname))return!1;if(this.lines.length<=3)return!1;const e=this.lines.slice(0,3).join("");return/^\s*[{[]/.test(e)||/^\d\.\d\.\d.+\|\{/.test(this.lines[0]||"")}generatedGimp(){if(![".c",".h"].includes(this.extname))return!1;if(0===this.lines.length)return!1;const e=this.lines[0]||"";return/^\/\* GIMP [a-zA-Z0-9- ]+ C-Source image dump \(.+?\.c\) \*\//.test(e)||/^\/\* {2}GIMP header image file format \([a-zA-Z0-9- ]+\): .+?\.h {2}\*\//.test(e)}generatedVisualstudio6(){return".dsp"===this.extname&&this.lines.slice(0,3).some((e=>e.includes("# Microsoft Developer Studio Generated Build File")))}generatedHaxe(){return!![".js",".py",".lua",".cpp",".h",".java",".cs",".php"].includes(this.extname)&&this.lines.slice(0,3).some((e=>e.includes("Generated by Haxe")))}generatedJooq(){return".java"===this.extname&&this.lines.slice(0,2).some((e=>e.includes("This file is generated by jOOQ.")))}generatedSorbetRbi(){return".rbi"===this.extname&&!(this.lines.length<5)&&/^# typed:/.test(this.lines[0]||"")&&(this.lines[2]||"").includes("DO NOT EDIT MANUALLY")&&/^# Please (run|instead update this file by running) `bin\/tapioca/.test(this.lines[4]||"")}generatedMysqlViewDefinitionFormat(){return".frm"===this.extname&&(this.lines[0]||"").includes("TYPE=VIEW")}}const Re=(e,t)=>be.promisify(a.exec)(e,{maxBuffer:52428800,...t}),Le=e=>{try{return new URL(e)}catch(t){return new URL(`https://${e}`)}},Ne=(0,c.h)("exec-daemon-git");function Ue(e){const t=(e=>{if(!e)return[];if("string"!=typeof e||e.match(/^\s+$/))return[];const t=e.split("\n");if(0===t.length)return[];const n=[];let r=null,s=null,i=0,o=0,a=null;const c=e=>{const[t,s]=Se(e)??[];r={chunks:[],deletions:0,additions:0,from:t,to:s},n.push(r)},l=()=>{r&&!r.chunks.length||c()},d=e=>+(e||1),u=e=>{if(!s)return;const[t]=s.changes.slice(-1);s.changes.push({type:t.type,[t.type]:!0,ln1:t.ln1,ln2:t.ln2,ln:t.ln,content:e})},h=[[/^diff\s/,c],[/^new file mode (\d+)$/,(e,t)=>{l(),r.new=!0,r.newMode=t[1],r.from="/dev/null"}],[/^deleted file mode (\d+)$/,(e,t)=>{l(),r.deleted=!0,r.oldMode=t[1],r.to="/dev/null"}],[/^old mode (\d+)$/,(e,t)=>{l(),r.oldMode=t[1]}],[/^new mode (\d+)$/,(e,t)=>{l(),r.newMode=t[1]}],[/^index\s[\da-zA-Z]+\.\.[\da-zA-Z]+(\s(\d+))?$/,(e,t)=>{l(),r.index=e.split(" ").slice(1),t[1]&&(r.oldMode=r.newMode=t[1].trim())}],[/^---\s/,e=>{l(),r.from=xe(e)}],[/^\+\+\+\s/,e=>{l(),r.to=xe(e)}],[/^@@\s+-(\d+),?(\d+)?\s+\+(\d+),?(\d+)?\s@@/,(e,t)=>{r||c(e);const[n,l,u,h]=t.slice(1);i=+n,o=+u,s={content:e,changes:[],oldStart:+n,oldLines:d(l),newStart:+u,newLines:d(h)},a={oldLines:d(l),newLines:d(h)},r.chunks.push(s)}],[/^\\ No newline at end of file$/,u]],m=[[/^\\ No newline at end of file$/,u],[/^-/,e=>{s&&(s.changes.push({type:"del",del:!0,ln:i++,content:e}),r.deletions++,a.oldLines--)}],[/^\+/,e=>{s&&(s.changes.push({type:"add",add:!0,ln:o++,content:e}),r.additions++,a.newLines--)}],[/^\s+/,e=>{s?.changes.push({type:"normal",normal:!0,ln1:i++,ln2:o++,content:e}),a.oldLines--,a.newLines--}]],f=e=>{a?(e=>{for(const[t,n]of m){const r=e.match(t);if(r){n(e,r);break}}0===a.oldLines&&0===a.newLines&&(a=null)})(e):(e=>{for(const[t,n]of h){const r=e.match(t);if(r){n(e,r);break}}})(e)};for(const e of t)f(e);return n})(e);return new te.o$({diffs:t.map((e=>function(e){const t=new te.QP({from:e.from,to:e.to,chunks:e.chunks.map((e=>new te.Ei({content:e.content,lines:e.changes.map((e=>e.content)),oldStart:e.oldStart,oldLines:e.oldLines,newStart:e.newStart,newLines:e.newLines})))});return t.added=e.additions,t.removed=e.deletions,t}(e))),diffType:te.Wf.UNSPECIFIED})}class Oe{ctx;constructor(e){this.ctx=e}workspaceChangesHashPromises=new Map;submoduleCache;refreshTokenPromise=null;cachedGitVersion=new Map;async getGitVersion(e){const t=e;if(this.cachedGitVersion.has(t)){const e=this.cachedGitVersion.get(t);if(void 0===e?.payload)throw new Error("Git version is undefined");return e.payload}{const n=await this.getGitVersionUncached(e);return this.cachedGitVersion.set(t,{isInitialized:!0,payload:n}),n}}async getGitVersionUncached(e){try{Ne.debug(this.ctx,"Getting git version",{cwd:e});const t=Date.now(),{stdout:n}=await Re("git --version",{cwd:e});Ne.debug(this.ctx,"Got git version",{cwd:e,durationMs:Date.now()-t});const r=n.trim().match(/git version (\d+)\.(\d+)\.(\d+)/);if(r)return{major:parseInt(r[1],10),minor:parseInt(r[2],10),patch:parseInt(r[3],10)}}catch(t){Ne.error(this.ctx,"Failed to get git version",t,{cwd:e})}return{major:2,minor:9,patch:0}}supportsNoOptionalLocks(e){return e.major>2||2===e.major&&e.minor>15||2===e.major&&15===e.minor&&e.patch>=2}isRemoteRef(e){return/^[a-zA-Z0-9_-]+\/[a-zA-Z0-9_/-]+$/.test(e)}isCommitHash(e){return/^[a-f0-9]{40}$/.test(e)}async getSubmodulesPotentiallyCached(e){if(this.submoduleCache)return this.submoduleCache;Ne.debug(this.ctx,"Getting submodule status",{rootPath:e});const t=Date.now(),{stdout:n}=await Re("git submodule status",{cwd:e});return Ne.debug(this.ctx,"Got submodule status",{rootPath:e,durationMs:Date.now()-t}),this.submoduleCache=n.split("\n").filter((e=>e.trim().length>0)).map((t=>{const n=t.trim().match(/^[\s+-]?([a-f0-9]+)\s+(.+?)(?:\s+\(.+\))?$/);if(!n)return null;const r=n[1],s=n[2];return{path:s,absPath:h.join(e,s),currentRef:r}})).filter((e=>null!==e)),this.submoduleCache}async getWorkspaceChangesHash(e,t){const n=this.workspaceChangesHashPromises.get(e);if(n)return Ne.debug(this.ctx,"Returning cached workspace changes hash promise",{rootPath:e}),n;Ne.debug(this.ctx,"Computing workspace changes hash",{rootPath:e});const r=Date.now(),s=(async()=>{const n=await this.getGitVersion(e),r=this.supportsNoOptionalLocks(n),s=async(e,t)=>{try{const n=["git"];r&&n.push("--no-optional-locks"),n.push(...e);const{stdout:s}=await Re(n.join(" "),{cwd:t});return s.trim()}catch(e){return""}};let i="";if(i+=await s(["rev-parse","HEAD"],e),i+=await s(["status","--porcelain"],e),t.length>0&&!this.isCommitHash(t))try{i+=await s(["rev-parse",t],e)}catch(n){Ne.error(this.ctx,`Failed to parse ${t}`,n,{rootPath:e,baseRef:t})}const o=await this.getSubmodulesPotentiallyCached(e);for(const e of o)i+=await s(["rev-parse","HEAD"],e.absPath),i+=await s(["status","--porcelain"],e.absPath);let a=5381;for(let e=0;e<i.length;e++)a=(a<<5)+a+i.charCodeAt(e),a&=4294967295;return i=a.toString(16),i})();this.workspaceChangesHashPromises.set(e,s);try{return await s}finally{Ne.debug(this.ctx,"Workspace changes hash computation completed",{rootPath:e,durationMs:Date.now()-r}),this.workspaceChangesHashPromises.delete(e)}}async getGitRoot(e){return(await this.executeGitCommandStable(e,["rev-parse","--show-toplevel"])).trim()}async getDiff(e,t){const n=await this.getGitVersion(e),r=this.supportsNoOptionalLocks(n);Ne.debug(this.ctx,"Getting diff",{cwd:e,baseRef:t.baseRef,ref:t.ref,format:t.outputFormat,useNoOptionalLocks:r});const s=Date.now(),i=(()=>{switch(t.outputFormat){case te.ek.NAME_STATUS:return te.ek.NAME_STATUS;case te.ek.NAME_STATUS_AND_NUMSTAT:return te.ek.NAME_STATUS_AND_NUMSTAT;case te.ek.FILE_DIFFS:return te.ek.FILE_DIFFS;case te.ek.DIFFS_WITH_BEFORE_AND_AFTER:return te.ek.DIFFS_WITH_BEFORE_AND_AFTER;default:return te.ek.FILE_DIFFS}})(),o=[];if(t.submoduleRecurseDepth>0){const n=await this.getSubmodules(e),r=await Promise.allSettled(n.map((async n=>{const r=h.join(e,n);if(await this.getGitRoot(r)!==r)throw new Error(`Submodule ${n} is not initialized. Please initialize it first.`);const s=await this.getDiff(r,{...t,baseRef:"HEAD",targetPaths:t.targetPaths.map((e=>h.relative(n,e))),submoduleRecurseDepth:t.submoduleRecurseDepth-1});return{relativePath:n,diff:s}})));for(let t=0;t<r.length;t++){const s=r[t];if("fulfilled"===s.status){const e=s.value;o.push(...e.diff.submoduleDiffs.map((t=>({relativePath:h.join(e.relativePath,t.relativePath),diff:t.diff,errored:!1})))),o.push({relativePath:e.relativePath,diff:e.diff.diff,errored:!1})}else o.push({relativePath:h.join(e,n[t]),diff:new te.o$,errored:!0})}}const a=async()=>{let n=(await this.executeGitCommandStable(e,["ls-files","--others","--exclude-standard"],{useNoOptionalLocks:r})).split("\n").filter((e=>e.trim()));return n.length>t.maxUntrackedFiles&&(n=n.slice(0,t.maxUntrackedFiles)),Promise.all(n.map((async t=>{try{const n=t.trim();return{contents:await u.readFile(h.join(e,n),"utf8"),path:n}}catch(e){return}}))).then((e=>e.filter((e=>void 0!==e))))},c=Ue(await(async()=>{let n=t.baseRef.length>0?t.baseRef:await this.getDefaultBranch({cwd:e});t.mergeBase&&(n=(await this.executeGitCommandStable(e,["merge-base",n,t.ref.length>0?t.ref:"HEAD"],{useNoOptionalLocks:r})).trim());const s=["diff","--no-color"];return t.includeSpaceChanges||s.push("--ignore-space-change"),void 0!==t.unifiedContextLines&&s.push(`-U${t.unifiedContextLines}`),s.push(n),t.ref.length>0&&s.push(t.ref),t.targetPaths.length>0&&(s.push("--"),s.push(...t.targetPaths)),this.executeGitCommandStable(e,s,{shouldNotTrimOutput:!0,useNoOptionalLocks:r})})());if(t.maxUntrackedFiles>0){const t=await a();for(const n of t){const t=Ue(await this.executeGitCommandStable(e,["diff","--no-color","--no-index","/dev/null",n.path],{ignoreErrors:!0,useNoOptionalLocks:r}));c.diffs.push(...t.diffs)}}if(i!==te.ek.FILE_DIFFS)for(const e of c.diffs)e.chunks=[];if(c.diffs=c.diffs.filter((e=>!o.some((t=>t.relativePath===e.to)))),i===te.ek.DIFFS_WITH_BEFORE_AND_AFTER){let n=t.baseRef.length>0?t.baseRef:await this.getDefaultBranch({cwd:e});t.mergeBase&&(n=(await this.executeGitCommandStable(e,["merge-base",n,t.ref.length>0?t.ref:"HEAD"],{useNoOptionalLocks:r})).trim());const s=t.ref.length>0?t.ref:"HEAD";await Promise.all(c.diffs.map((async i=>{try{if("/dev/null"!==i.from)try{const t=await this.executeGitCommandStable(e,["show",`${n}:${i.from}`],{shouldNotTrimOutput:!0,useNoOptionalLocks:r});i.beforeFileContents=t}catch(e){i.beforeFileContents=""}else i.beforeFileContents="";if("/dev/null"!==i.to)if(t.ref.length>0)try{const t=await this.executeGitCommandStable(e,["show",`${s}:${i.to}`],{shouldNotTrimOutput:!0,useNoOptionalLocks:r});i.afterFileContents=t}catch(e){i.afterFileContents=""}else try{const t=h.join(e,i.to),n=await u.readFile(t,"utf8");i.afterFileContents=n}catch(t){try{const t=await this.executeGitCommandStable(e,["show",`${s}:${i.to}`],{shouldNotTrimOutput:!0,useNoOptionalLocks:r});i.afterFileContents=t}catch(e){i.afterFileContents=""}}else i.afterFileContents=""}catch(e){Ne.error(this.ctx,`Error fetching file contents for ${i.to}:`,e,{fileDiff:i})}})))}const l=c.diffs.map((e=>"/dev/null"!==e.to?e.to:e.from)).filter((e=>void 0!==e)),d=t.ref.length>0?t.ref:"HEAD",m=new Map;for(const e of c.diffs){const t="/dev/null"!==e.to?e.to:e.from;t&&m.set(t,e)}const f=await Fe({repoRoot:e,filePaths:l,getContent:async t=>{const n=m.get(t);if(n)try{if(void 0!==n.afterFileContents)return n.afterFileContents;if(n.to&&"/dev/null"!==n.to)return await this.executeGitCommandStable(e,["show",`${d}:${n.to}`],{shouldNotTrimOutput:!0,useNoOptionalLocks:r})}catch{}}});let p=0;for(const[e,t]of f){const n=m.get(e);n&&(n.isGenerated=t.isGenerated,t.isGenerated&&p++)}const g=new te.df({diff:c,submoduleDiffs:o});return Ne.debug(this.ctx,"Diff computation completed",{cwd:e,durationMs:Date.now()-s,numDiffs:c?.diffs.length??0,numSubmoduleDiffs:o.length,numGeneratedFiles:p}),g}cachedDefaultBranch=new Map;async getDefaultBranch(e){const t=e.cwd,n=e.withoutOrigin?`${t}-without-origin`:t;if(this.cachedDefaultBranch.has(n)){const e=this.cachedDefaultBranch.get(n);if(void 0===e?.payload)throw new Error("Default branch is undefined");return e.payload}{let t=await this.getDefaultBranchUncached(e);return e?.withoutOrigin&&(t=t.replace(/^origin\//,"")),this.cachedDefaultBranch.set(n,{isInitialized:!0,payload:t}),t}}async getDefaultBranchUncached(e){const t=e.cwd;let n;if(!n)try{if(n=await this.executeGitCommandStable(t,["symbolic-ref","--short","refs/remotes/origin/HEAD"]),n)return n.trim()}catch(e){Ne.error(this.ctx,"failed to get symbolic ref",e)}const r=["main","master","develop"];try{const e=h.join(t,".git","HEAD"),s=(await u.readFile(e,"utf8")).trim().match(/^ref: refs\/heads\/(.*)$/),i=s?.[1]?.trim();if(i&&r.includes(i)){const e=`origin/${i}`;try{return await this.executeGitCommandStable(t,["rev-parse","--verify",e]),n=e,Ne.debug(this.ctx,"Picked default branch from method 1.",{}),n.trim()}catch{}}}catch(e){Ne.error(this.ctx,"failed to read .git/HEAD",e)}for(const e of r)try{const r=`origin/${e}`;return await this.executeGitCommandStable(t,["rev-parse","--verify",r]),n=r,n.trim()}catch{}try{const e=(await this.executeGitCommandStable(t,["branch","-r"])).split("\n").find((e=>e.startsWith("origin/")));if(e)return n=e,n.trim()}catch(e){Ne.error(this.ctx,"failed to get branches from remote",e)}try{const e=await this.executeGitCommandStable(t,["config","--get","init.defaultBranch"]);if(e)return e.trim()}catch(e){Ne.error(this.ctx,"failed to get default branch from git config",e)}throw new Error("Could not determine default branch")}async executeGitCommandStable(e,t,n={}){const r=!0===n.useNoOptionalLocks?["--no-optional-locks",...t]:t;Ne.debug(this.ctx,"Executing git command",{cwd:e,args:r.join(" ")});const s=Date.now(),i=await new Promise(((t,s)=>{const i=(0,a.spawn)("git",r,{cwd:e});let o="",c="";i.stdout.on("data",(e=>{o+=e.toString()})),i.stderr.on("data",(e=>{c+=e.toString()})),i.on("close",(e=>{0===e||n.ignoreErrors?t(o):s(new Error(`Git command failed with code ${e}: ${c}`))})),i.on("error",(e=>{n.ignoreErrors?t(o):s(e)}))}));return Ne.debug(this.ctx,"Git command completed",{cwd:e,args:t.join(" "),durationMs:Date.now()-s}),n.shouldNotTrimOutput?i:i.trim()}async executeGitCommandStableWithArray(e,t){return new Promise(((n,r)=>{const s=(0,a.spawn)("git",t,{cwd:e});let i="",o="";s.stdout.on("data",(e=>{i+=e.toString()})),s.stderr.on("data",(e=>{o+=e.toString()})),s.on("close",(e=>{0===e?n(i.trim()):r(new Error(`Git command failed with code ${e}: ${o}`))})),s.on("error",(e=>{r(e)}))}))}async getSubmodules(e){try{const t='git config --file .gitmodules --get-regexp path | sed -e "s/^submodule\\.//" -e "s/ /|/" | cut -d"|" -f2';return(await Re(t,{cwd:e})).stdout.split("\n").filter(Boolean)}catch(e){return Ne.error(this.ctx,"Error getting submodules",e),[]}}async getGitFileBlameWithRelativePath(e,t,n=10){try{Ne.debug(this.ctx,"Getting git file blame",{relativePath:e,rootPath:t,numCommits:n});const r=Date.now(),s=["log",`-n${n}`,"--pretty=format:%H|%an|%ad|%s","--date=iso","--follow","--",e],i=await this.executeGitCommandStableWithArray(t,s);if(!i.trim())return;const o=[],a=i.trim().split("\n");for(const e of a){if(!e.trim())continue;const t=e.split("|");t.length>=4&&o.push({commit:t[0].trim(),author:t[1].trim(),date:t[2].trim(),message:t.slice(3).join("|").trim()})}const c=o.length>0?{commits:o}:void 0;return Ne.debug(this.ctx,"Git file blame completed",{relativePath:e,durationMs:Date.now()-r,numCommits:o.length}),c}catch(t){return void Ne.error(this.ctx,"Failed to get git blame",t,{relativePath:e})}}async getCommitInfo(e,t){try{const n=await this.executeGitCommandStable(e,["show","-m",'--format="%H|%an|%ad|%s"',"--date=iso","--no-patch",t]);if(!n.trim())return;const r=n.trim().split("|");if(r.length>=4)return{commit:r[0].trim(),author:r[1].trim(),date:r[2].trim(),message:r.slice(3).join("|").trim()}}catch(e){Ne.error(this.ctx,"Failed to get commit info",e,{commitHash:t})}}async getCommitChangedFiles(e,t){try{return(await this.executeGitCommandStable(e,["diff-tree","--no-commit-id","--name-only","-r",t])).split("\n").filter((e=>e.trim().length>0))}catch(e){return Ne.error(this.ctx,"Failed to get commit changed files",e,{commitHash:t}),[]}}async getCommitDiff(e,t,n=3){try{return await this.executeGitCommandStable(e,["show","--no-merges","--format=",`--unified=${n}`,t],{shouldNotTrimOutput:!0})}catch(e){return Ne.error(this.ctx,"Failed to get commit diff",e,{commitHash:t}),""}}async executeGitCommand(e,t){return this.executeGitCommandStable(e,t)}async refreshGithubAccessToken(e,t){if(this.refreshTokenPromise)return this.refreshTokenPromise;const n="x-access-token";return this.refreshTokenPromise=(async()=>{try{try{const e=t.replace(/\./g,"\\."),r=`url."https://${n}:.*@${e}/".insteadOf`,{stdout:s}=await Re(`git config --global --get-regexp ${r}`),i=s.split("\n").filter((e=>e.trim())),o=new Set;for(const e of i){const t=e.split(" ")[0];o.add(t)}for(const e of o)await Re(`git config --global --unset-all ${e}`),Ne.debug(this.ctx,"Successfully removed token-based URL configuration",{key:`${e.slice(0,10)}...`,hostname:t})}catch(e){Ne.debug(this.ctx,"No existing token-based URL configurations found.",{error:e instanceof Error?e.message:String(e),hostname:t})}await Re(`git config --global url."https://${n}:${e}@${t}/".insteadOf https://${t}/`),await Re(`git config --global --add url."https://${n}:${e}@${t}/".insteadOf git@${t}:`),await Re(`git config --global --add url."https://${n}:${e}@${t}/".insteadOf ssh://git@${t}/`),await Re(`git config --global --add url."https://${n}:${e}@${t}/".insteadOf git+ssh://git@${t}/`),await Re(`git config --global --add url."https://${n}:${e}@${t}/".insteadOf ssh://git@${t}:22/`),await Re(`git config --global --add url."https://${n}:${e}@${t}/".insteadOf git+ssh://git@${t}:22/`),Ne.info(this.ctx,"Successfully refreshed access token in git config.",{hostname:t}),await this.writeGhHostsYml(e);const{stdout:r}=await Re("git remote -v"),s=r.split("\n").filter((e=>e.trim()));for(const e of s){const[n,r]=e.split(/\s+/);if(!r)continue;const s=r.includes("x-access-token")||r.includes("oauth2"),i=r.includes(t);if(s&&i)try{const e=Le(r).pathname,s=`https://${t}${e}`;await Re(`git remote set-url ${n} ${s}`),Ne.debug(this.ctx,"Successfully updated remote URL.",{remoteName:n,hostname:t})}catch(e){Ne.warn(this.ctx,"Failed to parse remote URL, skipping update.",{remoteName:n,url:r,error:e instanceof Error?e.message:String(e),hostname:t})}}}finally{this.refreshTokenPromise=null}})(),this.refreshTokenPromise}async writeGhHostsYml(e){Ne.info(this.ctx,"exec-daemon-gh: Writing token to gh hosts.yml");try{const t=ve.homedir(),n=(0,h.join)(t,".config","gh"),r=(0,h.join)(n,"hosts.yml");await(0,u.mkdir)(n,{recursive:!0});const s=`github.com:\n  oauth_token: ${e}\n  user: cursor\n  git_protocol: https\n`,i=`${r}.tmp`;await(0,u.writeFile)(i,s,{mode:384}),await Re(`mv ${i} ${r}`)}catch(e){Ne.error(this.ctx,"exec-daemon-gh: Failed to write gh hosts.yml; continuing",e)}}}var $e=n("node:https"),Me=n("../../node_modules/.pnpm/https-proxy-agent@7.0.6/node_modules/https-proxy-agent/dist/index.js");const Be=be.promisify(a.exec),Je=(0,c.h)("exec-daemon-remote-access"),Ge=(0,h.join)(process.env.HOME??"",".cursor-server/extensions"),qe=process.env.HTTPS_PROXY??process.env.HTTP_PROXY,je=void 0!==qe&&qe.length>0?new Me.HttpsProxyAgent(qe):void 0;class He{isLocked=!1;queue=[];async acquire(){return new Promise((e=>{this.isLocked?this.queue.push((()=>{this.isLocked=!0,e(this.release.bind(this))})):(this.isLocked=!0,e(this.release.bind(this)))}))}release(){this.isLocked=!1;const e=this.queue.shift();e&&e()}}class We{commitLocks=new Map;downloadCommitLocks=new Map;async warmCursorServer(e,t,n,r){if(r.length<10)throw new re.T("Connection token is too short",se.C.InvalidArgument);let s=this.commitLocks.get(t);s||(s=new He,this.commitLocks.set(t,s));const i=await s.acquire();try{try{Je.debug(e,"Ensuring cursor server is downloaded",{commit:t});const n=Date.now();await this.downloadCursorServer(e,t),Je.debug(e,"Cursor server download check completed",{commit:t,durationMs:Date.now()-n})}catch(n){throw Je.error(e,"Failed to download cursor server",n,{commit:t}),new re.T("Failed to download cursor server",se.C.Internal)}const s=`http://localhost:${n}/version`;try{Je.debug(e,"Checking if server is already running",{versionUrl:s});const i=Date.now(),o=await fetch(s,{method:"GET",signal:AbortSignal.timeout(1e3)});Je.debug(e,"Server check completed",{durationMs:Date.now()-i});const a=await o.text();if(a.trim()===t){Je.debug(e,"Verifying connection token hash",{commit:t});const s=Date.now(),i=await this.verifyConnectionTokenHash(t,r);if(Je.debug(e,"Token verification completed",{durationMs:Date.now()-s,matches:i}),i)return void Je.info(e,"Cursor server is already running with correct connection token. Good to go!",{commit:t,port:n});throw new Error(`Connection token hash mismatch: expected ${t}, got ${a.trim()}`)}throw new Error(`Version mismatch: expected ${t}, got ${a.trim()}`)}catch(t){const r=t instanceof Error?t.message:String(t);await this.killServerOnPort(e,n,r)}const{serverPath:i,binDir:o}=this.getServerPath(t);await this.storeConnectionTokenHash(t,r),(0,a.spawn)(i,["--host=0.0.0.0",`--port=${n}`,`--connection-token=${r}`,`--extensions-dir=${Ge}`],{detached:!0,stdio:"ignore",cwd:o}).unref();try{const s=10;let i=0,o=null;for(;i<s;){const a=100*2**i;Je.debug(e,`Waiting ${a}ms before attempt ${i+1}/${s} to verify cursor server`,{commit:t,port:n,retryCount:i,maxRetries:s,backoffMs:a}),await new Promise((e=>setTimeout(e,a)));try{const s=await fetch(`http://localhost:${n}/version`,{method:"GET",headers:{"Connection-Token":r},signal:AbortSignal.timeout(a)});if(!s.ok)throw new Error(`Server responded with status ${s.status}`);const o=await s.text();if(o.trim()!==t)throw new Error(`Version mismatch: expected ${t}, got ${o.trim()}`);return void Je.info(e,`Successfully started cursor server at http://localhost:${n} on attempt ${i+1}`,{commit:t,port:n,retryCount:i})}catch(r){o=r instanceof Error?r:new Error(String(r)),Je.error(e,`Attempt ${i+1}/${s} to verify cursor server failed: ${o.message}`,o,{commit:t,port:n,retryCount:i,maxRetries:s}),i++}}throw Je.error(e,"Failed to verify cursor server is running after all retry attempts",o,{commit:t,port:n}),new re.T("Failed to start cursor server after multiple attempts",se.C.Internal)}catch(r){throw Je.error(e,"Failed to verify cursor server is running",r,{commit:t,port:n}),new re.T("Failed to start cursor server",se.C.Internal)}}finally{i()}}getServerPath(e){const t=`${ve.homedir()}/.cursor-server/bin`;return{serverPath:`${t}/${e}/bin/cursor-server`,binDir:t}}async storeConnectionTokenHash(e,t){const{binDir:n}=this.getServerPath(e),r=(0,l.createHash)("sha256").update(t).digest("hex");await u.writeFile(`${n}/${e}/connection-token-hash`,r,"utf8")}async verifyConnectionTokenHash(e,t){const{binDir:n}=this.getServerPath(e);try{const r=await u.readFile(`${n}/${e}/connection-token-hash`,"utf8"),s=(0,l.createHash)("sha256").update(t).digest("hex");return r.trim()===s}catch(e){return!1}}async getPidListeningOnPort(e,t){const n=ve.platform();try{if("darwin"===n)try{Je.debug(e,"Checking lsof for listening process",{port:t});const n=Date.now(),{stdout:r}=await Be(`lsof -i :${t} -s TCP:LISTEN -t`);Je.debug(e,"lsof check completed",{port:t,durationMs:Date.now()-n});const s=parseInt(r.trim(),10);return Number.isNaN(s)?null:s}catch{return null}else{if("linux"!==n){if("win32"===n){Je.debug(e,"Checking netstat on Windows",{port:t});const n=Date.now(),{stdout:r}=await Be(`netstat -ano | findstr :${t} | findstr LISTENING`);Je.debug(e,"netstat check completed",{port:t,durationMs:Date.now()-n});const s=r.trim().match(/\s+(\d+)\s*$/);return s?parseInt(s[1],10):null}throw new Error(`Unsupported platform: ${n}`)}try{Je.debug(e,"Checking lsof with -Q flag",{port:t});const n=Date.now(),{stdout:r}=await Be(`lsof -i :${t} -s TCP:LISTEN -t -Q`);Je.debug(e,"lsof -Q check completed",{port:t,durationMs:Date.now()-n});const s=parseInt(r.trim(),10);return Number.isNaN(s)?null:s}catch{try{Je.debug(e,"Checking ss for listening process",{port:t});const n=Date.now(),{stdout:r}=await Be(`ss -lptn sport = :${t}`);Je.debug(e,"ss check completed",{port:t,durationMs:Date.now()-n});const s=r.match(/pid=(\d+)/);return s?parseInt(s[1],10):null}catch{Je.debug(e,"Reading /proc/net/tcp");const n=Date.now(),{stdout:r}=await Be("cat /proc/net/tcp");Je.debug(e,"/proc/net/tcp read completed",{durationMs:Date.now()-n});const s=t.toString(16).padStart(4,"0").toUpperCase(),i=r.split("\n");for(const e of i)if(e.includes(`:${s} `)&&e.includes(" 0A ")){const t=e.trim().split(/\s+/);if(t.length>=10){const e=t[9];if(!/^\d+$/.test(e))continue;const{stdout:n}=await Be("ps -ef | awk '{print $2}'");for(const t of n.split("\n"))try{const{stdout:n}=await Be(`ls -l /proc/${t}/fd 2>/dev/null | grep socket`);if(n.includes(`[${e}]`))return parseInt(t,10)}catch{}}}return null}}}}catch(n){throw Je.error(e,`Failed to get PID for port ${t}.`,n,{port:t}),n}}async killServerOnPort(e,t,n){Je.debug(e,"Getting PID listening on port",{port:t});const r=Date.now(),s=await this.getPidListeningOnPort(e,t);if(Je.debug(e,"Got PID",{port:t,pid:s,durationMs:Date.now()-r}),null!==s){Je.debug(e,`Cursor server is running at pid ${s} for port ${t}, but ${n}. Killing it!`,{port:t,pid:s,reason:n});try{Je.debug(e,"Killing process",{pid:s});const n=Date.now();await Be(`kill -9 ${s}`),Je.debug(e,"Process killed",{pid:s,durationMs:Date.now()-n}),Je.debug(e,"Cursor server killed.",{port:t,pid:s})}catch(n){Je.error(e,"Failed to kill cursor server.",n,{port:t,pid:s})}}else Je.debug(e,`Cursor server is not running on port ${t}.`,{port:t})}async downloadCursorServer(e,t){let n=this.downloadCommitLocks.get(t);n||(n=new He,this.downloadCommitLocks.set(t,n));const r=await n.acquire();try{if(!t||!/^[a-zA-Z0-9\-_.]+$/.test(t))throw new Error("Invalid commit format");const n=`https://cursor.blob.core.windows.net/remote-releases/${t}/vscode-reh-${ve.platform()}-${ve.arch()}.tar.gz`,r=`${ve.homedir()}/.cursor-server`,s=`${r}/bin`,i=h.join(s,t),o=crypto.randomUUID(),c=`${i}-dirty-${o}`;await u.mkdir(r,{recursive:!0}),await u.mkdir(s,{recursive:!0}),Je.debug(e,"Checking if server already exists",{finalDir:i});const l=Date.now();if(await u.access(i).then((()=>!0)).catch((()=>!1)))return void Je.debug(e,"Server already exists",{finalDir:i,durationMs:Date.now()-l});try{await u.rm(c,{recursive:!0,force:!0})}catch(e){}const m=h.join(r,`vscode-server-${t}-${o}.tar.gz`);try{Je.debug(e,"Starting server download",{url:n,tempFile:m});const r=Date.now();await new Promise(((t,s)=>{const i=(0,d.createWriteStream)(m);$e.get(n,{agent:je},(n=>{if(200!==n.statusCode)return i.end(),void s(new Error(`Failed to download: ${n.statusCode}`));n.pipe(i),i.on("finish",(()=>{i.close(),Je.debug(e,"Server package downloaded successfully",{tempFile:m,durationMs:Date.now()-r}),t()}))})).on("error",(e=>{i.end(),s(e)})),i.on("error",(e=>{i.end(),s(e)}))})),await u.mkdir(c,{recursive:!0}),Je.debug(e,"Starting server extraction",{tempFile:m,tempDir:c});const s=Date.now();await new Promise(((t,n)=>{const r=(0,a.spawn)("tar",["-xf",m,"--strip-components","1","-C",c]),i=setTimeout((()=>{r.kill(),n(new Error("Tar extraction timed out after 60 seconds"))}),6e4);r.on("close",(r=>{clearTimeout(i),0===r?(Je.debug(e,"Server package extracted successfully",{tempDir:c,durationMs:Date.now()-s}),t()):n(new Error(`tar exited with code ${r}`))})),r.on("error",(e=>{clearTimeout(i),n(e)})),r.stderr.on("data",(t=>{Je.error(e,`Tar stderr: ${t}`,{data:t.toString()})}))}));const o=h.join(c,"bin","cursor-server");await u.chmod(o,493);try{await u.access(o,u.constants.X_OK)}catch(e){throw new Error(`Server binary is not executable at ${o}`)}await u.unlink(m);try{Je.debug(e,"Moving server to final location",{tempDir:c,finalDir:i});const t=Date.now();await u.rename(c,i),Je.debug(e,"Server moved to final location",{durationMs:Date.now()-t})}catch(t){try{await u.rm(c,{recursive:!0,force:!0})}catch(t){Je.error(e,"Failed to clean up temporary directory",t,{tempDir:c})}throw t}Je.debug(e,`Successfully downloaded server at ${i}`,{commit:t,finalDir:i})}catch(e){try{await u.access(m).then((()=>u.unlink(m))).catch((()=>{}))}catch(e){}try{await u.rm(c,{recursive:!0,force:!0})}catch(e){}throw e}}finally{r()}}}var ze=n("../cursor-config/dist/index.js"),Qe=n("../hooks-exec/dist/index.js"),Ye=n("../local-exec/dist/index.js"),Ke=n("../mcp-agent-exec/dist/index.js"),Ve=n("../shell-exec/dist/index.js"),Xe=n("../local-lsp/dist/index.js");class Ze{lspProvider;constructor(e,t,n=3e3){const r=new Xe.MI(e,n);this.lspProvider=new Xe.FM(r.create(t))}async open(e,t){await this.lspProvider.open(e,t)}async getDiagnostics(e,t){return this.lspProvider.getDiagnostics(e,t)}async shutdown(e){await this.lspProvider.shutdown(e)}}var et=n("node:module"),tt=n("../../node_modules/.pnpm/@lydell+node-pty@1.1.0_patch_hash=8cc7c6b3b59e47c0436b0f2bbb89cec1ced0f8ac0beadc41a2d07016bef0ea46/node_modules/@lydell/node-pty/index.js");class nt{capacity;buffer;head=0;count=0;constructor(e){this.capacity=e,this.buffer=new Array(e)}push(e){this.buffer[this.head]=e,this.head=(this.head+1)%this.capacity,this.count<this.capacity&&this.count++}toArray(){if(0===this.count)return[];const e=[],t=this.count<this.capacity?0:this.head;for(let n=0;n<this.count;n++){const r=(t+n)%this.capacity,s=this.buffer[r];void 0!==s&&e.push(s)}return e}sliceAfter(e){const t=this.toArray(),n=t.findIndex(e);return-1===n?t:t.slice(n+1)}get size(){return this.count}}(0,et.createRequire)("file:///__w/everysphere/everysphere/packages/exec-daemon/dist/pty-manager.js");const rt=(0,c.h)("pty-manager");class st{ctx;maxEventHistory;ptys=new Map;nextId=1;constructor(e,t=1e3){this.ctx=e,this.maxEventHistory=t}spawn(e){const t="pty-"+this.nextId++,n=e.process?.shell??(process.env.SHELL||"/bin/sh"),r=e.process?.args??[],s=e.cwd||process.cwd();rt.info(this.ctx,"Spawning PTY",{id:t,shell:n,cwd:s,cols:e.cols,rows:e.rows});const i=tt.cH(n,r,{helperPath:"spawn-helper-unused",name:"xterm-256color",cols:e.cols,rows:e.rows,cwd:s,env:{...process.env,...e.env}}),o={id:t,pty:i,shell:n,cwd:s,cols:e.cols,rows:e.rows,eventListeners:new Set,eventHistory:new nt(this.maxEventHistory),nextEventId:1};return i.onData((e=>{const n={eventId:`${t}-${o.nextEventId++}`,data:{type:"data",data:Buffer.from(e,"utf-8")}};o.eventHistory.push(n),this.notifyListeners(o,n)})),i.onExit((e=>{const n={eventId:`${t}-${o.nextEventId++}`,data:{type:"exit",exitCode:e.exitCode,signal:e.signal}};o.eventHistory.push(n),this.notifyListeners(o,n),rt.info(this.ctx,"PTY exited",{id:t,exitCode:e.exitCode,signal:e.signal}),setTimeout((()=>{this.ptys.delete(t)}),5e3)})),this.ptys.set(t,o),t}get(e){return this.ptys.get(e)}attach(e,t,n){const r=this.ptys.get(e);if(!r)return;let s;return r.eventListeners.add(t),s=n?r.eventHistory.sliceAfter((e=>e.eventId===n)):r.eventHistory.toArray(),{events:s}}detach(e,t){const n=this.ptys.get(e);n&&n.eventListeners.delete(t)}sendInput(e,t){const n=this.ptys.get(e);return!!n&&(n.pty.write(t.toString("utf-8")),!0)}resize(e,t,n){const r=this.ptys.get(e);return!!r&&(r.pty.resize(t,n),r.cols=t,r.rows=n,rt.debug(this.ctx,"PTY resized",{id:e,cols:t,rows:n}),!0)}list(){return Array.from(this.ptys.values()).map((e=>({id:e.id,shell:e.shell,cwd:e.cwd,cols:e.cols,rows:e.rows,pid:e.pty.pid})))}terminate(e){const t=this.ptys.get(e);return!!t&&(rt.info(this.ctx,"Terminating PTY",{id:e}),t.pty.kill(),this.ptys.delete(e),!0)}notifyListeners(e,t){for(const n of e.eventListeners)try{n(t)}catch(t){rt.error(this.ctx,"Error notifying PTY listener",{id:e.id,error:t})}}dispose(){rt.info(this.ctx,"Disposing all PTY instances",{count:this.ptys.size});for(const e of this.ptys.values())try{e.pty.kill()}catch(t){rt.error(this.ctx,"Error killing PTY during disposal",{id:e.id,error:t})}this.ptys.clear()}}const it=(0,c.h)("exec-daemon");class ot{async open(e,t){}async getDiagnostics(e,t){return[]}}class at{async getCodebaseReference(){}}class ct{async requestApproval(){return{approved:!0}}}class lt{async load(e){return new Ke.i9({})}async loadClient(e,t,n){throw new Error("MCP client loading not supported - MCP is disabled")}}class dt{shouldBlockRead(e){return Promise.resolve(!1)}shouldBlockWrite(e,t,n){return Promise.resolve(!1)}shouldBlockShellCommand(e,t,n,r){return Promise.resolve({kind:"allow",policy:r??{type:"insecure_none"}})}shouldBlockMcp(e,t){return Promise.resolve(!1)}addToAllowList(e,t,n){return Promise.resolve()}addToDenyList(e,t,n){return Promise.resolve()}}var ut=n("../../node_modules/.pnpm/@bufbuild+protobuf@1.10.0/node_modules/@bufbuild/protobuf/dist/esm/service-type.js");const ht={typeName:"agent.v1.ControlService",methods:{ping:{name:"Ping",I:w,O:y,kind:ut.I.Unary},exec:{name:"Exec",I:v,O:b,kind:ut.I.ServerStreaming},listDirectory:{name:"ListDirectory",I:k,O:x,kind:ut.I.Unary},readTextFile:{name:"ReadTextFile",I:P,O:_,kind:ut.I.Unary},writeTextFile:{name:"WriteTextFile",I,O:A,kind:ut.I.Unary},readBinaryFile:{name:"ReadBinaryFile",I:F,O:D,kind:ut.I.Unary},writeBinaryFile:{name:"WriteBinaryFile",I:R,O:L,kind:ut.I.Unary},getDiff:{name:"GetDiff",I:te.Vq,O:te.df,kind:ut.I.Unary},getWorkspaceChangesHash:{name:"GetWorkspaceChangesHash",I:N,O:U,kind:ut.I.Unary},refreshGithubAccessToken:{name:"RefreshGithubAccessToken",I:O,O:$,kind:ut.I.Unary},warmRemoteAccessServer:{name:"WarmRemoteAccessServer",I:M,O:B,kind:ut.I.Unary},listArtifacts:{name:"ListArtifacts",I:J,O:j,kind:ut.I.Unary},uploadArtifacts:{name:"UploadArtifacts",I:H,O:Q,kind:ut.I.Unary},getMcpRefreshTokens:{name:"GetMcpRefreshTokens",I:Y,O:K,kind:ut.I.Unary},updateEnvironmentVariables:{name:"UpdateEnvironmentVariables",I:V,O:X,kind:ut.I.Unary}}},mt={typeName:"agent.v1.ExecService",methods:{exec:{name:"Exec",I:pe.Ye,O:ge,kind:ut.I.ServerStreaming}}};class ft extends p.Q{id="";method="";data=new Uint8Array(0);kind=pt.UNSPECIFIED;error="";constructor(e){super(),f.C.util.initPartial(e,this)}static runtime=f.C;static typeName="agent.v1.Frame";static fields=f.C.util.newFieldList((()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"method",kind:"scalar",T:9},{no:3,name:"data",kind:"scalar",T:12},{no:4,name:"kind",kind:"enum",T:f.C.getEnumType(pt)},{no:5,name:"error",kind:"scalar",T:9}]));static fromBinary(e,t){return(new ft).fromBinary(e,t)}static fromJson(e,t){return(new ft).fromJson(e,t)}static fromJsonString(e,t){return(new ft).fromJsonString(e,t)}static equals(e,t){return f.C.util.equals(ft,e,t)}}var pt;!function(e){e[e.UNSPECIFIED=0]="UNSPECIFIED",e[e.REQUEST=1]="REQUEST",e[e.RESPONSE=2]="RESPONSE",e[e.ERROR=3]="ERROR"}(pt||(pt={})),f.C.util.setEnumType(pt,"agent.v1.Frame.Kind",[{no:0,name:"KIND_UNSPECIFIED"},{no:1,name:"KIND_REQUEST"},{no:2,name:"KIND_RESPONSE"},{no:3,name:"KIND_ERROR"}]);class gt extends p.Q{constructor(e){super(),f.C.util.initPartial(e,this)}static runtime=f.C;static typeName="agent.v1.Empty";static fields=f.C.util.newFieldList((()=>[]));static fromBinary(e,t){return(new gt).fromBinary(e,t)}static fromJson(e,t){return(new gt).fromJson(e,t)}static fromJsonString(e,t){return(new gt).fromJsonString(e,t)}static equals(e,t){return f.C.util.equals(gt,e,t)}}class wt extends p.Q{constructor(e){super(),f.C.util.initPartial(e,this)}static runtime=f.C;static typeName="agent.v1.ClaimWorkerRequest";static fields=f.C.util.newFieldList((()=>[]));static fromBinary(e,t){return(new wt).fromBinary(e,t)}static fromJson(e,t){return(new wt).fromJson(e,t)}static fromJsonString(e,t){return(new wt).fromJsonString(e,t)}static equals(e,t){return f.C.util.equals(wt,e,t)}}const yt={typeName:"agent.v1.PrivateWorkerBridgeExternalService",methods:{connect:{name:"Connect",I:ft,O:ft,kind:ut.I.BiDiStreaming}}},vt={typeName:"agent.v1.LifecycleService",methods:{resetInstance:{name:"ResetInstance",I:gt,O:gt,kind:ut.I.Unary},renewInstance:{name:"RenewInstance",I:gt,O:gt,kind:ut.I.Unary},claimWorker:{name:"ClaimWorker",I:wt,O:gt,kind:ut.I.Unary}}};var bt=n("../../node_modules/.pnpm/@connectrpc+connect@1.6.1_patch_hash=a4b9a5e69295313832387f25b708426bcf53041a2f50bc7b95_a276813e7efa8e1efb8a7b0efc1d56a0/node_modules/@connectrpc/connect/dist/esm/promise-client.js"),Et=n("../../node_modules/.pnpm/@connectrpc+connect@1.6.1_patch_hash=a4b9a5e69295313832387f25b708426bcf53041a2f50bc7b95_a276813e7efa8e1efb8a7b0efc1d56a0/node_modules/@connectrpc/connect/dist/esm/protocol/async-iterable.js"),Ct=n("../../node_modules/.pnpm/@connectrpc+connect-node@1.6.1_@bufbuild+protobuf@1.10.0_@connectrpc+connect@1.6.1_patc_5282c1319f527254b0f6f6e22c5be0c8/node_modules/@connectrpc/connect-node/dist/esm/index.js"),St=n("./src/utils/command-name.ts"),kt=function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))},xt=function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,n=e[Symbol.asyncIterator];return n?n.call(e):(e="function"==typeof __values?__values(e):e[Symbol.iterator](),t={},r("next"),r("throw"),r("return"),t[Symbol.asyncIterator]=function(){return this},t);function r(n){t[n]=e[n]&&function(t){return new Promise((function(r,s){!function(e,t,n,r){Promise.resolve(r).then((function(t){e({value:t,done:n})}),t)}(r,s,(t=e[n](t)).done,t.value)}))}}};const Tt=(0,c.h)("bridge-client");class Pt{constructor(e,t,n,r,s){this.ctx=e,this._isConnected=!1,this._isClaimed=!1,this.sessionManager=new Ct.gE(t.bridgeUrl,{pingIntervalMs:5e3,pingTimeoutMs:5e3},{rejectUnauthorized:!1,settings:{maxFrameSize:16777215,initialWindowSize:1048576,maxHeaderListSize:65536}});const i=t.hostHeader?e=>n=>kt(this,void 0,void 0,(function*(){return n.header.set("host",t.hostHeader),Tt.debug(this.ctx,"Setting host header for ALB routing",{hostHeader:t.hostHeader}),e(n)})):void 0,o=(0,Ct.wQ)(Object.assign({baseUrl:t.bridgeUrl,httpVersion:"2",sessionManager:this.sessionManager,nodeOptions:Object.assign(Object.assign({},t.httpsProxy&&{agent:new Me.HttpsProxyAgent(t.httpsProxy)}),{rejectUnauthorized:!1,settings:{maxFrameSize:16777215,initialWindowSize:1048576,maxHeaderListSize:65536}})},i&&{interceptors:[i]}));this.client=(0,bt.UU)(yt,o),this.execServer=new ye(e,n);const a=new ee(e);this.controlServer=new me(r,s,a),this.workerId=(0,l.randomUUID)(),Tt.info(e,"Generated initial worker ID",{workerId:this.workerId}),this.serviceHandlers=new Map([["agent.v1.ControlService",{service:ht,server:this.controlServer,streamingMethods:new Set(["Exec"])}],["agent.v1.ExecService",{service:mt,server:this.execServer,streamingMethods:new Set(["Exec"])}],["agent.v1.LifecycleService",{service:vt,server:{resetInstance:(e,t)=>kt(this,void 0,void 0,(function*(){return Tt.info(this.ctx,"Worker resetting, clearing claim state",{wasClaimed:this._isClaimed}),this._isClaimed=!1,this.renewWorkerId(),new gt})),renewInstance:(e,t)=>kt(this,void 0,void 0,(function*(){return setTimeout((()=>process.exit(0)),5e3),new gt})),claimWorker:(e,t)=>kt(this,void 0,void 0,(function*(){return Tt.info(this.ctx,"Worker claimed by background composer"),this._isClaimed=!0,new gt}))}}]]),this.callOptions={headers:Object.assign({authorization:`Bearer ${t.authToken}`,"x-working-directory":t.workingDirectory,"x-repository-url":t.repositoryUrl,"x-worker-id":this.workerId,"x-ghost-mode":t.ghostMode?"true":"false"},t.labels&&t.labels.length>0&&{"x-worker-labels":JSON.stringify(t.labels)})}}renewWorkerId(){var e;const t=this.workerId;this.workerId=(0,l.randomUUID)(),Tt.info(this.ctx,"Renewed worker ID",{oldWorkerId:t,newWorkerId:this.workerId}),this.callOptions.headers["x-worker-id"]=this.workerId,null===(e=this.streamController)||void 0===e||e.abort()}start(){return kt(this,void 0,void 0,(function*(){this.stopController=new AbortController;let e=0;for(;!this.stopController.signal.aborted;)try{Tt.info(this.ctx,"Starting bridge connection attempt",{retryCount:e}),yield this.runBridge(),Tt.warn(this.ctx,"Bridge connection closed, will reconnect"),e=0}catch(t){if(this.stopController.signal.aborted){Tt.info(this.ctx,"Bridge client stopped by request");break}if(t instanceof re.T&&(t.code===se.C.Unauthenticated||t.code===se.C.PermissionDenied)){Tt.error(this.ctx,"Auth error in bridge connection",t);const e=`\nYour authentication is invalid.\n\nPlease run '${(0,St.mf)()} logout' to clear stored credentials, then '${(0,St.mf)()} login' to authenticate again.\n`;process.stderr.write(e),process.exit(1)}const n=Math.min(1e3*Math.pow(2,e),1e4);Tt.error(this.ctx,"Bridge connection failed, retrying",t,{retryCount:e,nextRetryDelayMs:n}),e++,yield new Promise((e=>setTimeout(e,n)))}}))}stop(){var e,t,n;Tt.info(this.ctx,"Stopping bridge client"),null===(e=this.stopController)||void 0===e||e.abort(),null===(t=this.streamController)||void 0===t||t.abort(),null===(n=this.outgoingFrames)||void 0===n||n.close(),this._isConnected=!1}isConnected(){return this._isConnected}isClaimed(){return this._isClaimed}runBridge(){return kt(this,void 0,void 0,(function*(){var e,t,n,r,s,i;this.streamController=new AbortController,this.outgoingFrames=(0,Et.Jt)(),Tt.info(this.ctx,"Session state before connect",{state:this.sessionManager.state()});const o=this.client.connect(this.outgoingFrames,Object.assign(Object.assign({},this.callOptions),{signal:this.streamController.signal}));Tt.info(this.ctx,"Session state after connect",{state:this.sessionManager.state()});const a=setInterval((()=>{var e;const t=this.sessionManager.state();"closed"!==t&&"error"!==t||(Tt.warn(this.ctx,"Session state changed, aborting stream",{state:t}),this._isConnected=!1,null===(e=this.streamController)||void 0===e||e.abort())}),100);try{Tt.info(this.ctx,"Starting to iterate over stream frames");let s=0;this._isConnected=!0;try{for(var c,l=!0,d=xt(o);!(e=(c=yield d.next()).done);l=!0){r=c.value,l=!1;const e=r;s++,Tt.debug(this.ctx,"Received frame",{frameCount:s}),yield this.handleIncomingFrame(e)}}catch(e){t={error:e}}finally{try{l||e||!(n=d.return)||(yield n.call(d))}finally{if(t)throw t.error}}Tt.info(this.ctx,"Stream iteration ended normally",{frameCount:s})}catch(e){if(null===(s=this.streamController)||void 0===s?void 0:s.signal.aborted)return void Tt.info(this.ctx,"Stream aborted due to session close");throw Tt.error(this.ctx,"Stream error",e),e}finally{this._isConnected=!1,clearInterval(a),null===(i=this.outgoingFrames)||void 0===i||i.close()}}))}sendFrame(e){return kt(this,void 0,void 0,(function*(){if(!this.outgoingFrames)throw new Error("Bridge not connected");yield this.outgoingFrames.write(e)}))}sendErrorFrame(e,t){return kt(this,void 0,void 0,(function*(){yield this.sendFrame(new ft({id:e,kind:pt.ERROR,error:String(t)}))}))}handleIncomingFrame(e){return kt(this,void 0,void 0,(function*(){if(e.kind===pt.REQUEST)try{const[t,n,r]=e.method.split("/");yield this.handleServiceRequest(n,r,e.id,e.data)}catch(t){yield this.sendErrorFrame(e.id,t)}}))}handleServiceRequest(e,t,n,r){return kt(this,void 0,void 0,(function*(){var s,i,o,a,c,l;const d=this.serviceHandlers.get(e);if(!d)throw new Error(`Unknown service: ${e}`);const u=function(e,t){return Object.entries(e.methods).find((([e,n])=>n.name===t))}(d.service,t);if(!u)throw new Error(`Unknown method: ${t}`);const[h,m]=u,f=m.I.fromBinary(r),p=d.server,g=null!==(l=null===(c=d.streamingMethods)||void 0===c?void 0:c.has(t))&&void 0!==l&&l;try{if(g){const e=yield p[h](this.ctx,f);try{for(var w,y=!0,v=xt(e);!(s=(w=yield v.next()).done);y=!0){a=w.value,y=!1;const e=a;yield this.sendFrame(new ft({id:n,kind:pt.RESPONSE,data:new Uint8Array(e.toBinary())}))}}catch(e){i={error:e}}finally{try{y||s||!(o=v.return)||(yield o.call(v))}finally{if(i)throw i.error}}yield this.sendFrame(new ft({id:n,kind:pt.RESPONSE,data:new Uint8Array}))}else{const e=yield p[h](this.ctx,f);yield this.sendFrame(new ft({id:n,kind:pt.RESPONSE,data:new Uint8Array(e.toBinary())}))}}catch(e){yield this.sendErrorFrame(n,e)}}))}}var _t=function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))},It=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(r=Object.getOwnPropertySymbols(e);s<r.length;s++)t.indexOf(r[s])<0&&Object.prototype.propertyIsEnumerable.call(e,r[s])&&(n[r[s]]=e[r[s]])}return n};const At=(0,c.h)("exec-daemon-bridge");function Ft(e){return _t(this,void 0,void 0,(function*(){const{globalContext:t,bridgeUrl:n,authToken:r,workspacePath:s,rgPath:i,ghostMode:o,labels:c,repositoryUrl:l,httpsProxy:u}=e,m=It(e,["globalContext","bridgeUrl","authToken","workspacePath","rgPath","ghostMode","labels","repositoryUrl","httpsProxy"]),{resources:f,gitService:p,remoteAccessService:g}=yield async function(e){const{globalContext:t,workspacePath:n,rgPath:r,logLevel:s,isBrowserEnabled:i=!1,isCursorSelfControlEnabled:o=!1,isLspEnabled:c=!1,isCloudRulesEnabled:l=!1,isComputerUseEnabled:u=!1,isRecordScreenEnabled:m=!1,getThirdPartyExtensibilityEnabled:f=()=>!0,chromeExecutablePath:p,mcpConfig:g,gitService:w}=e,y=w??new Oe(t),v=new We,b=new st(t);let E;if(g)try{const e=JSON.parse(g);Object.keys(e).length>0&&(E=Ke.Vh.parse(e))}catch(e){it.error(t,"Failed to parse MCP config",e)}it.info(t,"Starting exec-daemon",{logLevel:s,workspacePath:n,browserEnabled:i,cursorSelfControlEnabled:o,mcpConfig:E,lspEnabled:c,cloudRulesEnabled:l,computerUseEnabled:u,recordScreenEnabled:m,chromeExecutablePath:p});const C=new Ye.xK,S=new ct,k=new Ye.$1(n);!function(e,t){try{(0,a.execFileSync)("which",[e],{stdio:"ignore"})}catch{it.error(t,`Binary not found: '${e}' is not a valid executable or not in PATH`),process.exit(1)}}(r,t);const x=new Ye.E1(C,r,void 0);if(m){try{(0,a.execFileSync)("which",["ffmpeg"],{stdio:"ignore"})}catch{it.warn(t,"ffmpeg not found in PATH - screen recording will not work. Please install ffmpeg to use the recordScreen tool.")}const n=e.recordScreenArtifactsDir??Ye.yQ,r=Ye.Oh;for(const e of[n,r])try{d.mkdirSync(e,{recursive:!0,mode:511}),d.chmodSync(e,511),it.info(t,`Recording directory created/verified: ${e}`)}catch(n){it.warn(t,`Failed to create ${e} directly, attempting with sudo`,{error:n instanceof Error?n.message:String(n)});try{(0,a.execFileSync)("sudo",["mkdir","-p",e],{stdio:"ignore"}),(0,a.execFileSync)("sudo",["chmod","777",e],{stdio:"ignore"}),it.info(t,`Recording directory created with sudo: ${e}`)}catch(n){it.error(t,`Failed to create recording directory ${e} - screen recording may not work`,{error:n instanceof Error?n.message:String(n)})}}}if(e.isGenerateImageEnabled){const e=h.join(Ye.yQ,"assets");try{d.mkdirSync(e,{recursive:!0,mode:511}),d.chmodSync(e,511),it.info(t,`Artifacts assets directory created/verified: ${e}`)}catch(n){it.warn(t,`Failed to create ${e} directly, attempting with sudo`,{error:n instanceof Error?n.message:String(n)});try{(0,a.execFileSync)("sudo",["mkdir","-p",e],{stdio:"ignore"}),(0,a.execFileSync)("sudo",["chmod","777",e],{stdio:"ignore"}),it.info(t,`Artifacts assets directory created with sudo: ${e}`)}catch(n){it.error(t,`Failed to create artifacts assets directory ${e} - generated images may not work`,{error:n instanceof Error?n.message:String(n)})}}}try{d.mkdirSync(Ye.c6,{recursive:!0,mode:511}),d.chmodSync(Ye.c6,511),it.info(t,`Logs directory created/verified: ${Ye.c6}`)}catch(e){it.warn(t,`Failed to create ${Ye.c6} directly, attempting with sudo`,{error:e instanceof Error?e.message:String(e)});try{(0,a.execFileSync)("sudo",["mkdir","-p",Ye.c6],{stdio:"ignore"}),(0,a.execFileSync)("sudo",["chmod","777",Ye.c6],{stdio:"ignore"}),it.info(t,`Logs directory created with sudo: ${Ye.c6}`)}catch(e){it.error(t,`Failed to create logs directory ${Ye.c6} - debug subagent logging may not work`,{error:e instanceof Error?e.message:String(e)})}}const T=c?new Ze(t,n):new ot,P=new at,_=new lt,I={};if(void 0!==E)for(const[e,n]of Object.entries(E.mcpServers))try{const r={async loadTokens(){},async saveTokens(){},async loadClientInformation(){},async saveClientInformation(){}};I[e]=await(0,Ke.qV)(t,e,n,r)}catch(n){it.error(t,`Failed to load MCP server "${e}"`,n)}const A=(Object.keys(I).length>0?new Ye.$p(_,I):_).load(t),F=new Ye.KO(t,C,n,r,!0,f,void 0),D=new Ye.EV(t,[n],ve.homedir(),void 0),R=new Ye.Px([F,D]),L=l?new Ye.TC(t,n,void 0):void 0,N=new Ye.o_([new Ye.Vz(n,f),new Ye.di(R)]),U=new dt,O=(0,ze.Xq)(n),$=await A,M=new Ke.uz($),B={rgPath:r,executeIndexedGrep:void 0},J=(0,Qe.Ve)(O),G=new Qe.IF,q=new Qe.gY(G,J),j=await q.load(),H=new Qe.HG(j),W=(0,Ve.Fn)(),z=(0,Ve.fi)();let Q;if(u){const n=(0,Ye.pv)(e.recordScreenDisplay);if((0,Ye.PD)())try{it.info(t,"Waiting for X11 display to become available",{display:n}),await(0,Ye.Jt)(n),it.info(t,"X11 display is ready",{display:n});const e=(0,Ye.L_)(n),r=(0,Ye.LI)(n);Q=new Ye.iT({displayNum:r,resolution:e.resolution}),it.info(t,"Computer use enabled - X11ComputerUseExecutor created",{display:n,resolution:e.resolutionString})}catch(e){it.error(t,"Failed to detect display for computer use - disabling",e)}else it.info(t,"X11 is not installed (xdpyinfo not found) - skipping computer use setup",{display:n})}it.info(t,"loading resource provider",{computerUseEnabled:u,computerUseRunning:void 0!==Q});try{const r=new Ye.Dv({pendingDecisionStore:S,fileChangeTracker:k,gitExecutor:C,ignoreService:x,grepProvider:B,permissionsService:U,workspacePaths:[n],diagnosticsProvider:T,mcpLease:M,cursorRulesService:R,cloudRulesService:L,subagentsService:N,repositoryProvider:P,projectDir:O,shellManager:void 0,_sandboxPolicyResolver:void 0,_defaultSandboxPolicy:{type:"insecure_none"},mcpFileOutputThresholdBytes:void 0,terminalExecutor:W,computerUseExecutor:Q,enableRecordScreen:m,recordScreenArtifactsDir:e.recordScreenArtifactsDir??Ye.yQ,recordScreenDisplay:(0,Ye.pv)(e.recordScreenDisplay),artifactsFolder:Ye.yQ});if(it.info(t,"resource provider loaded",{hooksConfig:j}),m&&u&&Q){const e=r.getRecordScreenExecutor();e&&(e.setOnRecordingStarted((e=>{it.info(t,"Recording started, connecting InputEventLogger to X11Executor"),Q.setInputEventLogger(e)})),e.setOnRecordingStopped((()=>{it.info(t,"Recording stopped, disconnecting InputEventLogger from X11Executor"),Q.setInputEventLogger(void 0)})),it.info(t,"InputEventLogger wiring configured for polished recordings"))}const s={cursor_version:"1.0.0",user_email:null},i=new Qe.WL(j,O,s,z,e.promptHookClient);it.info(t,"Exec-daemon loaded hook executor",{hasUserHooks:!!j.userHooks,hasProjectHooks:!!j.projectHooks});const o=new Qe.ae(r,i,(()=>({conversation_id:"",generation_id:"",model:"unknown"})),M,void 0,void 0,H);it.info(t,"Exec-daemon loaded resources");for(const[e,n]of o.entries())it.info(t,"Resource:",{symbol:e.symbol}),it.info(t,"Implementation:",{implementation:n});return{resources:o,gitService:y,remoteAccessService:v,ptyManager:b,hookExecutor:i}}catch(e){throw it.error(t,"error creating resource provider",{error:e instanceof Error?e.message:String(e)}),e}}(Object.assign({globalContext:t,workspacePath:s,rgPath:i},m)),w=n.includes("api2.cursor.sh"),y=w?n.replace("api2.cursor.sh","api2direct.cursor.sh"):n,v=w?"api2.cursor.sh":void 0;let b;if(At.info(t,"Starting in bridge mode",{bridgeUrl:y,originalBridgeUrl:n,hostHeader:v,workspacePath:s,ghostMode:o,labels:null!=c?c:[]}),l)b=l;else{try{b=(0,a.execFileSync)("git",["config","--get","remote.origin.url"],{cwd:s,encoding:"utf8"}).trim()}catch(e){throw new Error(`Failed to get repository URL - required for bridge mode: ${e instanceof Error?e.message:String(e)}`)}if(!b)throw new Error("Repository URL is empty - required for bridge mode")}const E=new Pt(t,{bridgeUrl:y,authToken:r,httpsProxy:u||process.env.HTTPS_PROXY||process.env.https_proxy,workingDirectory:s,repositoryUrl:b,hostHeader:v,ghostMode:o,labels:c},f,p,g),C=E.start();return{stop:()=>_t(this,void 0,void 0,(function*(){E.stop(),yield C})),healthStatus:{isConnected:()=>E.isConnected(),isClaimed:()=>E.isClaimed()}}}))}},"./src/bridge/management-server.ts":(e,t,n)=>{"use strict";n.d(t,{v:()=>c});var r=n("../../node_modules/.pnpm/@hono+node-server@1.19.9_hono@4.11.4/node_modules/@hono/node-server/dist/index.mjs"),s=n("../../node_modules/.pnpm/hono@4.11.4/node_modules/hono/dist/index.js"),i=n("../../node_modules/.pnpm/hono@4.11.4/node_modules/hono/dist/middleware/logger/index.js"),o=n("./src/console-io.ts"),a=n("./src/debug.ts");function c(e){const{address:t,healthStatus:n}=e,{host:c,port:l}=function(e){const t=e.lastIndexOf(":");if(-1===t)throw new Error(`Invalid address format: ${e}. Expected host:port or :port`);const n=e.slice(0,t)||"0.0.0.0",r=e.slice(t+1),s=parseInt(r,10);if(Number.isNaN(s)||s<0||s>65535)throw new Error(`Invalid port: ${r}`);return{host:n,port:s}}(t),d=function(e){const t=new s.$;return t.use("*",(0,i.v)((e=>{(0,a.debugLog)("management-server:request",{message:e})}))),t.get("/healthz",(e=>{const t={status:"ok",timestamp:(new Date).toISOString()};return(0,a.debugLog)("management-server:healthz",t),e.json(t,200)})),t.get("/readyz",(t=>{const n=e.isConnected(),r=e.isClaimed(),s=n&&!r,i={status:s?"ok":"not_ready",connected:n,claimed:r,timestamp:(new Date).toISOString()},o=s?200:503;return(0,a.debugLog)("management-server:readyz",Object.assign(Object.assign({},i),{statusCode:o})),t.json(i,o)})),t}(n),u=(0,r.wX)({fetch:d.fetch,port:l,hostname:c});return(0,o.p2)(`Management server listening on ${c}:${l}\n`),(0,a.debugLog)("management-server:started",{host:c,port:l,address:t}),u.on("error",(e=>{(0,o.p2)(`Management server error: ${e.message}\n`),(0,a.debugLog)("management-server:error",{error:e.message})})),{stop:()=>new Promise(((e,t)=>{u.close((n=>{n?((0,a.debugLog)("management-server:stop-error",{error:n.message}),t(n)):((0,a.debugLog)("management-server:stopped",{}),e())}))}))}}},"./src/commands/worker-mode.ts":(e,t,n)=>{"use strict";n.a(e,(async(e,r)=>{try{n.r(t),n.d(t,{handleWorkerMode:()=>P});var s=n("node:console"),i=n("node:fs"),o=n("node:path"),a=n.n(o),c=n("../context/dist/index.js"),l=n("../proto/dist/generated/aiserver/v1/dashboard_connect.js"),d=n("../../node_modules/.pnpm/@connectrpc+connect@1.6.1_patch_hash=a4b9a5e69295313832387f25b708426bcf53041a2f50bc7b95_a276813e7efa8e1efb8a7b0efc1d56a0/node_modules/@connectrpc/connect/dist/esm/promise-client.js"),u=n("../../node_modules/.pnpm/@connectrpc+connect-node@1.6.1_@bufbuild+protobuf@1.10.0_@connectrpc+connect@1.6.1_patc_5282c1319f527254b0f6f6e22c5be0c8/node_modules/@connectrpc/connect-node/dist/esm/index.js"),h=n("./src/api-key-auth.ts"),m=n("./src/bridge/bridge.ts"),f=n("./src/bridge/management-server.ts"),p=n("./src/constants.ts"),g=n("./src/debug.ts"),w=n("./src/onboarding.tsx"),y=n("./src/privacy.ts"),v=n("./src/utils/command-name.ts"),b=n("./src/utils/git.ts"),E=e([w]);w=(E.then?(await E)():E)[0];var C=function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};const S=(0,c.h)("worker-mode");function k(e,t,n){const r=[...t];if(n){const t=(0,b.vP)(n);if(t){const n={key:"repo",value:t};r.some((e=>e.key===n.key&&e.value===n.value))?(0,g.debugLog)("worker-mode:repo-label-duplicate",{ownerRepo:t,message:"Skipped duplicate repo label"}):(r.push(n),S.info(e,"Derived repo label from git origin",{repo:t}),(0,g.debugLog)("worker-mode:repo-label",{ownerRepo:t}))}else(0,g.debugLog)("worker-mode:repo-label-parse-failed",{message:"Could not extract owner/repo from origin URL"})}else(0,g.debugLog)("worker-mode:no-origin-url",{message:"No git origin URL found"});return r}function x(e,t,n){return C(this,void 0,void 0,(function*(){try{const e=e=>n=>C(this,void 0,void 0,(function*(){return n.header.set("authorization",`Bearer ${t}`),e(n)})),r=n.endsWith("cursor.sh")?"https://api2.cursor.sh":n,s=(0,u.wQ)({baseUrl:r,httpVersion:"1.1",interceptors:[e],nodeOptions:{rejectUnauthorized:!p.Cu}}),i=(0,d.UU)(l.I,s),o=yield i.getUserPrivacyMode({inferredPrivacyMode:0}),a=(0,y.e)(o.privacyMode);return(0,g.debugLog)("worker-mode:privacy",{privacyMode:o.privacyMode,ghostMode:a}),a}catch(t){return S.warn(e,"Could not fetch privacy mode, defaulting to ghost mode",{error:t instanceof Error?t.message:String(t)}),(0,g.debugLog)("worker-mode:privacy-error",{error:t instanceof Error?t.message:String(t)}),!0}}))}function T(e,t){if(!t)return process.cwd();const n=a().resolve(t);return(0,i.existsSync)(n)||(S.error(e,"Worker directory does not exist",{workspacePath:n}),process.exit(1)),(0,i.statSync)(n).isDirectory()||(S.error(e,"Worker directory is not a directory",{workspacePath:n}),process.exit(1)),process.chdir(n),S.info(e,"Changed working directory",{workspacePath:n}),n}function P(e,t,n){return C(this,void 0,void 0,(function*(){var r,i;const o=new s.Console({stdout:process.stdout,stderr:process.stderr}),a=(0,c.bu)({console:o}),l=(0,c.q6)().withName("worker-mode").with(c._O,a);let d;if(S.info(l,"Starting in worker mode",{bridgeUrl:e}),n.labels&&n.labels.length>0&&S.info(l,"Worker labels",{labels:n.labels.map((e=>`${e.key}=${e.value}`)).join(", ")}),(0,g.debugLog)("worker-mode",{bridgeUrl:e,labels:null!==(r=n.labels)&&void 0!==r?r:[]}),n.authToken){const{isAuthenticated:e}=yield(0,h.D)(t,{authToken:n.authToken});e&&(d=n.authToken,S.info(l,"Using provided authentication token for worker mode"))}if(!d&&(n.apiKey||process.env.CURSOR_API_KEY)){S.info(l,"Authenticating with API key...");const{isAuthenticated:e,usingApiKeyFromEnv:r}=yield(0,h.T)(t,{apiKey:n.apiKey,endpoint:n.endpoint});e&&(d=yield t.getAccessToken(),S.info(l,"Authenticated with API key",{fromEnv:r}))}d||((yield(0,w.h4)(t,w.hT.LOGIN))||(S.error(l,"Authentication required for worker mode",void 0,{hint:`Please run '${(0,v.mf)()} login', or provide an API key with --api-key or CURSOR_API_KEY.`}),process.exit(1)),d=yield t.getAccessToken(),d||(S.error(l,"Failed to retrieve authentication token",void 0,{hint:`Please run '${(0,v.mf)()} login'.`}),process.exit(1)));const u=T(l,n.workerDir),p=n.rgPathFactory(),y=(0,b.MF)(u),E=k(l,null!==(i=n.labels)&&void 0!==i?i:[],y);if(!d)throw new Error("Unexpected error: authToken should be defined");S.info(l,"Fetching user privacy mode...");const P=yield x(l,d,n.endpoint);S.info(l,"User ghost mode",{ghostMode:P,bridgeType:P?"privacy":"non-privacy"}),(0,g.debugLog)("worker-mode:config",{bridgeUrl:e,workspacePath:u,ghostMode:P,labels:E,browserEnabled:process.env.EXEC_DAEMON_BROWSER_ENABLED||"false",mcpEnabled:process.env.EXEC_DAEMON_MCP_ENABLED||"false",lspEnabled:process.env.EXEC_DAEMON_LSP_ENABLED||"false",cloudRulesEnabled:process.env.EXEC_DAEMON_CLOUD_RULES_ENABLED||"false"});try{S.info(l,"Starting exec-daemon in bridge mode...");const t=yield(0,m.Q)({globalContext:l,bridgeUrl:e,authToken:d,workspacePath:u,rgPath:p,ghostMode:P,labels:E,repositoryUrl:y,isBrowserEnabled:"true"===process.env.EXEC_DAEMON_BROWSER_ENABLED,isCursorSelfControlEnabled:"true"===process.env.EXEC_DAEMON_CURSOR_SELF_CONTROL_ENABLED,isMcpEnabled:"true"===process.env.EXEC_DAEMON_MCP_ENABLED,isLspEnabled:"true"===process.env.EXEC_DAEMON_LSP_ENABLED,isCloudRulesEnabled:"true"===process.env.EXEC_DAEMON_CLOUD_RULES_ENABLED,getClaudeMdEnabled:()=>"false"!==process.env.EXEC_DAEMON_CLAUDE_MD_ENABLED,chromeExecutablePath:process.env.EXEC_DAEMON_CHROME_EXECUTABLE_PATH,mcpConfigDir:process.env.EXEC_DAEMON_CONFIG_DIR,httpsProxy:process.env.HTTPS_PROXY||process.env.https_proxy});let r;n.managementAddr&&(S.info(l,"Starting management server",{address:n.managementAddr}),r=(0,f.v)({address:n.managementAddr,healthStatus:t.healthStatus}));const s=()=>C(this,void 0,void 0,(function*(){S.info(l,"Received shutdown signal, stopping bridge client..."),(0,g.debugLog)("worker-mode:shutdown",{reason:"signal"}),r&&(yield r.stop()),yield t.stop(),process.exit(0)}));process.on("SIGINT",s),process.on("SIGTERM",s),yield new Promise((()=>{}))}catch(e){S.error(l,"Error starting exec-daemon",e),(0,g.debugLog)("worker-mode:error",{error:e instanceof Error?e.stack:String(e)}),process.exit(1)}}))}r()}catch(_){r(_)}}))}};