try{!function(){var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:{},t=(new e.Error).stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="15ca6b3b-d7eb-499a-af97-9e9ce5d2f3af",e._sentryDebugIdIdentifier="sentry-dbid-15ca6b3b-d7eb-499a-af97-9e9ce5d2f3af")}()}catch(e){}!function(){try{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:{}).SENTRY_RELEASE={id:"agent-cli@2026.02.13-41ac335"}}catch(e){}}(),exports.id=225,exports.ids=[225],exports.modules={"../agent-transcript/dist/index.js":(e,t,i)=>{i.d(t,{O2:()=>d,YF:()=>k,sh:()=>u,Jb:()=>D});var o,n=i("../agent-kv/dist/index.js"),r=i("../context/dist/index.js"),s=i("../proto/dist/generated/agent/v1/agent_pb.js"),a=i("../utils/dist/index.js");i("../proto/dist/generated/aiserver/v1/chat_pb.js"),function(e){e.INTERNAL="INTERNAL",e.EXTERNAL="EXTERNAL"}(o||(o={}));var c=function(e,t,i){if(null!=t){if("object"!=typeof t&&"function"!=typeof t)throw new TypeError("Object expected.");var o,n;if(i){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");o=t[Symbol.asyncDispose]}if(void 0===o){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");o=t[Symbol.dispose],i&&(n=o)}if("function"!=typeof o)throw new TypeError("Object not disposable.");n&&(o=function(){try{n.call(this)}catch(e){return Promise.reject(e)}}),e.stack.push({value:t,dispose:o,async:i})}else i&&e.stack.push({async:!0});return t},l=function(e){return function(t){function i(i){t.error=t.hasError?new e(i,t.error,"An error was suppressed during disposal."):i,t.hasError=!0}var o,n=0;return function e(){for(;o=t.stack.pop();)try{if(!o.async&&1===n)return n=0,t.stack.push(o),Promise.resolve().then(e);if(o.dispose){var r=o.dispose.call(o.value);if(o.async)return n|=2,Promise.resolve(r).then(e,(function(t){return i(t),e()}))}else n|=1}catch(e){i(e)}if(1===n)return t.hasError?Promise.reject(t.error):Promise.resolve();if(t.hasError)throw t.error}()}}("function"==typeof SuppressedError?SuppressedError:function(e,t,i){var o=new Error(i);return o.name="SuppressedError",o.error=e,o.suppressed=t,o});const d=a.O2,u=a.sh;function h(e,t){return t instanceof Uint8Array?{__type:"Uint8Array",hex:(i=t,Array.from(i).map((e=>e.toString(16).padStart(2,"0"))).join(""))}:"bigint"==typeof t?t.toString():t;var i}function m(e,t){return t&&"object"==typeof t&&"Uint8Array"===t.__type&&"string"==typeof t.hex?function(e){const t=new Uint8Array(e.length/2);for(let i=0;i<e.length;i+=2)t[i/2]=parseInt(e.substring(i,i+2),16);return t}(t.hex):t}const g=new class{serialize(e){const t=JSON.stringify(e,h);return n.bO.serialize(t)}deserialize(e){const t=n.bO.deserialize(e);return JSON.parse(t,m)}},f=new n.cm(s.ConversationSummaryArchive);async function p(e,t,i){const o=[];for(const n of i){const i=await t.getBlob(e,n);if(i)try{const e=g.deserialize(i);o.push(e)}catch(e){}}return o}async function y(e,t,i){const o={stack:[],error:void 0,hasError:!1};try{const n=c(o,(0,r.VI)(e.withName("hydrateSummaryArchives")),!1);let s=0;const a=(0,r.OA)(n.ctx),l=[],d=await Promise.all(i.summaryArchives.map((async e=>{s++;const i=await t.getBlob(a,e);if(i)try{const e=f.deserialize(i);return s+=e.summarizedMessages.length,await p(a,t,e.summarizedMessages)}catch(e){}return[]})));n.span.setAttribute("getBlobCount",s);for(const e of d)l.push(...e);n[Symbol.dispose]();const u=c(o,(0,r.VI)(e.withName("hydratePromptMessages")),!1),h=await p(a,t,i.rootPromptMessagesJson);u.span.setAttribute("getBlobCount",i.rootPromptMessagesJson.length);const m=h.filter((e=>"system"!==e.role&&!function(e){var t;const i=e.providerOptions;return!0===(null===(t=null==i?void 0:i.cursor)||void 0===t?void 0:t.isSummary)}(e)));return l.push(...m),l}catch(e){o.error=e,o.hasError=!0}finally{l(o)}}function b(e,t){switch(e.type){case"text":return t?w(e.text):e.text;case"image":return"[Image]";case"file":return e.filename?`[File: ${e.filename}]`:"[File]";case"reasoning":return`[Thinking] ${e.text}`;case"redacted-reasoning":return"[Thinking]";case"tool-call":return`[Tool call] ${e.toolName}${function(e){if(null==e)return"";if("object"!=typeof e)return String(e);const t=e,i=Object.entries(t);return 0===i.length?"":`\n${i.map((([e,t])=>{let i;return i="string"==typeof t?t:"object"==typeof t&&null!==t?JSON.stringify(t):String(t),`  ${e}: ${i}`})).join("\n")}`}(e.args)}`;case"tool-result":return`[Tool result] ${e.toolName}`;default:return""}}const v=["user_info","rules","open_and_recently_viewed_files","system_reminder"];function w(e){let t=e;for(const e of v){const i=new RegExp(`<${e}>[\\s\\S]*?</${e}>`,"g");t=t.replace(i,"")}return t.replace(/\n{3,}/g,"\n\n").trim()}function S(e){return e.replace(/<think>[\s\S]*?<\/think>/gi,"").replace(/<thinking>[\s\S]*?<\/thinking>/gi,"").replace(/\n{3,}/g,"\n\n").trim()}function A(e,t,i){if(void 0===e)return"";if("string"==typeof e){const o=t?w(e):e;return i?S(o):o}return e.map((e=>{if(i&&"text"===e.type){const i=S(t?w(e.text):e.text);return b(Object.assign(Object.assign({},e),{text:i}),!1)}return b(e,t)})).filter(Boolean).join("\n")}function L(e){let t=e.filter((e=>"system"!==e.role));t.length>=2&&"user"===t[0].role&&"user"===t[1].role&&(t=t.slice(1));const i=[];for(const e of t){const t="user"===e.role,o="assistant"===e.role,n=A(e.content,t,o);n.trim()&&("tool"===e.role?i.push(n):i.push(`${e.role}:\n${n}`))}return i.join("\n\n")}function N(e,t){const i={role:e.role},o=e.content;if("string"==typeof o){const n=t?w(o):o,r="assistant"===e.role?S(n):n;r.trim()&&(i.text=r)}else if(Array.isArray(o)){const n=[],r=[],s=[];let a;for(const i of o)switch(i.type){case"text":{const o=t?w(i.text):i.text,r="assistant"===e.role?S(o):o;r.trim()&&n.push(r);break}case"reasoning":i.text.trim()&&r.push(i.text);break;case"redacted-reasoning":r.push("[REDACTED]");break;case"image":n.push("[Image]");break;case"file":n.push(i.filename?`[File: ${i.filename}]`:"[File]");break;case"tool-call":s.push({toolName:i.toolName,args:i.args});break;case"tool-result":a={toolName:i.toolName}}n.length>0&&(i.text=n.join("\n")),r.length>0&&(i.thinking=r.join("\n")),s.length>0&&(i.toolCalls=s),a&&(i.toolResult=a)}return i}async function D(e,t,i){return L(await y(e,t,i))}class k{projectDir;blobStore;writeFile;options;constructor(e,t,i,o={}){var n,r,s;this.projectDir=e,this.blobStore=t,this.writeFile=i,this.options={writeText:null===(n=o.writeText)||void 0===n||n,writeJson:null!==(r=o.writeJson)&&void 0!==r&&r,writeJsonl:null!==(s=o.writeJsonl)&&void 0!==s&&s}}async writeFromState(e,t,i){const o={stack:[],error:void 0,hasError:!1};try{const n=c(o,(0,r.VI)(e.withName("writeFromState")),!1);try{const e=await y(n.ctx,this.blobStore,t);if(0===e.length)return;const o=u(i),r=`${this.projectDir}/${d}/${o}`;if(this.options.writeText){const t=L(e);t.trim()&&await this.writeFile(`${r}.txt`,t)}if(this.options.writeJson){const i=function(e){let t=e.filter((e=>"system"!==e.role));t.length>=2&&"user"===t[0].role&&"user"===t[1].role&&(t=t.slice(1));const i=[];for(const e of t){const t=N(e,"user"===e.role);(t.text||t.thinking||t.toolCalls||t.toolResult)&&i.push(t)}return 0===i.length?"":JSON.stringify(i,null,2)}(e);if(i){const e=function(e){switch(e){case s.AgentMode.AGENT:return"agent";case s.AgentMode.ASK:return"ask";case s.AgentMode.PLAN:return"plan";case s.AgentMode.DEBUG:return"debug";case s.AgentMode.TRIAGE:return"triage";case s.AgentMode.PROJECT:return"project";case s.AgentMode.UNSPECIFIED:default:return"agent"}}(t.mode),o=JSON.stringify({mode:e,messages:JSON.parse(i)},null,2);await this.writeFile(`${r}.json`,o)}}if(this.options.writeJsonl){const t=function(e){let t=e.filter((e=>"system"!==e.role));t.length>=2&&"user"===t[0].role&&"user"===t[1].role&&(t=t.slice(1));const i=[];for(const e of t){const t=N(e,"user"===e.role),o=[];if(t.text&&o.push(t.text),t.thinking&&o.push(t.thinking),0===o.length)continue;const n=o.join("\n\n"),r={role:e.role,message:{content:[{type:"text",text:n}]}};i.push(JSON.stringify(r))}return i.join("\n")}(e);t&&await this.writeFile(`${r}.jsonl`,t)}}catch(e){console.error("[TranscriptStore] Failed to write transcript:",e)}}catch(e){o.error=e,o.hasError=!0}finally{l(o)}}}},"./src/cursor-blame/cli-commit-scoring.ts":(e,t,i)=>{i.r(t),i.d(t,{CliCommitScoringService:()=>w,parseGitDiff:()=>S});var o=i("node:child_process"),n=i("node:os"),r=i("node:path"),s=i("node:util"),a=i("../agent-analytics/dist/index.js"),c=i("../agent-analytics/dist/commit-scoring/index.js"),l=i("../agent-analytics/dist/node.js"),d=i("../proto/dist/generated/aiserver/v1/aiserver_pb.js"),u=i("./src/client.ts"),h=i("./src/debug.ts"),m=i("./src/statsig.ts"),g=i("./src/cursor-blame/format-lineage-callbacks.ts"),f=i("./src/cursor-blame/sqlite-adapter.ts"),p=function(e,t,i,o){return new(i||(i=Promise))((function(n,r){function s(e){try{c(o.next(e))}catch(e){r(e)}}function a(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))};const y=(0,s.promisify)(o.execFile),b=(0,r.join)((0,n.homedir)(),".cursor","ai-tracking","ai-code-tracking.db"),v={tabLinesAdded:0,tabLinesDeleted:0,composerLinesAdded:0,composerLinesDeleted:0,humanLinesAdded:0,humanLinesDeleted:0,blankLinesAdded:0,blankLinesDeleted:0,linesAdded:0,linesDeleted:0,changeIds:[]};class w{constructor(e){var t,i;this.options=e,this.pollInProgress=!1,this.storageInitPromise=null,this.aiServerClient=(0,u.t9)(e.credentialManager,{backendUrl:e.backendUrl,insecure:e.insecure,configProvider:e.configProvider}),this.gitOperations=new l.Z;const o=(0,f.$)();this.storage=new a.Ou(o,null!==(t=e.dbPath)&&void 0!==t?t:b),(0,h.debugLog)("commitScoring.init",{workspacePath:e.workspacePath,backendUrl:e.backendUrl,dbPath:null!==(i=e.dbPath)&&void 0!==i?i:b,insecure:!0===e.insecure})}startPolling(){this.ensureStorageReady().then((()=>this.loadOrInitTrackingStartTime())).catch((e=>(0,h.debugLog)("commitScoring.init.error",{error:e}))),this.scheduleNextPoll()}dispose(){return p(this,void 0,void 0,(function*(){this.pollingTimeoutId&&(clearTimeout(this.pollingTimeoutId),this.pollingTimeoutId=void 0),(0,h.debugLog)("commitScoring.dispose",{}),yield this.storage.close()}))}scoreRecentCommits(){return p(this,arguments,void 0,(function*(e=10,t){yield this.ensureStorageReady();const i=yield(0,a.f_)(this.gitOperations,[this.options.workspacePath]);for(const o of i){const i=yield(0,a.IG)(this.gitOperations,o,{limit:e});if(!i)continue;const{commits:n,user:r}=i;if(0===n.length)continue;const s=yield(0,a.pt)(this.gitOperations,o);for(const e of n)try{const i=yield this.getFullCommit(e,o);if(!i||0===i.diff.length){null==t||t({hash:e,message:null==i?void 0:i.message,date:null==i?void 0:i.date,repoName:s.repoName,branchName:s.branchName,author:r,score:v,aiLineRanges:new Map});continue}const n=yield this.detectAndPropagateFormatChanges(i,o);n>0&&(0,h.debugLog)("commitScoring.formatDetection.total",{commitHash:e,hashesAdded:n});const a=this.createGitOperationsWithStorage(o),l=i.date?new Date(i.date).getTime()+1e3:void 0,d=[...new Set(i.diff.flatMap((e=>[e.from,e.to].filter((e=>!!e&&"/dev/null"!==e)).map((e=>e.replace(/\\/g,"/"))))))],u=d.length>0?yield this.storage.getAiDeletedFiles(d,l):new Set,m=yield(0,c.fS)(i.diff,{normalizeLines:!0,gitOperations:a,repoRoot:o,commitHash:e,commitTimestamp:l,isAiDeletedFile:e=>u.has(e)});if(!m){null==t||t({hash:e,message:i.message,date:i.date,repoName:s.repoName,branchName:s.branchName,author:r,score:v,aiLineRanges:new Map});continue}null==t||t({hash:e,message:i.message,date:i.date,repoName:s.repoName,branchName:s.branchName,author:r,score:m,aiLineRanges:m.aiLineRanges})}catch(t){(0,h.debugLog)("commitScoring.scoreRecentCommits.error",{commitHash:e,error:t})}}}))}getMostRecentCommitHash(){return p(this,void 0,void 0,(function*(){const e=yield(0,a.f_)(this.gitOperations,[this.options.workspacePath]);if(0===e.length)return null;const t=e[0],i=yield(0,a.IG)(this.gitOperations,t,{limit:1});return i&&0!==i.commits.length?i.commits[0]:null}))}scoreCommit(e){return p(this,void 0,void 0,(function*(){yield this.ensureStorageReady();const t=yield(0,a.f_)(this.gitOperations,[this.options.workspacePath]);let i;for(const o of t)if(yield this.gitOperations.commitExists(o,e)){i=o;break}if(!i)return null;const o=yield(0,a.pt)(this.gitOperations,i),n=yield this.getFullCommit(e,i);if(!n||0===n.diff.length)return{hash:e,message:null==n?void 0:n.message,date:null==n?void 0:n.date,repoName:o.repoName,branchName:o.branchName,author:null==n?void 0:n.authorEmail,score:v,aiLineRanges:new Map};const r=yield this.detectAndPropagateFormatChanges(n,i);r>0&&(0,h.debugLog)("commitScoring.formatDetection.total",{commitHash:e,hashesAdded:r});const s=this.createGitOperationsWithStorage(i),l=n.date?new Date(n.date).getTime()+1e3:void 0,d=[...new Set(n.diff.flatMap((e=>[e.from,e.to].filter((e=>!!e&&"/dev/null"!==e)).map((e=>e.replace(/\\/g,"/"))))))],u=d.length>0?yield this.storage.getAiDeletedFiles(d,l):new Set,m=yield(0,c.fS)(n.diff,{normalizeLines:!0,gitOperations:s,repoRoot:i,commitHash:e,commitTimestamp:l,isAiDeletedFile:e=>u.has(e)});return m?{hash:e,message:n.message,date:n.date,repoName:o.repoName,branchName:o.branchName,author:n.authorEmail,score:m,aiLineRanges:m.aiLineRanges}:{hash:e,message:n.message,date:n.date,repoName:o.repoName,branchName:o.branchName,author:n.authorEmail,score:v,aiLineRanges:new Map}}))}scheduleNextPoll(){var e,t;this.pollingTimeoutId&&clearTimeout(this.pollingTimeoutId);const i=.1*(2*Math.random()-1),o=Math.floor(6e5*(1+i));this.pollingTimeoutId=setTimeout((()=>{this.pollingTimeoutId=void 0,this.pollAndScheduleNext()}),o),null===(t=(e=this.pollingTimeoutId).unref)||void 0===t||t.call(e)}pollAndScheduleNext(){return p(this,void 0,void 0,(function*(){if(this.pollInProgress)this.scheduleNextPoll();else{this.pollInProgress=!0;try{yield this.pollForNewCommits()}catch(e){(0,h.debugLog)("commitScoring.poll.error",{error:e})}finally{this.pollInProgress=!1,this.scheduleNextPoll()}}}))}pollForNewCommits(){return p(this,void 0,void 0,(function*(){yield this.ensureStorageReady();const e=yield(0,a.f_)(this.gitOperations,[this.options.workspacePath]);for(const t of e)try{const e=yield(0,a.IG)(this.gitOperations,t,{limit:10});if(!e)continue;for(const i of e.commits)yield this.scoreCommitIfNeeded(i,t).catch((e=>{(0,h.debugLog)("commitScoring.score.error",{commitHash:i,repoRoot:t,error:e})}))}catch(e){(0,h.debugLog)("commitScoring.repo.error",{repoRoot:t,error:e})}}))}scoreCommitIfNeeded(e,t){return p(this,void 0,void 0,(function*(){var i;const o=yield(0,a.pt)(this.gitOperations,t);if(!o.isPrimaryBranch&&(yield this.storage.areCommitsScored([{commitHash:e,branchName:null!==(i=o.branchName)&&void 0!==i?i:""}])).length>0)return;const n=yield this.getFullCommit(e,t);if(!n)return;const r=yield this.shouldScoreCommit(n,o.isPrimaryBranch);if(!r.shouldScore)return void(0,h.debugLog)("commitScoring.skip",{commitHash:e,reason:r.reason});const s=yield this.score(e,n,t,o);(0,h.debugLog)("commitScoring.scored",{commitHash:e,tabLinesAdded:s.tabLinesAdded,tabLinesDeleted:s.tabLinesDeleted,composerLinesAdded:s.composerLinesAdded,composerLinesDeleted:s.composerLinesDeleted,linesAdded:s.linesAdded,linesDeleted:s.linesDeleted})}))}score(e,t,i,o){return p(this,void 0,void 0,(function*(){var n,r,s;const a=yield this.detectAndPropagateFormatChanges(t,i);a>0&&(0,h.debugLog)("commitScoring.formatDetection.total",{commitHash:e,hashesAdded:a});const l=t.date?new Date(t.date).getTime()+1e3:void 0,d=this.createGitOperationsWithStorage(i),u=[...new Set(t.diff.flatMap((e=>[e.from,e.to].filter((e=>!!e&&"/dev/null"!==e)).map((e=>e.replace(/\\/g,"/"))))))],m=u.length>0?yield this.storage.getAiDeletedFiles(u,l):new Set,g=yield(0,c.fS)(t.diff,{normalizeLines:!0,gitOperations:d,repoRoot:i,commitHash:e,commitTimestamp:l,isAiDeletedFile:e=>m.has(e)});if(!g)return(0,h.debugLog)("commitScoring.noHashData",{commitHash:e}),v;yield this.reportCommitAiAnalytics(e,g,t.message,t.date,o);const f=g.linesAdded+g.linesDeleted,p=g.tabLinesAdded+g.tabLinesDeleted+g.composerLinesAdded+g.composerLinesDeleted,y=(null!==(n=g.blankLinesAdded)&&void 0!==n?n:0)+(null!==(r=g.blankLinesDeleted)&&void 0!==r?r:0),b=f>0?(p/f*100).toFixed(2):"0.00",w=f-y,S=w>0?((w-(g.humanLinesAdded+g.humanLinesDeleted))/w*100).toFixed(2):"0.00";return yield this.storage.markCommitScored(e,null!==(s=o.branchName)&&void 0!==s?s:"",{linesAdded:g.linesAdded,linesDeleted:g.linesDeleted,tabLinesAdded:g.tabLinesAdded,tabLinesDeleted:g.tabLinesDeleted,composerLinesAdded:g.composerLinesAdded,composerLinesDeleted:g.composerLinesDeleted,humanLinesAdded:g.humanLinesAdded,humanLinesDeleted:g.humanLinesDeleted,blankLinesAdded:g.blankLinesAdded,blankLinesDeleted:g.blankLinesDeleted,commitMessage:t.message,commitDate:t.date,v1AiPercentage:b,v2AiPercentage:S}),g}))}detectAndPropagateFormatChanges(e,t){return p(this,void 0,void 0,(function*(){const i=e.diff.map((e=>e.to||e.from)).filter((e=>null!=e));if(0===i.length)return 0;const o=yield this.storage.getTrackedFileContents(i);if(0===Object.keys(o).length)return 0;let n=0;for(const[i,r]of Object.entries(o))try{const o=yield this.getFileContentAtCommit(e.hash,i,t);if(!o||o===r.content)continue;const s=r.content.split("\n"),a=o.split("\n"),l=(0,c.ld)(s,a);if(0===l.length)continue;const d=r.fileExtension||"txt",u=(0,c.yF)(r.content,o,d,l);if(0===u.size)continue;const m=yield(0,c.yY)(u,r.content,o,i,d,!0,(0,g.L)(this.storage));m>0&&(n+=m,(0,h.debugLog)("commitScoring.formatDetection.propagated",{gitPath:i,hashesAdded:m}))}catch(e){(0,h.debugLog)("commitScoring.formatDetection.error",{gitPath:i,error:e})}return Object.keys(o).length>0&&(yield this.storage.deleteTrackedFileContents(Object.keys(o)).catch((e=>(0,h.debugLog)("commitScoring.formatDetection.cleanup.error",{error:e})))),n}))}getFileContentAtCommit(e,t,i){return p(this,void 0,void 0,(function*(){try{const{stdout:o}=yield y("git",["show",`${e}:${t}`],{cwd:i,maxBuffer:10485760});return o}catch(e){return null}}))}createGitOperationsWithStorage(e){const t=this.storage,i=this.gitOperations;return{getGitRoot:e=>i.getGitRoot(e),getRemotes:e=>i.getRemotes(e),getGitUser:e=>i.getGitUser(e),getCommitsByAuthor:(e,t,o)=>i.getCommitsByAuthor(e,t,o),getRecentCommits:(e,t,o)=>i.getRecentCommits(e,t,o),getCurrentBranch:e=>i.getCurrentBranch(e),getDefaultBranch:e=>i.getDefaultBranch(e),getUpstreamUrl:e=>i.getUpstreamUrl(e),getSubmodules:e=>i.getSubmodules(e),commitExists:(e,t)=>i.commitExists(e,t),hashObject:(e,t)=>i.hashObject(e,t),catBlob:(e,t)=>i.catBlob(e,t),getAiCodeHashes(e,i,o,n){return p(this,void 0,void 0,(function*(){const r=(0,c.H2)(e,i);return t.getHashes(r,{minCreatedAt:o,maxCreatedAt:n})}))},getTrackingStartTime(){return p(this,void 0,void 0,(function*(){return t.getTrackingStartTime()}))}}}shouldScoreCommit(e,t){return p(this,void 0,void 0,(function*(){if(0===e.diff.length)return{shouldScore:!1,reason:"No changes"};if(t)return{shouldScore:!0,reason:"Primary branch"};const i=yield this.storage.getTrackingStartTime();if(!i)return{shouldScore:!1,reason:"Tracking start time not set"};if(!e.date)return{shouldScore:!1,reason:"Commit date not available"};const o=new Date(e.date).getTime();if(Number.isNaN(o))return{shouldScore:!1,reason:"Invalid commit date"};const n=o>=i;return{shouldScore:n,reason:n?"After tracking start":"Before tracking start"}}))}getFullCommit(e,t){return p(this,void 0,void 0,(function*(){try{const{stdout:i}=yield y("git",["show","-s","--format=%H%n%s%n%aI%n%ae",e],{cwd:t,maxBuffer:10485760}),[o,n,r,s]=i.trim().split("\n");if(!o)return;const{stdout:a}=yield y("git",["show","--format=",e],{cwd:t,maxBuffer:10485760});return{hash:o,message:null!=n?n:"",date:null!=r?r:"",authorEmail:null!=s?s:"",diff:S(a)}}catch(t){return void(0,h.debugLog)("commitScoring.getFullCommit.error",{commitHash:e,error:t})}}))}reportCommitAiAnalytics(e,t,i,o,n){return p(this,void 0,void 0,(function*(){const{tabLinesAdded:r,tabLinesDeleted:s,composerLinesAdded:a,composerLinesDeleted:c,humanLinesAdded:l,humanLinesDeleted:u,blankLinesAdded:g,blankLinesDeleted:f,linesAdded:p,linesDeleted:y,changeIds:b,aiLineRanges:v}=t,w=(0,m.QF)("ai_code_tracking_v2_scoring"),S=w?l:Math.max(0,p-r-a),A=w?u:Math.max(0,y-s-c),L=w?Math.max(p-(null!=g?g:0),r+a):p,N=w?Math.max(y-(null!=f?f:0),s+c):y;try{yield this.aiServerClient.reportCommitAiAnalytics(new d.zBl({commitHash:e,commitSource:"cli",totalLinesAdded:L,totalLinesDeleted:N,tabLinesAdded:r,tabLinesDeleted:s,composerLinesAdded:a,composerLinesDeleted:c,nonAiLinesAdded:S,nonAiLinesDeleted:A,changeIds:b,commitTs:o?BigInt(new Date(o).getTime()):void 0,branchName:n.branchName,isPrimaryBranch:n.isPrimaryBranch,repoName:n.repoName,message:i,rangeAnnotations:v?this.convertAiLineRangesToProto(v):void 0})),(0,h.debugLog)("commitScoring.reported",{commitHash:e})}catch(t){(0,h.debugLog)("commitScoring.report.error",{commitHash:e,error:t})}}))}convertAiLineRangesToProto(e){const t=[];for(const[i,o]of e.entries()){const e=new Map;for(const[t,i]of o.entries())this.processRangesForProto(i.additions,"addition",e),this.processRangesForProto(i.deletions,"deletion",e);if(e.size>0){const o=[];for(const t of e.values()){const e={operationType:t.operationType,ranges:t.ranges.map((e=>new d.T_({start:e.start,end:e.end})))};void 0!==t.conversationId&&(e.conversationId=t.conversationId),void 0!==t.model&&(e.model=t.model),o.push(new d.xuv(e))}t.push(new d.Obz({filePath:i,groups:o}))}}return t}processRangesForProto(e,t,i){var o,n,r,s,a,c;const l=[...e].sort(((e,t)=>e.lineNumber-t.lineNumber));let d=null;for(const e of l){const a=null!==(o=e.conversationId)&&void 0!==o?o:void 0,c=null!==(n=e.model)&&void 0!==n?n:void 0;if(d&&d.end+1===e.lineNumber&&d.conversationId===a&&d.model===c)d.end=e.lineNumber;else{if(d){const e=`${null!==(r=d.conversationId)&&void 0!==r?r:""}|${null!==(s=d.model)&&void 0!==s?s:""}|${t}`;i.has(e)||i.set(e,{conversationId:d.conversationId,model:d.model,operationType:t,ranges:[]}),i.get(e).ranges.push({start:d.start,end:d.end})}d={start:e.lineNumber,end:e.lineNumber,conversationId:a,model:c}}}if(d){const e=`${null!==(a=d.conversationId)&&void 0!==a?a:""}|${null!==(c=d.model)&&void 0!==c?c:""}|${t}`;i.has(e)||i.set(e,{conversationId:d.conversationId,model:d.model,operationType:t,ranges:[]}),i.get(e).ranges.push({start:d.start,end:d.end})}}loadOrInitTrackingStartTime(){return p(this,void 0,void 0,(function*(){"number"!=typeof(yield this.storage.getTrackingStartTime())&&(yield this.storage.setTrackingStartTime(Date.now()))}))}ensureStorageReady(){return p(this,void 0,void 0,(function*(){this.storageInitPromise||(this.storageInitPromise=this.storage.initialize()),yield this.storageInitPromise}))}}function S(e){var t;const i=[],o=e.split(/^diff --git /m).filter(Boolean);for(const e of o){const o=e.split("\n"),n=null===(t=o[0])||void 0===t?void 0:t.match(/a\/(.+) b\/(.+)/);if(!n)continue;let r=n[1],s=n[2];for(const e of o)if(e.startsWith("--- /dev/null"))r="/dev/null";else if(e.startsWith("+++ /dev/null"))s="/dev/null";else if(e.startsWith("@@"))break;const a=[];let c=0,l=0;for(const e of o)if(e.startsWith("@@")){const t=e.match(/@@ -(\d+)(?:,\d+)? \+(\d+)/);t&&(c=parseInt(t[1],10),l=parseInt(t[2],10))}else e.startsWith("+")&&!e.startsWith("+++")?(a.push({content:e,type:"add",lineNumber:l}),l++):e.startsWith("-")&&!e.startsWith("---")?(a.push({content:e,type:"del",lineNumber:c}),c++):e.startsWith("\\")||e.startsWith("diff")||e.startsWith("index")||e.startsWith("---")||e.startsWith("+++")||e.startsWith("new")||e.startsWith("deleted")||(c++,l++);i.push({from:r,to:s,chunks:[{changes:a}]})}return i}},"./src/transcript/cli-transcript-writer.ts":(e,t,i)=>{i.d(t,{$J:()=>d,Ko:()=>m,kw:()=>u});var o=i("node:fs/promises"),n=i("node:path"),r=i("../agent-transcript/dist/index.js"),s=i("../cursor-config/dist/index.js"),a=(i("../utils/dist/index.js"),i("./src/debug.ts")),c=function(e,t,i,o){return new(i||(i=Promise))((function(n,r){function s(e){try{c(o.next(e))}catch(e){r(e)}}function a(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))};const l=s.Xq;function d(e){return(0,n.join)(l(e),r.O2)}function u(e,t){const i=(0,r.sh)(t);return(0,n.join)(d(e),`${i}.jsonl`)}function h(e,t){return c(this,void 0,void 0,(function*(){const i=(0,n.dirname)(e);yield(0,o.mkdir)(i,{recursive:!0}),yield(0,o.writeFile)(e,t,"utf-8")}))}class m{constructor(e,t,i){this.workspacePath=e,this.conversationId=t,this.writeChain=Promise.resolve(),this.projectDir=l(e),this.transcriptStore=new r.YF(this.projectDir,i,h,{writeText:!1,writeJsonl:!0})}writeFromState(e,t){return c(this,void 0,void 0,(function*(){const i=this.writeChain;return this.writeChain=i.then((()=>c(this,void 0,void 0,(function*(){try{yield this.transcriptStore.writeFromState(e,t,this.conversationId)}catch(e){(0,a.debugLog)("[CliTranscriptWriter] Failed to write transcript:",e)}})))),this.writeChain}))}waitForPendingWrites(){return this.writeChain}getTranscriptPath(){return u(this.workspacePath,this.conversationId)}getProjectDir(){return this.projectDir}}},"./src/transcript/index.ts":(e,t,i)=>{i.d(t,{$J:()=>o.$J,Ko:()=>o.Ko,kw:()=>o.kw});var o=i("./src/transcript/cli-transcript-writer.ts")}};