try{!function(){var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:{},t=(new e.Error).stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="7a1ef851-f842-457e-9eee-1b43d055d602",e._sentryDebugIdIdentifier="sentry-dbid-7a1ef851-f842-457e-9eee-1b43d055d602")}()}catch(e){}!function(){try{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:{}).SENTRY_RELEASE={id:"agent-cli@2026.02.13-41ac335"}}catch(e){}}(),exports.id=414,exports.ids=[414],exports.modules={"./src/acp/agent-session.ts":(e,t,o)=>{o.d(t,{m:()=>T});var n=o("node:path"),s=o("../agent-client/dist/index.js"),l=o("../agent-core/dist/index.js"),i=o("../proto/dist/generated/agent/v1/agent_pb.js"),a=o("../proto/dist/generated/agent/v1/ask_question_tool_pb.js"),r=o("../proto/dist/generated/agent/v1/create_plan_tool_pb.js"),d=o("../proto/dist/generated/agent/v1/selected_context_pb.js"),c=o("../proto/dist/generated/agent/v1/todo_tool_pb.js"),u=o("./src/commands/custom-commands.ts"),v=o("./src/debug.ts"),h=o("./src/state/session.ts"),p=o("./src/statsig.ts"),g=o("./src/utils/clipboard.ts"),m=o("./src/utils/git.ts"),f=o("./src/utils/interaction-responses.ts"),C=o("./src/utils/interaction-utils.ts"),w=o("./src/utils/url-utils.ts"),y=o("./src/acp/types.ts"),b=function(e,t,o,n){return new(o||(o=Promise))((function(s,l){function i(e){try{r(n.next(e))}catch(e){l(e)}}function a(e){try{r(n.throw(e))}catch(e){l(e)}}function r(e){var t;e.done?s(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(i,a)}r((n=n.apply(e,t||[])).next())}))};class T{constructor(e,t,o,n,s,l,i){this.lastRequestId=null,this.sentToolCalls=new Set,this.connection=e,this.sessionId=t,this.pendingPromptCancel=null,this.sharedServices=o,this.ctx=n,this.agentStore=s,this.resources=l,this.currentModel=i}setCurrentModel(e){this.currentModel=e}getCurrentModel(){return this.currentModel}setMode(e){this.agentStore.setMetadata("mode",e);const t=(0,C.mb)(e);this.sendCurrentModeUpdate(t).catch((e=>{(0,v.debugLog)("Failed to send mode update:",e)}))}sendCurrentModeUpdate(e){return b(this,void 0,void 0,(function*(){yield this.sendSessionUpdate({sessionUpdate:"current_mode_update",currentModeId:e})}))}sendSessionUpdate(e){return b(this,void 0,void 0,(function*(){yield this.connection.sessionUpdate({sessionId:this.sessionId,update:e})}))}sendAvailableCommands(){return b(this,void 0,void 0,(function*(){const e=(0,m.ky)(process.cwd())||process.cwd(),t=new u.FD(this.sharedServices.dashboardClient),o=(0,p.QF)("enable_skills"),n={sessionUpdate:"available_commands_update",availableCommands:[{name:"copy-request-id",description:"Copy the last request ID to clipboard"},...(yield t.loadCommands(e,{includeSkills:o})).map((e=>({name:e.id,description:e.description||""})))]};(0,v.debugLog)("Sending available commands:",n),yield this.sendSessionUpdate(n),(0,v.debugLog)("Available commands sent successfully")}))}sendAgentMessageChunk(e){return b(this,void 0,void 0,(function*(){yield this.sendSessionUpdate({sessionUpdate:"agent_message_chunk",content:{type:"text",text:e}})}))}sendToolCall(e,t,o,n){return b(this,void 0,void 0,(function*(){yield this.sendSessionUpdate({sessionUpdate:"tool_call",toolCallId:e,title:t,kind:o,status:"pending",rawInput:n})}))}sendToolCallUpdate(e,t,o,n){return b(this,void 0,void 0,(function*(){yield this.sendSessionUpdate({sessionUpdate:"tool_call_update",toolCallId:e,status:t,content:o,rawOutput:n})}))}handlePrompt(e){return b(this,void 0,void 0,(function*(){var t;null===(t=this.pendingPromptCancel)||void 0===t||t.call(this);const[o,n]=this.ctx.withCancel();this.pendingPromptCancel=n;try{yield this.processPrompt(e,o)}catch(e){if(o.canceled)return{stopReason:"cancelled"};throw e}finally{this.pendingPromptCancel=null}return o.canceled?{stopReason:"cancelled"}:{stopReason:"end_turn"}}))}processPrompt(e,t){return b(this,void 0,void 0,(function*(){var o,n;const c=e.prompt||[],u=c.filter((e=>"text"===e.type)).map((e=>e.text)).join("\n")||"",p=c.filter((e=>"image"===e.type));if(!u.trim()&&0===p.length)return void(yield this.sendAgentMessageChunk("No prompt content provided."));const g=yield this.handleSlashCommand(u.trim());if(g.handled)return;const m=null!==(o=g.substitutedPrompt)&&void 0!==o?o:u;this.sentToolCalls.clear();const y={sendUpdate:(e,t)=>b(this,void 0,void 0,(function*(){var e,o;switch(t.message.case){case"textDelta":yield this.sendAgentMessageChunk(t.message.value.text);break;case"partialToolCall":{const o=t.message.value.toolCall;if(!o)break;if(!this.sentToolCalls.has(t.message.value.callId)){const n=this.summarizeToolCall(o);if(n){const s=this.getToolKind(null!==(e=o.tool.case)&&void 0!==e?e:"");this.sentToolCalls.add(t.message.value.callId),yield this.sendToolCall(t.message.value.callId,n,s,this.extractToolCallInput(o))}}break}case"toolCallStarted":{const e=t.message.value.toolCall;if(!e)break;const n=this.summarizeToolCall(e);if(n){const s=this.getToolKind(null!==(o=e.tool.case)&&void 0!==o?o:"");this.sentToolCalls.add(t.message.value.callId),yield this.sendToolCall(t.message.value.callId,n,s,this.extractToolCallInput(e))}break}case"toolCallCompleted":{const e=t.message.value.toolCall;if(!e)break;if(this.summarizeToolCall(e)){const o=this.extractToolCallContent(e),n=this.extractToolCallOutput(e);yield this.sendToolCallUpdate(t.message.value.callId,"completed",o,n),yield this.sendToolExtensionNotification(t.message.value.callId,e)}break}}})),query:(e,t)=>b(this,void 0,void 0,(function*(){var e,o,n,s;switch(t.query.case){case"askQuestionInteractionQuery":{const e=t.query.value;return e?this.handleAskQuestionRequest(t.id,e):l.x1.askQuestion(t.id,new a.tz({result:{case:"rejected",value:new a.ox({reason:"Missing ask-question query payload"})}}))}case"createPlanRequestQuery":{const e=t.query.value;return e?this.handleCreatePlanRequest(t.id,e):l.x1.createPlan(t.id,new r.bK({result:{case:"error",value:new r.iY({error:"Missing create-plan query payload"})}}))}case"webFetchRequestQuery":{const i=t.query.value;if(!i)return l.x1.webFetchRejected(t.id,"Missing web-fetch query payload");const a="auto-run"===this.agentStore.getMetadata("mode");if(i.skipApproval)return(0,v.debugLog)("web-fetch-auto-approved-server-skip",{}),l.x1.webFetchApproved(t.id);if(a)return(0,v.debugLog)("web-fetch-auto-approved-acp-run-everything",{}),l.x1.webFetchApproved(t.id);const r=null!==(o=null===(e=i.args)||void 0===e?void 0:e.url)&&void 0!==o?o:"",d=(0,w.BF)(r),c=null!==(s=null===(n=this.sharedServices.configProvider.get().permissions)||void 0===n?void 0:n.allow)&&void 0!==s?s:[];return(0,w.hD)(d,c)?((0,v.debugLog)("web-fetch-auto-approved-acp-allowlist",{domain:d,url:r}),l.x1.webFetchApproved(t.id)):l.x1.webFetchRejected(t.id,"Domain not in allowlist")}default:{const e="auto-run"===this.agentStore.getMetadata("mode");return(0,f.l)(t,{approveWebSearch:e,approveWebFetch:!1,askQuestionRejectReason:"Questions skipped in ACP mode"})}}}))};try{const e=p.map((e=>{const t=Buffer.from(e.data,"base64");return new d.d({dataOrBlobId:{case:"data",value:t},uuid:crypto.randomUUID(),mimeType:e.mimeType})})),o=new d.xv({selectedImages:e}),n=this.agentStore.getMetadata("mode"),s=(0,C.cT)(n),a=new i.UserMessageAction({userMessage:new i.UserMessage({text:m,selectedContext:o,messageId:crypto.randomUUID(),mode:s})}),r=new l.hg;yield this.sharedServices.agentClient.run(t,this.agentStore.getConversationStateStructure(),new i.ConversationAction({action:{case:"userMessageAction",value:a}}),this.currentModel,y,this.resources,this.agentStore.getBlobStore(),r,this.agentStore,[],{conversationId:this.agentStore.getId(),onConnectionStateChange:e=>{"reconnecting"===e.state?(0,v.debugLog)("Connection state: reconnecting"):"connected"===e.state&&(0,v.debugLog)("Connection state: connected")}}),this.lastRequestId=h.d.getLastRequestId()}catch(e){if(this.lastRequestId=h.d.getLastRequestId(),e instanceof s.cc||t.canceled)return;if(e instanceof s.ao){const t=null!==(n={login:"Please sign in to continue",upgrade:"Upgrade your plan to continue",payment:"Add a payment method to continue",config:"Check your settings to continue"}[e.action])&&void 0!==n?n:e.message;return void(yield this.sendAgentMessageChunk(`\n\n${t}`))}yield this.sendAgentMessageChunk(`\n\nError: ${String(e)}`)}}))}handleSlashCommand(e){return b(this,void 0,void 0,(function*(){var t;if("/copy-request-id"===e.toLowerCase().trim())return yield this.handleCopyRequestId(),{handled:!0};if(!e.startsWith("/"))return{handled:!1};const o=e.match(/^\/(\S+)(?:\s+(.*))?$/);if(!o)return{handled:!1};const[,n,s]=o,l=null!==(t=null==s?void 0:s.split(/\s+/).filter(Boolean))&&void 0!==t?t:[],i=(0,m.ky)(process.cwd())||process.cwd(),a=new u.FD(this.sharedServices.dashboardClient);yield a.loadCommands(i,{includeSkills:!1});const r=a.getCommandById(n);if(!r)return{handled:!1};const{result:d,hadPlaceholders:c}=(0,u.H8)(r.content,l);let v;return v=c?d:(null==s?void 0:s.trim())?`${r.content}\n\n${s.trim()}`:r.content,{handled:!1,substitutedPrompt:v}}))}handleCopyRequestId(){return b(this,void 0,void 0,(function*(){const e=this.lastRequestId;e?(yield(0,g.e)(e))?yield this.sendAgentMessageChunk(`Copied request ID: ${e}`):yield this.sendAgentMessageChunk(`Request ID: ${e}`):yield this.sendAgentMessageChunk("No request ID found. Submit a prompt first, then retry /copy-request-id.")}))}makePathRelativeIfPossible(e){if(!(0,n.isAbsolute)(e))return e;const t=process.cwd(),o=(0,n.resolve)(e),s=(0,n.relative)(t,o);return s.startsWith("..")||(0,n.isAbsolute)(s)?e:s}getToolKind(e){return e in y.DG?y.DG[e]:"other"}summarizeToolCall(e){var t,o,n,s,l,i,a,r,d,c,u,v,h,p,g,m,f,C,w,y,b,T,S,x;const k=e.tool,P=k.case;if(!P)return null;switch(P){case"shellToolCall":{const e=null!==(o=null===(t=k.value.args)||void 0===t?void 0:t.command)&&void 0!==o?o:"";return e?`\`${e.replaceAll("`","\\`")}\``:"Terminal"}case"grepToolCall":{const e=k.value.args;if(!e)return"grep";let t="grep";if(e.i&&(t+=" -i"),e.n&&(t+=" -n"),void 0!==e.A&&(t+=` -A ${e.A}`),void 0!==e.B&&(t+=` -B ${e.B}`),void 0!==e.C&&(t+=` -C ${e.C}`),e.outputMode)switch(e.outputMode){case"files_with_matches":t+=" -l";break;case"count":t+=" -c"}return void 0!==e.headLimit&&(t+=` | head -${e.headLimit}`),e.glob&&(t+=` --include="${e.glob}"`),e.type&&(t+=` --type=${e.type}`),e.multiline&&(t+=" -P"),e.pattern&&(t+=` "${e.pattern}"`),t}case"semSearchToolCall":{const e=null===(n=k.value.args)||void 0===n?void 0:n.query;return e?`Search: "${e}"`:"Codebase Search"}case"editToolCall":{const e=null===(s=k.value.args)||void 0===s?void 0:s.path;return e?`Edit \`${e}\``:"Edit File"}case"readToolCall":{const e=k.value.args;if(!(null==e?void 0:e.path))return"Read File";const t=this.makePathRelativeIfPossible(e.path);let o="";return e.limit?o=` (${(null!==(l=e.offset)&&void 0!==l?l:0)+1} - ${(null!==(i=e.offset)&&void 0!==i?i:0)+e.limit})`:e.offset&&(o=` (from line ${e.offset+1})`),`Read ${t}${o}`}case"deleteToolCall":{const e=null===(a=k.value.args)||void 0===a?void 0:a.path;return e?`Delete \`${e}\``:"Delete File"}case"lsToolCall":{const e=null===(r=k.value.args)||void 0===r?void 0:r.path;return e?`List the \`${this.makePathRelativeIfPossible(e)}\` directory's contents`:"List the current directory's contents"}case"globToolCall":{const e=k.value.args,t=null!==(d=null==e?void 0:e.pattern)&&void 0!==d?d:null==e?void 0:e.globPattern;let o="Find";return(null==e?void 0:e.path)&&(o+=` \`${e.path}\``),t&&(o+=` \`${t}\``),o}case"updateTodosToolCall":{const e=k.value.args;if(Array.isArray(null==e?void 0:e.todos)&&e.todos.length>0){const t=e.todos.map((e=>e.content)).filter(Boolean).join(", ");return t?`Update TODOs: ${t}`:"Update TODOs"}return"Update TODOs"}case"readTodosToolCall":return"Read TODOs";case"readLintsToolCall":{const e=k.value.args,t=null!==(c=null==e?void 0:e.paths)&&void 0!==c?c:[];return 0===t.length?"Read Lints":1===t.length?`Read Lints \`${this.makePathRelativeIfPossible(t[0])}\``:`Read Lints \`${this.makePathRelativeIfPossible(t[0])}\` (+${t.length-1} more)`}case"mcpToolCall":{const e=k.value.args;return`${null!==(u=null==e?void 0:e.providerIdentifier)&&void 0!==u?u:"MCP"}: ${null!==(v=null==e?void 0:e.toolName)&&void 0!==v?v:"tool"}`}case"listMcpResourcesToolCall":{const e=k.value.args;return(null==e?void 0:e.server)?`List MCP Resources (${e.server})`:"List MCP Resources"}case"readMcpResourceToolCall":{const e=k.value.args,t=null!==(h=null==e?void 0:e.server)&&void 0!==h?h:"",o=null!==(p=null==e?void 0:e.uri)&&void 0!==p?p:"";return t&&o?`Fetch MCP Resource (${t}) ${o}`:o?`Fetch MCP Resource ${o}`:"Fetch MCP Resource"}case"webSearchToolCall":{const e=k.value.args,t=null!==(g=null==e?void 0:e.searchTerm)&&void 0!==g?g:"";return t?`Web Search: "${t}"`:"Web Search"}case"webFetchToolCall":{const e=k.value.args,t=null!==(m=null==e?void 0:e.url)&&void 0!==m?m:"";return t?`Web Fetch: ${t}`:"Web Fetch"}case"taskToolCall":{const e=k.value.args;return`Task: ${null!==(f=null==e?void 0:e.description)&&void 0!==f?f:"Subagent task"}`}case"writeShellStdinToolCall":{const e=k.value.args;return`Write to stdin (shell ${null!==(C=null==e?void 0:e.shellId)&&void 0!==C?C:0})`}case"askQuestionToolCall":{const e=k.value.args;return null!==(w=null==e?void 0:e.title)&&void 0!==w?w:"Ask Question"}case"switchModeToolCall":{const e=k.value.args;return`Switch Mode: ${null!==(y=null==e?void 0:e.targetModeId)&&void 0!==y?y:"unknown"}`}case"createPlanToolCall":{const e=k.value.args,t=null!==(b=null==e?void 0:e.name)&&void 0!==b?b:"";return t?`Create Plan: ${t}`:"Create Plan"}case"applyAgentDiffToolCall":return"Apply Agent Diff";case"fetchToolCall":{const e=k.value.args,t=null!==(T=null==e?void 0:e.url)&&void 0!==T?T:"";return t?`Fetch: ${t}`:"Fetch"}case"generateImageToolCall":{const e=k.value.args,t=null!==(S=null==e?void 0:e.description)&&void 0!==S?S:"";return t?`Generate Image: ${t.slice(0,50)}...`:"Generate Image"}case"recordScreenToolCall":return"Record Screen";case"computerUseToolCall":{const e=k.value.args;return`Computer Use: ${null!==(x=null==e?void 0:e.action)&&void 0!==x?x:"action"}`}case"reflectToolCall":return"Reflect";case"setupVmEnvironmentToolCall":return"Setup VM Environment";case"truncatedToolCall":return"Truncated Tool Call";case"startGrindExecutionToolCall":return"Start Grind Execution";case"startGrindPlanningToolCall":return"Start Grind Planning";case"reportBugfixResultsToolCall":return"Report Bugfix Results";default:return null}}extractToolCallInput(e){var t,o,n,s,l,i,a,r,d;const c=e.tool,u=c.case;if(u)switch(u){case"shellToolCall":return{command:null===(t=c.value.args)||void 0===t?void 0:t.command};case"grepToolCall":return{pattern:null===(o=c.value.args)||void 0===o?void 0:o.pattern,path:null===(n=c.value.args)||void 0===n?void 0:n.path};case"semSearchToolCall":return{query:null===(s=c.value.args)||void 0===s?void 0:s.query};case"editToolCall":return{path:null===(l=c.value.args)||void 0===l?void 0:l.path};case"readToolCall":return{path:null===(i=c.value.args)||void 0===i?void 0:i.path};case"deleteToolCall":return{path:null===(a=c.value.args)||void 0===a?void 0:a.path};case"lsToolCall":return{path:null===(r=c.value.args)||void 0===r?void 0:r.path};case"globToolCall":{const e=c.value.args;return{pattern:null!==(d=null==e?void 0:e.pattern)&&void 0!==d?d:null==e?void 0:e.globPattern}}case"readLintsToolCall":{const e=c.value.args;return{paths:null==e?void 0:e.paths}}case"mcpToolCall":{const e=c.value.args;return{providerIdentifier:null==e?void 0:e.providerIdentifier,toolName:null==e?void 0:e.toolName,args:null==e?void 0:e.args}}case"listMcpResourcesToolCall":{const e=c.value.args;return{server:null==e?void 0:e.server}}case"readMcpResourceToolCall":{const e=c.value.args;return{server:null==e?void 0:e.server,uri:null==e?void 0:e.uri,downloadPath:null==e?void 0:e.downloadPath}}case"webSearchToolCall":{const e=c.value.args;return{searchTerm:null==e?void 0:e.searchTerm}}case"webFetchToolCall":{const e=c.value.args;return{url:null==e?void 0:e.url}}case"taskToolCall":{const e=c.value.args;return{_toolName:"task",prompt:null==e?void 0:e.prompt,description:null==e?void 0:e.description,subagentType:null==e?void 0:e.subagentType}}case"writeShellStdinToolCall":{const e=c.value.args;return{shellId:null==e?void 0:e.shellId,chars:null==e?void 0:e.chars}}case"updateTodosToolCall":{const e=c.value.args;return{_toolName:"updateTodos",todos:null==e?void 0:e.todos}}case"readTodosToolCall":case"recordScreenToolCall":case"setupVmEnvironmentToolCall":case"truncatedToolCall":case"startGrindExecutionToolCall":case"startGrindPlanningToolCall":case"reportBugfixResultsToolCall":return{};case"askQuestionToolCall":{const e=c.value.args;return{_toolName:"askQuestion",title:null==e?void 0:e.title,questions:null==e?void 0:e.questions}}case"switchModeToolCall":{const e=c.value.args;return{targetModeId:null==e?void 0:e.targetModeId,explanation:null==e?void 0:e.explanation}}case"createPlanToolCall":{const e=c.value.args;return{_toolName:"createPlan",name:null==e?void 0:e.name,plan:null==e?void 0:e.plan}}case"applyAgentDiffToolCall":{const e=c.value.args;return{path:null==e?void 0:e.path}}case"fetchToolCall":{const e=c.value.args;return{url:null==e?void 0:e.url}}case"generateImageToolCall":{const e=c.value.args;return{_toolName:"generateImage",description:null==e?void 0:e.description,filename:null==e?void 0:e.filename}}case"computerUseToolCall":{const e=c.value.args;return{action:null==e?void 0:e.action,coordinate:null==e?void 0:e.coordinate,text:null==e?void 0:e.text}}case"reflectToolCall":{const e=c.value.args;return{reflection:null==e?void 0:e.reflection}}default:return}}extractToolCallContent(e){var t,o,n;const s=e.tool;switch(s.case){case"editToolCall":{const e=null===(t=s.value.result)||void 0===t?void 0:t.result;if("success"===(null==e?void 0:e.case))return[{type:"diff",path:e.value.path,oldText:null!==(o=e.value.beforeFullFileContent)&&void 0!==o?o:null,newText:e.value.afterFullFileContent}];break}case"deleteToolCall":{const e=null===(n=s.value.result)||void 0===n?void 0:n.result;if("success"===(null==e?void 0:e.case))return[{type:"diff",path:e.value.path,oldText:e.value.deletedFile,newText:""}];break}default:return}}extractToolCallOutput(e){var t,o,n,s,l,i,a,r,d,c,u,v,h,p,g,m,f,C,w,y;const b=e.tool,T=b.case;if(T)switch(T){case"shellToolCall":{const e=null===(t=b.value.result)||void 0===t?void 0:t.result;return"success"===(null==e?void 0:e.case)||"failure"===(null==e?void 0:e.case)?{exitCode:e.value.exitCode,stdout:e.value.stdout,stderr:e.value.stderr}:void 0}case"readToolCall":{const e=null===(o=b.value.result)||void 0===o?void 0:o.result;if("success"===(null==e?void 0:e.case)){const t=e.value.output;if("content"===t.case)return{content:t.value}}return}case"readLintsToolCall":{const e=null===(n=b.value.result)||void 0===n?void 0:n.result;return"success"===(null==e?void 0:e.case)?{totalDiagnostics:e.value.totalDiagnostics,totalFiles:e.value.totalFiles}:"error"===(null==e?void 0:e.case)?{error:e.value.errorMessage}:void 0}case"grepToolCall":{const e=null===(s=b.value.result)||void 0===s?void 0:s.result;if("success"===(null==e?void 0:e.case)){const t=e.value.workspaceResults,o=Object.values(t).at(0),n=null===(l=null==o?void 0:o.result)||void 0===l?void 0:l.value;let s=0,c=!1;if(n){c=n.ripgrepTruncated||n.clientTruncated||!1;const e=null===(i=null==o?void 0:o.result)||void 0===i?void 0:i.case;"count"===e?s=null!==(a=n.totalMatches)&&void 0!==a?a:0:"files"===e?s=null!==(r=n.totalFiles)&&void 0!==r?r:0:"content"===e&&(s=null!==(d=n.totalMatchedLines)&&void 0!==d?d:0)}return{totalMatches:s,truncated:c}}return"error"===(null==e?void 0:e.case)?{error:e.value.error}:void 0}case"semSearchToolCall":{const e=null===(c=b.value.result)||void 0===c?void 0:c.result;if("success"===(null==e?void 0:e.case)){const t=(null!==(u=e.value.results)&&void 0!==u?u:"").match(/<search_result\b/g);return{resultCount:t?t.length:0}}return"error"===(null==e?void 0:e.case)?{error:e.value.errorMessage}:void 0}case"globToolCall":{const e=null===(v=b.value.result)||void 0===v?void 0:v.result;return"success"===(null==e?void 0:e.case)?{totalFiles:e.value.totalFiles,truncated:e.value.clientTruncated}:"error"===(null==e?void 0:e.case)?{error:e.value.error}:void 0}case"lsToolCall":{const e=null===(h=b.value.result)||void 0===h?void 0:h.result;return"success"===(null==e?void 0:e.case)||"timeout"===(null==e?void 0:e.case)?{success:!0}:"error"===(null==e?void 0:e.case)?{error:e.value.error}:void 0}case"mcpToolCall":{const e=null===(p=b.value.result)||void 0===p?void 0:p.result;return"success"===(null==e?void 0:e.case)?{success:!0}:"error"===(null==e?void 0:e.case)?{error:e.value.error}:"rejected"===(null==e?void 0:e.case)?{rejected:!0}:"permissionDenied"===(null==e?void 0:e.case)?{permissionDenied:!0}:void 0}case"webSearchToolCall":{const e=null===(g=b.value.result)||void 0===g?void 0:g.result;return"success"===(null==e?void 0:e.case)?{referenceCount:null!==(f=null===(m=e.value.references)||void 0===m?void 0:m.length)&&void 0!==f?f:0}:"error"===(null==e?void 0:e.case)?{error:e.value.error}:"rejected"===(null==e?void 0:e.case)?{rejected:!0,reason:e.value.reason}:void 0}case"webFetchToolCall":{const e=null===(C=b.value.result)||void 0===C?void 0:C.result;return"success"===(null==e?void 0:e.case)?{success:!0}:"error"===(null==e?void 0:e.case)?{error:e.value.error}:"rejected"===(null==e?void 0:e.case)?{rejected:!0,reason:e.value.reason}:void 0}case"taskToolCall":{const e=null===(w=b.value.result)||void 0===w?void 0:w.result;return"success"===(null==e?void 0:e.case)?{durationMs:e.value.durationMs,isBackground:e.value.isBackground}:"error"===(null==e?void 0:e.case)?{error:e.value.error}:void 0}case"writeShellStdinToolCall":{const e=null===(y=b.value.result)||void 0===y?void 0:y.result;return"success"===(null==e?void 0:e.case)?{success:!0}:"error"===(null==e?void 0:e.case)?{error:e.value.error}:void 0}default:return}}handleAskQuestionRequest(e,t){return b(this,void 0,void 0,(function*(){var o,n,s,i,r;if(null!==(n=null===(o=t.args)||void 0===o?void 0:o.runAsync)&&void 0!==n&&n)return l.x1.askQuestion(e,new a.tz({result:{case:"async",value:new a.yt}}));try{const o={toolCallId:t.toolCallId,title:null===(s=t.args)||void 0===s?void 0:s.title,questions:(null!==(r=null===(i=t.args)||void 0===i?void 0:i.questions)&&void 0!==r?r:[]).map((e=>({id:e.id,prompt:e.prompt,options:e.options.map((e=>({id:e.id,label:e.label}))),allowMultiple:e.allowMultiple})))},n=yield this.connection.extMethod(y.ax,o);return l.x1.askQuestion(e,this.convertExtResponseToAskQuestionResult(n))}catch(t){return(0,v.debugLog)("AskQuestion extension method failed, falling back to rejection:",t),l.x1.askQuestion(e,new a.tz({result:{case:"rejected",value:new a.ox({reason:"Client does not support ask_question extension"})}}))}}))}convertExtResponseToAskQuestionResult(e){var t;if("answered"===e.outcome.outcome)return new a.tz({result:{case:"success",value:new a.dE({answers:e.outcome.answers.map((e=>new a.wh({questionId:e.questionId,selectedOptionIds:e.selectedOptionIds})))})}});const o="skipped"===e.outcome.outcome?null!==(t=e.outcome.reason)&&void 0!==t?t:"User skipped questions":"User cancelled";return new a.tz({result:{case:"rejected",value:new a.ox({reason:o})}})}handleCreatePlanRequest(e,t){return b(this,void 0,void 0,(function*(){var o,n,s;try{const i=t.args,a={toolCallId:t.toolCallId,name:null==i?void 0:i.name,overview:null==i?void 0:i.overview,plan:null!==(o=null==i?void 0:i.plan)&&void 0!==o?o:"",todos:(null!==(n=null==i?void 0:i.todos)&&void 0!==n?n:[]).map((e=>({id:e.id,content:e.content,status:this.convertTodoStatus(e.status)}))),isProject:null==i?void 0:i.isProject,phases:null===(s=null==i?void 0:i.phases)||void 0===s?void 0:s.map((e=>({name:e.name,todos:e.todos.map((e=>({id:e.id,content:e.content,status:this.convertTodoStatus(e.status)})))})))},r=yield this.connection.extMethod(y.Yg,a);return l.x1.createPlan(e,this.convertExtResponseToCreatePlanResult(r))}catch(t){return(0,v.debugLog)("CreatePlan extension method failed, falling back to auto-accept:",t),l.x1.createPlan(e,new r.bK({result:{case:"success",value:new r.Jo},planUri:""}))}}))}convertTodoStatus(e){switch(e){case c.Vj.PENDING:return"pending";case c.Vj.IN_PROGRESS:return"in_progress";case c.Vj.COMPLETED:return"completed";case c.Vj.CANCELLED:return"cancelled";default:return"pending"}}convertExtResponseToCreatePlanResult(e){var t,o;if("accepted"===e.outcome.outcome)return new r.bK({result:{case:"success",value:new r.Jo},planUri:null!==(t=e.outcome.planUri)&&void 0!==t?t:""});const n="rejected"===e.outcome.outcome?null!==(o=e.outcome.reason)&&void 0!==o?o:"User rejected plan":"User cancelled";return new r.bK({result:{case:"error",value:new r.iY({error:n})}})}sendToolExtensionNotification(e,t){return b(this,void 0,void 0,(function*(){var o,n,s,l,i,a;const r=t.tool,d=r.case;if(d)try{switch(d){case"updateTodosToolCall":{const t=r.value.args;if(!(null==t?void 0:t.todos))return;const n=t.todos.filter((e=>"string"==typeof e.id&&"string"==typeof e.content)).map((e=>{var t;return{id:e.id,content:e.content,status:this.convertTodoStatus(null!==(t=e.status)&&void 0!==t?t:0)}}));if(0===n.length)return;const s={toolCallId:e,todos:n,merge:null!==(o=t.merge)&&void 0!==o&&o};yield this.connection.extMethod(y.hK,s);break}case"taskToolCall":{const t=r.value.args,o=null===(n=r.value.result)||void 0===n?void 0:n.result,i="success"===(null==o?void 0:o.case)?o.value.durationMs:void 0,a=void 0!==i?Number(i):void 0,d={toolCallId:e,description:null!==(s=null==t?void 0:t.description)&&void 0!==s?s:"",prompt:null!==(l=null==t?void 0:t.prompt)&&void 0!==l?l:"",subagentType:this.mapSubagentType(null==t?void 0:t.subagentType),model:null==t?void 0:t.model,agentId:null==t?void 0:t.agentId,durationMs:a};yield this.connection.extMethod(y.b8,d);break}case"generateImageToolCall":{const t=r.value.args,o=null===(i=r.value.result)||void 0===i?void 0:i.result,n="success"===(null==o?void 0:o.case)?o.value.filePath:void 0,s={toolCallId:e,description:null!==(a=null==t?void 0:t.description)&&void 0!==a?a:"",filePath:null!=n?n:null==t?void 0:t.filename,referenceImagePaths:null==t?void 0:t.referenceImagePaths};yield this.connection.extMethod(y.ZT,s);break}}}catch(e){}}))}mapSubagentType(e){switch(e){case"computer_use":return"computer_use";case"explore":return"explore";case"media_review":return"media_review";case"browser_use":return"browser_use";case"shell":return"shell";case"vm_setup_helper":return"vm_setup_helper";case void 0:case"unspecified":return"unspecified";default:return{custom:e}}}}},"./src/acp/agent-store.ts":(e,t,o)=>{o.d(t,{Ag:()=>c,it:()=>v,rY:()=>u});var n=o("node:fs"),s=o("node:path"),l=o("../agent-kv/dist/index.js"),i=o("./src/debug.ts"),a=o("./src/state/index.ts"),r=o("./src/state/sqlite-blob-store.ts"),d=function(e,t,o,n){return new(o||(o=Promise))((function(s,l){function i(e){try{r(n.next(e))}catch(e){l(e)}}function a(e){try{r(n.throw(e))}catch(e){l(e)}}function r(e){var t;e.done?s(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(i,a)}r((n=n.apply(e,t||[])).next())}))};class c extends Error{constructor(e){super(`Session "${e}" not found`),this.name="SessionNotFoundError"}}class u extends Error{constructor(e,t){super(`Failed to load session "${e}": ${t.message}`),this.name="SessionLoadError",this.cause=t}}function v(e,t,o,v,h,p){return d(this,void 0,void 0,(function*(){const{resumeChatId:d,force:g=!1}=o,m=(0,a.r)(),f=d,C=f||t,w=(0,s.join)(m,C),y=(0,s.join)(w,"store.db");if(f&&!(0,n.existsSync)(y))throw new c(f);let b;b=f?yield r.M.initAndLoad(y):new r.M(y);const T=new l.pH(b,b);if(f)try{yield T.resetFromDb(e);const t=T.getMetadata("lastUsedModel");yield h.setModelFromStoredId(t,v.configProvider)}catch(e){throw new u(f,e instanceof Error?e:new Error(String(e)))}if(g){let e=!1;if(p){const t=yield p.getAutoRunControls();!0===(null==t?void 0:t.enabled)&&!0!==t.enableRunEverything&&(e=!0,(0,i.debugLog)("ACP session: Team admin has disabled Run Everything; proceeding with allowlist-based auto-run"))}e||T.setMetadata("mode","auto-run")}return T}))}},"./src/acp/cursor-acp-agent.ts":(e,t,o)=>{o.a(e,(async(e,n)=>{try{o.d(t,{o:()=>f});var s=o("../cursor-config/dist/index.js"),l=o("../../node_modules/.pnpm/@zed-industries+agent-client-protocol@0.4.5/node_modules/@zed-industries/agent-client-protocol/dist/acp.js"),i=o("./src/debug.ts"),a=o("./src/onboarding.tsx"),r=o("./src/utils/command-name.ts"),d=o("./src/utils/interaction-utils.ts"),c=o("./src/utils/open-browser.ts"),u=o("./src/acp/agent-session.ts"),v=o("./src/acp/agent-store.ts"),h=o("./src/acp/session-resources.ts"),p=o("./src/acp/types.ts"),g=e([a]);a=(g.then?(await g)():g)[0];var m=function(e,t,o,n){return new(o||(o=Promise))((function(s,l){function i(e){try{r(n.next(e))}catch(e){l(e)}}function a(e){try{r(n.throw(e))}catch(e){l(e)}}function r(e){var t;e.done?s(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(i,a)}r((n=n.apply(e,t||[])).next())}))};class f{constructor(e,t,o,n,s,l){this.connection=e,this.sessions=new Map,this.deps=t,this.ctx=o,this.options=n,this.sharedServices=l,this.authConfig=s,this.isAuthenticated=s.isAuthenticated}initialize(e){return m(this,void 0,void 0,(function*(){(0,i.debugLog)("ACP initialize called, isAuthenticated:",this.isAuthenticated);const e=[{id:p.fY.CURSOR_LOGIN,name:"Cursor Login",description:`Authenticate using existing Cursor login credentials. Run '${(0,r.mf)()} login' first if not logged in.`}];return{protocolVersion:l.WP,agentCapabilities:{loadSession:!0,promptCapabilities:{image:!0}},authMethods:e}}))}newSession(e){return m(this,void 0,void 0,(function*(){if(!this.isAuthenticated||!this.sharedServices)throw(0,i.debugLog)("Session creation rejected: not authenticated"),l.GI.authRequired({message:`Authentication required. Please run '${(0,r.mf)()} login' first, then call authenticate() with methodId 'cursor_login'.`});const e=crypto.randomUUID(),t=yield(0,v.it)(this.ctx,e,this.options,this.deps,this.sharedServices.modelManager,this.sharedServices.teamSettingsService),{resources:o}=yield(0,h.Y)(this.connection,e,this.sharedServices,t,this.options),n=yield this.sharedServices.modelManager.awaitCurrentModel(),s=new u.m(this.connection,e,this.sharedServices,this.ctx,t,o,n);return this.sessions.set(e,s),setTimeout((()=>{s.sendAvailableCommands().catch((e=>{console.error("Failed to send available commands:",e)}))}),0),{sessionId:e,modes:this.buildModesState(t)}}))}loadSession(e){return m(this,void 0,void 0,(function*(){if(!this.isAuthenticated||!this.sharedServices)throw(0,i.debugLog)("Session load rejected: not authenticated"),l.GI.authRequired({message:`Authentication required. Please run '${(0,r.mf)()} login' first, then call authenticate() with methodId 'cursor_login'.`});const{sessionId:t}=e;(0,i.debugLog)("ACP loadSession called for sessionId:",t);const o=Object.assign(Object.assign({},this.options),{resumeChatId:t});let n;try{n=yield(0,v.it)(this.ctx,t,o,this.deps,this.sharedServices.modelManager,this.sharedServices.teamSettingsService)}catch(e){if(e instanceof v.Ag)throw l.GI.invalidParams({message:e.message});if(e instanceof v.rY)throw l.GI.internalError({message:e.message});throw e}const{resources:s}=yield(0,h.Y)(this.connection,t,this.sharedServices,n,this.options),a=yield this.sharedServices.modelManager.awaitCurrentModel(),d=new u.m(this.connection,t,this.sharedServices,this.ctx,n,s,a);return this.sessions.set(t,d),setTimeout((()=>{d.sendAvailableCommands().catch((e=>{console.error("Failed to send available commands:",e)}))}),0),(0,i.debugLog)("ACP loadSession completed for sessionId:",t),{modes:this.buildModesState(n)}}))}setSessionMode(e){return m(this,void 0,void 0,(function*(){const t=this.sessions.get(e.sessionId);if(!t)throw new Error(`Session ${e.sessionId} not found`);const o=this.mapAcpModeToCliMode(e.modeId);if(!o)throw new Error(`Invalid mode ID: ${e.modeId}. Valid modes: agent, plan, ask`);return t.setMode(o),{}}))}mapAcpModeToCliMode(e){switch(e){case"agent":case"code":return"default";case"plan":case"architect":return"plan";case"ask":case"chat":return"search";default:return null}}buildModesState(e){const t=e.getMetadata("mode");return{currentModeId:(0,d.mb)(t),availableModes:[{id:"agent",name:"Agent",description:"Full agent capabilities with tool access"},{id:"plan",name:"Plan",description:"Read-only mode for planning and designing before implementation"},{id:"ask",name:"Ask",description:"Q&A mode - no edits or command execution"}]}}authenticate(e){return m(this,void 0,void 0,(function*(){if((0,i.debugLog)("ACP authenticate called with methodId:",e.methodId),e.methodId!==p.fY.CURSOR_LOGIN)throw l.GI.invalidParams({message:`Unknown authentication method: ${e.methodId}. Supported method: ${p.fY.CURSOR_LOGIN}`});const{credentialManager:t}=this.authConfig,o=yield(0,a.h4)(t,a.hT.LOGIN);if((0,i.debugLog)("Cursor login check result:",o),!o){(0,i.debugLog)("Starting browser login flow");const e=new s.Pl,{metadata:o,loginUrl:n}=e.startLogin();try{yield(0,c.ph)(n),(0,i.debugLog)("Browser opened for login:",n)}catch(e){throw(0,i.debugLog)("Failed to open browser:",e),l.GI.invalidParams({message:`Failed to open browser for login. Please visit: ${n}`})}(0,i.debugLog)("Waiting for login result...");const a=yield e.waitForResult(o);if(!(null==a?void 0:a.accessToken))throw l.GI.invalidParams({message:"Login failed or timed out. Please try again."});yield t.setAuthentication(a.accessToken,a.refreshToken),(0,i.debugLog)("Credentials stored successfully")}this.sharedServices||((0,i.debugLog)("Initializing shared services after authentication"),this.sharedServices=yield this.authConfig.initSharedServices()),this.isAuthenticated=!0,(0,i.debugLog)("Authentication successful")}))}prompt(e){return m(this,void 0,void 0,(function*(){const t=this.sessions.get(e.sessionId);if(!t)throw new Error(`Session ${e.sessionId} not found`);return yield t.handlePrompt(e)}))}cancel(e){return m(this,void 0,void 0,(function*(){var t;const o=this.sessions.get(e.sessionId);null===(t=null==o?void 0:o.pendingPromptCancel)||void 0===t||t.call(o)}))}}n()}catch(e){n(e)}}))},"./src/acp/run.ts":(e,t,o)=>{o.a(e,(async(e,n)=>{try{o.d(t,{w:()=>f});var s=o("../../node_modules/.pnpm/@zed-industries+agent-client-protocol@0.4.5/node_modules/@zed-industries/agent-client-protocol/dist/acp.js"),l=o("./src/analytics.ts"),i=o("./src/api-key-auth.ts"),a=o("./src/client.ts"),r=o("./src/debug.ts"),d=o("./src/onboarding.tsx"),c=o("./src/tracing.ts"),u=o("./src/utils/api-endpoint.ts"),v=o("./src/acp/cursor-acp-agent.ts"),h=o("./src/acp/shared-services.ts"),p=o("./src/acp/streams.ts"),g=e([d,v]);[d,v]=g.then?(await g)():g;var m=function(e,t,o,n){return new(o||(o=Promise))((function(s,l){function i(e){try{r(n.next(e))}catch(e){l(e)}}function a(e){try{r(n.throw(e))}catch(e){l(e)}}function r(e){var t;e.done?s(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(i,a)}r((n=n.apply(e,t||[])).next())}))};function f(e,t,o){return m(this,void 0,void 0,(function*(){const n=(0,u.G6)(t.endpoint);yield(0,c.H)({backendUrl:n,credentialManager:o.credentialManager,configProvider:o.configProvider});try{(0,a.Bu)(o.credentialManager,{endpoint:n,insecure:t.insecure,configProvider:o.configProvider})}catch(e){}const{isAuthenticated:g}=yield(0,i.D)(o.credentialManager,{authToken:t.authToken}),{isAuthenticated:f}=g?{isAuthenticated:!1}:yield(0,i.T)(o.credentialManager,{apiKey:t.apiKey,endpoint:n}),C=yield(0,d.h4)(o.credentialManager,d.hT.LOGIN),w=g||f||C;(0,r.debugLog)("ACP pre-authentication check:",{isAuthTokenAuthenticated:g,isApiKeyAuthenticated:f,isExistingLogin:C,isPreAuthenticated:w});let y=null;if(w){try{(0,l.sx)("cli.launch")}catch(e){}y=yield(0,h.Q)(e,t,o,n)}const b={credentialManager:o.credentialManager,backendUrl:n,isAuthenticated:w,initSharedServices:()=>m(this,void 0,void 0,(function*(){if(y)return y;try{(0,l.sx)("cli.launch")}catch(e){}return y=yield(0,h.Q)(e,t,o,n),y}))};process.on("unhandledRejection",((e,t)=>{}));const T=(0,p.W)(process.stdout),S=(0,p.G)(process.stdin),x=(0,s.Z2)(T,S);new s.Bi((n=>new v.o(n,o,e,t,b,y)),x),process.stdin.resume()}))}n()}catch(C){n(C)}}))},"./src/acp/session-resources.ts":(e,t,o)=>{o.d(t,{Y:()=>f});var n=o("../agent-exec/dist/index.js"),s=o("../cursor-config/dist/index.js"),l=o("../hooks-exec/dist/index.js"),i=o("../local-exec/dist/index.js"),a=o("../shell-exec/dist/index.js"),r=o("./src/always-approve-decision-provider.ts"),d=o("./src/cursor-blame/cli-ai-code-tracker.ts"),c=o("./src/shared/cli-background-work-registry.ts"),u=o("./src/shared/cli-subagent-host-adapter.ts"),v=o("./src/statsig.ts"),h=o("./src/team-hooks-sync.ts"),p=function(e,t,o,n){return new(o||(o=Promise))((function(s,l){function i(e){try{r(n.next(e))}catch(e){l(e)}}function a(e){try{r(n.throw(e))}catch(e){l(e)}}function r(e){var t;e.done?s(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(i,a)}r((n=n.apply(e,t||[])).next())}))};class g{constructor(e,t,o){this.connection=e,this.sessionId=t,this.addToAllowList=o}requestApproval(e){return p(this,void 0,void 0,(function*(){var t;if(!e.toolCallId)return{approved:!0};const{title:o,kind:n,content:s}=this.formatOperation(e),l={sessionId:this.sessionId,toolCall:{toolCallId:null!==(t=e.toolCallId)&&void 0!==t?t:`decision_${Date.now()}`,title:o,kind:n,status:"pending",content:s},options:[{optionId:"allow-once",name:"Allow once",kind:"allow_once"},{optionId:"allow-always",name:"Allow always",kind:"allow_always"},{optionId:"reject-once",name:"Reject",kind:"reject_once"}]};try{const t=yield this.connection.requestPermission(l);if("cancelled"===t.outcome.outcome)return{approved:!1,reason:"Cancelled"};if("selected"===t.outcome.outcome){const o=t.outcome.optionId,n="allow-once"===o||"allow-always"===o;return"allow-always"===o&&(yield this.persistAllowlistEntry(e)),n?{approved:!0}:{approved:!1,reason:"User rejected"}}return{approved:!1,reason:"Unknown response"}}catch(e){return{approved:!1,reason:e instanceof Error?e.message:"Request failed"}}}))}formatOperation(e){var t,o;switch(e.type){case i.S5.Write:{const n=e.details.path;return{title:e.details.isNewFile?`Write ${n}`:`Edit \`${n}\``,kind:"edit",content:[{type:"diff",path:n,oldText:null!==(t=e.details.before)&&void 0!==t?t:null,newText:null!==(o=e.details.after)&&void 0!==o?o:""}]}}case i.S5.Shell:return{title:`\`${e.details.command.replaceAll("`","\\`")}\``,kind:"execute",content:e.details.reason?[{type:"content",content:{type:"text",text:e.details.reason}}]:void 0};case i.S5.Delete:return{title:`Delete \`${e.details.path}\``,kind:"edit",content:void 0};case i.S5.Mcp:{const t=e.details.toolName;return{title:`${e.details.name}: ${t}`,kind:"other",content:[{type:"content",content:{type:"text",text:`\`\`\`json\n${JSON.stringify(e.details.args,null,2)}\n\`\`\``}}]}}default:return{title:"Unknown operation",kind:"other",content:void 0}}}persistAllowlistEntry(e){return p(this,void 0,void 0,(function*(){var t;switch(e.type){case i.S5.Shell:{const o=null!==(t=e.details.notAllowedCommands)&&void 0!==t?t:[e.details.command];for(const e of o)yield this.addToAllowList("Shell",e);break}case i.S5.Write:{const t=e.details.path;yield this.addToAllowList("Write",t);break}case i.S5.Delete:{const t=e.details.path;yield this.addToAllowList("Write",t);break}case i.S5.Mcp:{const t=`${e.details.providerIdentifier}:${e.details.toolName}`;yield this.addToAllowList("Mcp",t);break}}}))}}var m=function(e,t,o,n){return new(o||(o=Promise))((function(s,l){function i(e){try{r(n.next(e))}catch(e){l(e)}}function a(e){try{r(n.throw(e))}catch(e){l(e)}}function r(e){var t;e.done?s(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(i,a)}r((n=n.apply(e,t||[])).next())}))};function f(e,t,o,p,f){return m(this,void 0,void 0,(function*(){var p,C,w;const{force:y=!1}=f;let b=!1;if(y){const e=yield o.teamSettingsService.getAutoRunControls();b=!0===(null==e?void 0:e.enabled)&&!0!==e.enableRunEverything}const T=y&&!b?new r.I:new g(e,t,((e,t)=>m(this,void 0,void 0,(function*(){const n=`${e}(${t})`;yield o.permissionsProvider.updatePermissions((e=>{const t=e.allow.includes(n)?e.allow:[...e.allow,n];return Object.assign(Object.assign({},e),{allow:t})}))})))),S=y&&b?{getPermissions:()=>m(this,void 0,void 0,(function*(){const e=yield o.permissionsProvider.getPermissions();return Object.assign(Object.assign({},e),{approvalMode:"allowlist"})})),updatePermissions:e=>o.permissionsProvider.updatePermissions(e)}:o.permissionsProvider,x=new i.kh(o.ignoreService,T,S,o.teamSettingsService,void 0,(0,v.QF)("admin_network_controls")),k=process.cwd(),P=new i.xK,I=(0,s.Xq)(k),M=yield o.modelManager.awaitCurrentModel(),A=(0,d.L)(M),R=new d.e({workspacePath:k,conversationId:t,model:A}),_=new c.t,j=new i.Dv({pendingDecisionStore:T,fileChangeTracker:o.fileChangeTracker,gitExecutor:P,ignoreService:o.ignoreService,grepProvider:o.grepProvider,permissionsService:x,workspacePaths:[k],diagnosticsProvider:o.diagnosticsProvider,mcpLease:o.mcpLease,cursorRulesService:o.cursorRulesService,subagentsService:o.subagentsService,repositoryProvider:o.codebaseReferenceProvider,projectDir:I,getAgentSkills:e=>o.mergedAgentSkillsService.getAllAgentSkills(e),onWriteForAiTracking:e=>R.trackWrite(e),onDeleteForAiTracking:e=>R.trackDelete(e),backgroundWorkRegistry:_});j.register(n.Zn,(0,n.hv)(new u.f(o.agentClient,j,_)));const L=null===(p=o.configProvider.get().authInfo)||void 0===p?void 0:p.teamId;let $;null!=L&&o.dashboardClient&&($=(0,h.a)({dashboardClient:o.dashboardClient,teamId:L}));const U=(0,l.Ve)(I),F=new l.IF,q=new l.gY(F,U);let E=yield q.load();const D=new l.HW(E);let O,N=()=>{};$&&(O=new Promise((e=>{N=e})));const G={cursor_version:null!=="2026.02.13-41ac335"?"2026.02.13-41ac335":"1.0.0",user_email:null!==(w=null===(C=o.configProvider.get().authInfo)||void 0===C?void 0:C.email)&&void 0!==w?w:null},Q=(0,a.Fn)(),W=new l.WL(E,I,G,Q,o.promptHookClient,O);return $&&O&&$.then((e=>{if(null!=e){const t=(0,h.O)(E,e.teamHooks,e.teamDir);E=t,D.setConfig(t),W.updateConfig(t)}})).finally((()=>N())),{resources:new l.ae(j,W,(()=>({conversation_id:t,generation_id:t,model:A})),o.mcpLease,void 0,O,D),hookExecutor:W}}))}},"./src/acp/shared-services.ts":(e,t,o)=>{o.d(t,{Q:()=>b});var n=o("node:os"),s=o("node:path"),l=o.n(s),i=o("../context/dist/index.js"),a=o("../context-rpc/dist/index.js"),r=o("../cursor-config/dist/index.js"),d=o("../local-exec/dist/index.js"),c=o("../mcp-agent-exec/dist/index.js"),u=o("../proto/dist/generated/aiserver/v1/aiserver_connect.js"),v=o("../../node_modules/.pnpm/@connectrpc+connect@1.6.1_patch_hash=a4b9a5e69295313832387f25b708426bcf53041a2f50bc7b95_a276813e7efa8e1efb8a7b0efc1d56a0/node_modules/@connectrpc/connect/dist/esm/promise-client.js"),h=o("./src/client.ts"),p=o("./src/mcp/disabled-store.ts"),g=o("./src/mcp/project-paths.ts"),m=o("./src/models/index.ts"),f=o("./src/state/session.ts"),C=o("./src/statsig.ts"),w=function(e,t,o,n){return new(o||(o=Promise))((function(s,l){function i(e){try{r(n.next(e))}catch(e){l(e)}}function a(e){try{r(n.throw(e))}catch(e){l(e)}}function r(e){var t;e.done?s(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(i,a)}r((n=n.apply(e,t||[])).next())}))};const y=(0,i.h)("shared-services");function b(e,t,s,i){return w(this,void 0,void 0,(function*(){var w;const{withDiffs:b=!1,model:T}=t,S=process.cwd(),x=new d.$1(S);if(b){const{buildFileChanges:e,collectGitStatuses:t}=yield o.e(156).then(o.bind(o,"./src/utils/git-diffs.ts")),n=e(t());for(const e of n)yield x.trackChange(e.path,e.before,e.after)}const k=(0,h.OC)(s.credentialManager,{backendUrl:i,insecure:t.insecure,configProvider:s.configProvider}),P=(0,a.Zj)(u.E,k),I=(0,v.UU)(u.E,k),M=(0,r.Vi)({credentialManager:s.credentialManager,endpoint:i,configProvider:s.configProvider}),A=(0,h.ms)(s.credentialManager,i,null!==(w=t.insecure)&&void 0!==w&&w,s.configProvider),R=new d.J1(A),_=yield R.fetchServerConfig(),j=_.agentUrlConfig?{agentUrl:_.agentUrlConfig.agentUrl,agentnUrl:_.agentUrlConfig.agentnUrl}:void 0,L=(0,h.hO)(s.credentialManager,{backendUrl:i,insecure:t.insecure,requestMiddleware:(e,t)=>(f.d.recordLastRequest(e.requestId,{path:e.inner.url}),t(e)),configProvider:s.configProvider,agentEndpoint:t.agentEndpoint,serverAgentUrlConfig:j}),$=new d.xK,U=(0,g.C)(S);try{yield(0,d.Rh)(e)}catch(t){y.warn(e,"Failed to sync built-in skills",{error:t})}const F=()=>!0,q=new d.KO(e,$,S,!1,F,void 0),E=new d.EV(e,[S],(0,n.homedir)(),void 0,F),D=new d.Px([q,E]),O=new d.NB([E]),N=new d.o_([new d.Vz(S,F),new d.di(D)]),G=new d.w(new d.zM(M),{getDefaultNetworkAllowlist:()=>Promise.resolve((0,C.z)("sandbox_default_network_allowlist","allowlist",[]))}),Q=new p.P(U.disabledPath),W=r.aK.init(G,U.projectRoot,U.projectDir,!1,Q),B=new d.E1($,G),z=yield m.P3.init(I,{configProvider:s.configProvider,initialModel:T}),K=yield W.load(e),Y=new c.uz(K),V=[],H=new r.QX(s.configProvider);V.push(H);const Z=yield r.N2.loadFromPath(l().join(U.projectRoot,".claude","settings.json"));Z&&V.push(Z);const J=yield r.N2.loadFromPath(l().join((0,n.homedir)(),".claude","settings.json"));J&&V.push(J);const X=new r.Ol(V),ee=(0,h.Np)(P);return{modelManager:z,agentClient:L,mcpLease:Y,fileChangeTracker:x,ignoreService:B,permissionsProvider:X,teamSettingsService:G,cursorRulesService:D,mergedAgentSkillsService:O,subagentsService:N,diagnosticsProvider:s.diagnosticsProvider,codebaseReferenceProvider:s.codebaseReferenceProvider,grepProvider:{executeIndexedGrep:void 0},promptHookClient:ee,configProvider:s.configProvider,dashboardClient:M}}))}},"./src/acp/streams.ts":(e,t,o)=>{o.d(t,{G:()=>l,W:()=>s});var n=o("node:stream/web");function s(e){return new n.WritableStream({write:t=>new Promise(((o,n)=>{e.write(Buffer.from(t),(e=>{e?n(e):o()}))}))})}function l(e){return new n.ReadableStream({start(t){e.on("data",(e=>{t.enqueue(new Uint8Array(e))})),e.on("end",(()=>t.close())),e.on("error",(e=>t.error(e)))}})}},"./src/acp/types.ts":(e,t,o)=>{o.d(t,{DG:()=>n,Yg:()=>l,ZT:()=>r,ax:()=>s,b8:()=>a,fY:()=>d,hK:()=>i});const n={shellToolCall:"execute",deleteToolCall:"delete",globToolCall:"search",grepToolCall:"search",readToolCall:"read",updateTodosToolCall:"other",readTodosToolCall:"read",editToolCall:"edit",lsToolCall:"search",readLintsToolCall:"read",mcpToolCall:"other",semSearchToolCall:"search",createPlanToolCall:"other",webSearchToolCall:"search",taskToolCall:"other",listMcpResourcesToolCall:"read",readMcpResourceToolCall:"read",applyAgentDiffToolCall:"edit",askQuestionToolCall:"think",fetchToolCall:"fetch",switchModeToolCall:"switch_mode",generateImageToolCall:"other",recordScreenToolCall:"other",computerUseToolCall:"execute",writeShellStdinToolCall:"execute",reflectToolCall:"think",setupVmEnvironmentToolCall:"execute",truncatedToolCall:"other",startGrindExecutionToolCall:"execute",startGrindPlanningToolCall:"think",webFetchToolCall:"fetch",reportBugfixResultsToolCall:"other"},s="cursor/ask_question",l="cursor/create_plan",i="cursor/update_todos",a="cursor/task",r="cursor/generate_image",d={CURSOR_LOGIN:"cursor_login"}},"./src/commands/acp.ts":(e,t,o)=>{o.a(e,(async(e,n)=>{try{o.r(t),o.d(t,{runAcp:()=>s.w});var s=o("./src/acp/run.ts"),l=e([s]);s=(l.then?(await l)():l)[0],n()}catch(e){n(e)}}))}};