try{!function(){var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:{},t=(new e.Error).stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="1bc7f7d4-ec7a-4f79-ba4b-4b7a9bea214f",e._sentryDebugIdIdentifier="sentry-dbid-1bc7f7d4-ec7a-4f79-ba4b-4b7a9bea214f")}()}catch(e){}!function(){try{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:{}).SENTRY_RELEASE={id:"agent-cli@2026.01.28-fd13201"}}catch(e){}}(),exports.id=357,exports.ids=[357],exports.modules={"../hooks-exec/dist/index.js":(e,t,o)=>{o.d(t,{WL:()=>g,_E:()=>s._E,gY:()=>w,ae:()=>Oe,HW:()=>b,IF:()=>P,HG:()=>y,Ve:()=>k,jv:()=>x});var s=o("../hooks/dist/index.js"),r=o("node:fs/promises"),n=o("node:os"),a=o("node:path"),c=o("../context/dist/index.js"),i=o("../utils/dist/index.js");class u extends Error{reason;failureType="permission_denied";constructor(e){super(`Hook denied: ${e}`),this.name="HookDeniedError",this.reason=e}}class l extends Error{reason;failureType="error";cause;constructor(e,t){super(`Hook failed (fail-closed): ${e}`),this.name="FailClosedError",this.reason=e,this.cause=t}}const d="To view or modify configured hooks, go to Cursor Settings > Hooks.";function p(e){return`Tool blocked because this hook is configured to fail closed (block when it fails). ${e}`}function h(e,t){return`${t?`${e} was blocked by a hook: ${t}`:`${e} was blocked by a hook.`}\n\n${d}`}function f(e){return function(e){return e instanceof u}(e)||function(e){return e instanceof l}(e)}class g{workspacePath;globalContext;shellExecutor;promptHookClient;teamHooksReadyPromise;sessionEnv;config;constructor(e,t,o,s,r,n){this.workspacePath=t,this.globalContext=o,this.shellExecutor=s,this.promptHookClient=r,this.teamHooksReadyPromise=n,this.config=e}updateConfig(e){this.config=e}setSessionEnvironment(e){this.sessionEnv=Object.assign(Object.assign({},this.sessionEnv),e)}clearSessionEnvironment(){this.sessionEnv=void 0}async getTranscriptPathIfExists(e){try{const t=(0,i.Rv)((0,n.homedir)(),this.workspacePath),o=(0,a.join)(t,i.O2),s=(0,i.sh)(e),c=(0,a.join)(o,`${s}.txt`);return await(0,r.access)(c),c}catch(e){return null}}hasHooksForStep(e){return[this.config.enterpriseHooks,this.config.teamHooks,this.config.userHooks,this.config.projectHooks,this.config.claudeUserHooks,this.config.claudeProjectHooks,this.config.claudeProjectLocalHooks].some((t=>{const o=null==t?void 0:t.hooks[e];return void 0!==o&&o.length>0}))}hasFailClosedHooksForStep(e,t){const o=[this.config.enterpriseHooks,this.config.teamHooks,this.config.projectHooks,this.config.userHooks];for(const r of o){const o=null==r?void 0:r.hooks[e];if(o&&(t?(0,s.Qk)(o,t):o).some((e=>!0===e.failClosed)))return!0}return!1}getCwdForSource(e){var t,o,s,r;const n=this.config.configDirs;switch(e){case"enterprise":return null!==(t=null==n?void 0:n.enterprise)&&void 0!==t?t:this.workspacePath;case"team":return null!==(o=null==n?void 0:n.team)&&void 0!==o?o:this.workspacePath;case"project":case"claude-project":case"claude-project-local":case"claude-plugin":default:return this.workspacePath;case"user":return null!==(s=null==n?void 0:n.user)&&void 0!==s?s:this.workspacePath;case"claude-user":return null!==(r=null==n?void 0:n.claudeUser)&&void 0!==r?r:this.workspacePath}}buildHookEnvironment(e){return Object.assign(Object.assign(Object.assign(Object.assign({CURSOR_PROJECT_DIR:this.workspacePath,CURSOR_VERSION:this.globalContext.cursor_version},this.globalContext.user_email&&{CURSOR_USER_EMAIL:this.globalContext.user_email}),e&&{CURSOR_TRANSCRIPT_PATH:e}),{CLAUDE_PROJECT_DIR:this.workspacePath}),this.sessionEnv)}shouldSkipHookDueToLoopLimit(e,t,o){if("stop"!==e&&"subagentStop"!==e)return!1;const r=o.loop_count,n=t.loop_limit;return null!==n&&(void 0===n?r>=s.aX:r>=n)}async executeHookForStep(e,t){var o,r,n,a,c,i,u;this.teamHooksReadyPromise&&await this.teamHooksReadyPromise;const l=t,d=l.conversation_id?await this.getTranscriptPathIfExists(l.conversation_id):null;let p;if(e===s._E.subagentStop){const e=t;p=e.subagent_id?await this.getTranscriptPathIfExists(e.subagent_id):null}const h=Object.assign(Object.assign(Object.assign({},t),{hook_event_name:e,cursor_version:this.globalContext.cursor_version,workspace_roots:[this.workspacePath],user_email:this.globalContext.user_email,transcript_path:d}),e===s._E.subagentStop&&{agent_transcript_path:null!=p?p:null}),f=(0,s.bi)(e,h),g=[],m=(e,t)=>{if(!e)return;const o=(0,s.Qk)(e,f),r=this.getCwdForSource(t);for(const e of o)(0,s.uu)(e)?this.promptHookClient&&g.push({type:"prompt",script:e,source:t}):(0,s.Xz)(e)&&g.push({type:"command",script:e,cwd:r,source:t})};if(m(null===(o=this.config.enterpriseHooks)||void 0===o?void 0:o.hooks[e],"enterprise"),m(null===(r=this.config.teamHooks)||void 0===r?void 0:r.hooks[e],"team"),m(null===(n=this.config.projectHooks)||void 0===n?void 0:n.hooks[e],"project"),m(null===(a=this.config.userHooks)||void 0===a?void 0:a.hooks[e],"user"),m(null===(c=this.config.claudeProjectLocalHooks)||void 0===c?void 0:c.hooks[e],"claude-project-local"),m(null===(i=this.config.claudeProjectHooks)||void 0===i?void 0:i.hooks[e],"claude-project"),m(null===(u=this.config.claudeUserHooks)||void 0===u?void 0:u.hooks[e],"claude-user"),0!==g.length)return this.executeAllAndMerge(e,g,h)}async executeAllAndMerge(e,t,o){const r=t.map((async(t,r)=>{const{source:n}=t;try{return"prompt"===t.type?this.executePromptHook(e,t.script,o,n,r):this.executeCommandHook(e,t.script,t.cwd,o,n,r)}catch(o){if(!0===t.script.failClosed){const t=p(`Hook execution failed: ${o instanceof Error?o.message:String(o)}`),a=(0,s.FS)(e,t);if(a)return{success:!0,data:a,source:n,index:r}}return{success:!1,source:n,index:r}}})),n=await Promise.all(r),a=[];for(const e of n)e.success&&void 0!==e.data&&a.push(e.data);return(0,s.wb)(e,a)}async executeCommandHook(e,t,o,r,n,a){if(this.shouldSkipHookDueToLoopLimit(e,t,r))return{success:!1,source:n,index:a};let c;try{c=await this.executeCommandScript({script:t,cwd:o,request:r})}catch(o){if(!0===t.failClosed){const r=o instanceof Error?o.message:String(o),c=p(`Hook "${t.command}" execution failed: ${r}`),i=(0,s.FS)(e,c);if(i)return{success:!0,data:i,source:n,index:a}}return{success:!1,source:n,index:a}}if(c.exitCode===s.LQ){const o=(0,s.Uv)(c.stdout,c.stderr,t.command),r=(0,s.FS)(e,o);return r?{success:!0,data:r,source:n,index:a}:{success:!1,source:n,index:a}}if(0!==c.exitCode&&null!==c.exitCode){if(!0===t.failClosed){const o=p(`Hook "${t.command}" failed with exit code ${c.exitCode}${c.stderr?`: ${c.stderr.trim()}`:""}`),r=(0,s.FS)(e,o);if(r)return{success:!0,data:r,source:n,index:a}}return{success:!1,source:n,index:a}}const i=c.stdout.trim();if(!i){if(!0===t.failClosed){const o=p(`Hook "${t.command}" returned no output.`),r=(0,s.FS)(e,o);if(r)return{success:!0,data:r,source:n,index:a}}return{success:!1,source:n,index:a}}try{const o=JSON.parse(i),r=(0,s.jO)(e,o);if(r.success)return{success:!0,data:r.data,source:n,index:a};if(!0===t.failClosed){const o=p(`Hook "${t.command}" returned invalid response.`),r=(0,s.FS)(e,o);if(r)return{success:!0,data:r,source:n,index:a}}return{success:!1,source:n,index:a}}catch(o){if(!0===t.failClosed){const o=p(`Hook "${t.command}" returned invalid JSON.`),r=(0,s.FS)(e,o);if(r)return{success:!0,data:r,source:n,index:a}}return{success:!1,source:n,index:a}}}async executePromptHook(e,t,o,r,n){var a,i;if(this.shouldSkipHookDueToLoopLimit(e,t,o))return{success:!1,source:r,index:n};if(!this.promptHookClient)return{success:!1,source:r,index:n};const u=1e3*(null!==(a=t.timeout)&&void 0!==a?a:s.yB),l=(0,c.q6)(),[d,h]=l.withTimeoutAndCancel(u);try{const a=JSON.parse(JSON.stringify(o)),c=await this.promptHookClient.evaluatePromptHook(d,{prompt:t.prompt,hookInputJson:a,modelName:t.model});if(c.ok){const t=(0,s.D3)(e);return t?{success:!0,data:t,source:r,index:n}:{success:!1,source:r,index:n}}{const t=null!==(i=c.reason)&&void 0!==i?i:"Prompt hook blocked this action",o=(0,s.FS)(e,t);return o?{success:!0,data:o,source:r,index:n}:{success:!1,source:r,index:n}}}catch(o){if(!0===t.failClosed){const t=p(`Prompt hook failed: ${o instanceof Error?o.message:String(o)}`),a=(0,s.FS)(e,t);if(a)return{success:!0,data:a,source:r,index:n}}return{success:!1,source:r,index:n}}finally{h()}}async executeCommandScript(e){var t;const{script:o,cwd:r,request:n}=e,a=1e3*(null!==(t=o.timeout)&&void 0!==t?t:s.yB),i=Date.now(),u=JSON.stringify(n),l=new AbortController,d=setTimeout((()=>{l.abort()}),a);try{let e;e=`${o.command} <<'CURSOR_HOOK_EOF'\n${u}\nCURSOR_HOOK_EOF`;const t=n,s=this.buildHookEnvironment(t.transcript_path),a={};for(const[e,t]of Object.entries(s))void 0!==t&&(a[e]=t);const p=(0,c.q6)();let h="",f="",g=null;for await(const t of this.shellExecutor.execute(p,e,{workingDirectory:r,signal:l.signal,sandboxPolicy:{type:"insecure_none"},env:a}))switch(t.type){case"stdout":h+=t.data;break;case"stderr":f+=t.data;break;case"exit":g=t.code}return clearTimeout(d),{stdout:h,stderr:f,exitCode:g,duration:Date.now()-i}}catch(e){if(clearTimeout(d),Date.now(),l.signal.aborted)throw new Error(`Hook script timed out after ${a}ms`);throw e}}}function m(e){switch(null!=e?e:(0,n.platform)()){case"darwin":return a.join("/Library","Application Support","Cursor","hooks.json");case"win32":return a.join("C:\\","ProgramData","Cursor","hooks.json");default:return a.join("/etc","cursor","hooks.json")}}function k(e,t){const o={enterpriseConfigPath:m(),userConfigPath:a.join((0,n.homedir)(),".cursor","hooks.json"),projectConfigPath:a.join(e,".cursor","hooks.json")};return(null==t?void 0:t.claudeCodeHooksEnabled)?Object.assign(Object.assign({},o),{claudeUserConfigPath:a.join((0,n.homedir)(),".claude","settings.json"),claudeProjectConfigPath:a.join(e,".claude","settings.json"),claudeProjectLocalConfigPath:a.join(e,".claude","settings.local.json")}):o}function x(e){return[e.enterpriseHooks,e.teamHooks,e.userHooks,e.projectHooks,e.claudeUserHooks,e.claudeProjectHooks,e.claudeProjectLocalHooks].some((e=>function(e){return!!(null==e?void 0:e.hooks)&&Object.keys(e.hooks).length>0}(e)))}class w{fileReader;paths;logger;constructor(e,t,o){this.fileReader=e,this.paths=t,this.logger=o||{warn:e=>console.warn(`[hooks] ${e}`),info:e=>{}}}async load(e={}){const{loadProjectHooks:t=!0,loadClaudeHooks:o=!0}=e,s={errors:[],configDirs:{}},r=async(e,t,o,r,n,c,i)=>{if(e)try{if(!await this.fileReader.exists(e))return;const c=await this.fileReader.readFile(e);if(!c)return;const{config:u,error:l}=i(c);u?(s[o]=u,((e,t)=>{s.configDirs[e]=a.dirname(t)})(r,e)):l&&s.errors.push({source:t,message:`${n} at ${e}: ${l}`})}catch(e){s.errors.push({source:t,message:`Error accessing ${c} config file: ${String(e)}`})}},n=[{path:this.paths.enterpriseConfigPath,source:"enterprise",resultKey:"enterpriseHooks",configDirKey:"enterprise",parsePrefix:"Enterprise hooks.json",accessLabel:"enterprise"},{path:this.paths.teamConfigPath,source:"team",resultKey:"teamHooks",configDirKey:"team",parsePrefix:"Team hooks.json",accessLabel:"team"},{path:this.paths.userConfigPath,source:"user",resultKey:"userHooks",configDirKey:"user",parsePrefix:"User hooks.json",accessLabel:"user"},{path:t?this.paths.projectConfigPath:void 0,source:"project",resultKey:"projectHooks",configDirKey:"project",parsePrefix:"Project hooks.json",accessLabel:"project"}];for(const e of n)await r(e.path,e.source,e.resultKey,e.configDirKey,e.parsePrefix,e.accessLabel,(t=>this.parseAndValidate(t,e.source)));if(o){const e=[{path:this.paths.claudeUserConfigPath,source:"claude-user",resultKey:"claudeUserHooks",configDirKey:"claudeUser",label:"user"},{path:t?this.paths.claudeProjectConfigPath:void 0,source:"claude-project",resultKey:"claudeProjectHooks",configDirKey:"claudeProject",label:"project"},{path:t?this.paths.claudeProjectLocalConfigPath:void 0,source:"claude-project-local",resultKey:"claudeProjectLocalHooks",configDirKey:"claudeProjectLocal",label:"project local"}];for(const t of e)await r(t.path,t.source,t.resultKey,t.configDirKey,`Claude ${t.label} settings.json`,`Claude ${t.label}`,(e=>this.parseClaudeConfig(e,t.source)))}return this.dedupeClaudeHooksAgainstCursorHooks(s),s}getHookKey(e){return(0,s.uu)(e)?`prompt:${e.prompt}`:`command:${e.command}`}dedupeClaudeHooksAgainstCursorHooks(e){const t=[e.enterpriseHooks,e.teamHooks,e.userHooks,e.projectHooks],o=new Map;for(const e of t)if(null==e?void 0:e.hooks)for(const[t,s]of Object.entries(e.hooks)){if(!s)continue;let e=o.get(t);e||(e=new Set,o.set(t,e));for(const t of s)e.add(this.getHookKey(t))}const s=(e,t)=>{if(null==e?void 0:e.hooks)for(const[s,r]of Object.entries(e.hooks)){if(!r)continue;const n=o.get(s);if(!n||0===n.size)continue;const a=r.filter((e=>{const o=this.getHookKey(e);return!n.has(o)||(this.logger.info(`Removed duplicate ${t} hook for ${s}: ${o}`),!1)}));a.length!==r.length&&(e.hooks[s]=a)}};s(e.claudeUserHooks,"claude-user"),s(e.claudeProjectHooks,"claude-project"),s(e.claudeProjectLocalHooks,"claude-project-local")}parseClaudeConfig(e,t){try{const t=JSON.parse(e);if(!(0,s.DP)(t))return{};const o=(0,s.eg)(t);if(!o||0===Object.keys(o).length)return{};const r=(0,s.sl)(o,this.logger),n=(0,s.RV)(r);return n.isValid?{config:r}:{error:`Invalid transformed config: ${n.errors.join("; ")}`}}catch(e){return{error:`Failed to parse JSON: ${String(e)}`}}}parseAndValidate(e,t){try{const o=this.parseJSONC(e),r=(0,s.RV)(o);if(!r.isValid)return{error:`Invalid ${t} config: ${r.errors.join("; ")}`};const n=o;return n.hooks?{config:n}:{error:`Invalid ${t} config: missing 'hooks' property`}}catch(e){return{error:`Failed to parse ${t} config JSON: ${String(e)}`}}}parseJSONC(e){let t=e.replace(/\/\/.*$/gm,"");return t=t.replace(/\/\*[\s\S]*?\*\//g,""),JSON.parse(t)}static getConfiguredSteps(e){const t=new Set,o=[e.enterpriseHooks,e.teamHooks,e.userHooks,e.projectHooks,e.claudeUserHooks,e.claudeProjectHooks,e.claudeProjectLocalHooks];for(const e of o)if(null==e?void 0:e.hooks)for(const o of Object.keys(e.hooks))t.add(o);return t}}class y{config;configuredSteps;constructor(e){this.config=e,this.configuredSteps=w.getConfiguredSteps(e)}getConfig(){return this.config}hasHookForStep(e){return this.configuredSteps.has(e)}getConfiguredSteps(){return new Set(this.configuredSteps)}}class b{config;configuredSteps;constructor(e){this.config=e,this.configuredSteps=w.getConfiguredSteps(e)}getConfig(){return this.config}hasHookForStep(e){return this.configuredSteps.has(e)}getConfiguredSteps(){return new Set(this.configuredSteps)}setConfig(e){this.config=e,this.configuredSteps=w.getConfiguredSteps(e)}}var v=o("node:crypto"),E=o("node:perf_hooks");const _=(0,c.h)("generic-hooks"),j=e=>Math.round(1e3*e)/1e3;function H(e,t,o,r,n){var a,c,i,u;const l=r(e),d=null!==(i=null===(a=n.getToolCallId)||void 0===a?void 0:a.call(n,t))&&void 0!==i?i:(0,v.randomUUID)(),p=null!==(u=null===(c=n.getExtraHookFields)||void 0===c?void 0:c.call(n,t))&&void 0!==u?u:{},h={baseHookRequest:l,toolUseId:d,toolInput:n.createToolInput(t),extraHookFields:p},f=function(e,t,o,r){let{toolInput:n,extraHookFields:a}=r;const{baseHookRequest:c,toolUseId:i}=r;return{fireFailure:(r,u,l,d=!1)=>{t.executeHookForStep(s._E.postToolUseFailure,Object.assign(Object.assign(Object.assign({},c),{tool_name:o,tool_input:n,error_message:u,failure_type:l,duration:r,tool_use_id:i,is_interrupt:d}),a)).catch((t=>{_.warn(e,"postToolUseFailure hook error",{toolName:o,error:t instanceof Error?t.message:String(t)})}))},fireSuccess:(r,u)=>{t.executeHookForStep(s._E.postToolUse,Object.assign(Object.assign(Object.assign({},c),{tool_name:o,tool_input:n,tool_output:u,duration:r,tool_use_id:i}),a)).catch((t=>{_.warn(e,"postToolUse hook error",{toolName:o,error:t instanceof Error?t.message:String(t)})}))},getToolInput:()=>n,setToolInput:e=>{n=e},setExtraHookFields:e=>{a=e,r.extraHookFields=e}}}(e,o,n.toolName,h);return{hookContext:h,helpers:f}}async function S(e,t,o,r,n,a,c,i){var u,l;const{baseHookRequest:d,toolUseId:h,extraHookFields:g}=r;try{const e=await o.executeHookForStep(s._E.preToolUse,Object.assign(Object.assign(Object.assign({},d),{tool_name:a.toolName,tool_input:n.getToolInput(),tool_use_id:h}),g));if("deny"===(null==e?void 0:e.permission)){const o=e.user_message||`${a.toolName} blocked by preToolUse hook`;return n.fireFailure(0,o,"permission_denied"),{type:"rejected",result:c(t,o),reason:o}}(null==e?void 0:e.updated_input)&&a.applyUpdatedInput&&(a.applyUpdatedInput(t,e.updated_input),n.setToolInput(a.createToolInput(t)),a.getExtraHookFields&&n.setExtraHookFields(a.getExtraHookFields(t)))}catch(r){if(null!==(l=null===(u=o.hasFailClosedHooksForStep)||void 0===u?void 0:u.call(o,s._E.preToolUse,a.toolName))&&void 0!==l&&l){const e=p(`preToolUse hook failed: ${r instanceof Error?r.message:"preToolUse hook error"}`);return n.fireFailure(0,e,"error"),{type:"rejected",result:c(t,e),reason:e}}_.warn(e,"preToolUse hook error",{toolName:a.toolName,error:r instanceof Error?r.message:String(r)})}if(i)try{const s=await i({ctx:e,args:t,baseHookRequest:d,hookExecutor:o,toolInput:n.getToolInput(),toolUseId:h,extraHookFields:r.extraHookFields});if(void 0!==s){const e="Pre-execution hook returned rejection";return n.fireFailure(0,e,"permission_denied"),{type:"rejected",result:s,reason:e}}}catch(e){if(f(e))return n.fireFailure(0,e.reason,e.failureType),{type:"rejected",result:c(t,e.reason),reason:e.reason};throw e}return{type:"continue"}}function C(e){return e.toolCallId}function R(e,t,o,s){return{async execute(r,n,a){var c,i,u,l,d,p,h,g,m,k;const{hookContext:x,helpers:w}=H(r,n,t,o,s);let y;try{y=await S(r,n,t,x,w,s,s.createRejectedResult,s.runPreExecutionHooks)}catch(e){throw null===(c=s.runCleanup)||void 0===c||c.call(s,x.toolUseId),e}if("rejected"===y.type)return null===(i=s.runCleanup)||void 0===i||i.call(s,x.toolUseId),y.result;const b=E.performance.now();try{const o=await e.execute(r,n,a),c=j(E.performance.now()-b);if(s.runPostExecutionHooks)try{const e=await s.runPostExecutionHooks({ctx:r,args:n,result:o,baseHookRequest:x.baseHookRequest,hookExecutor:t,toolInput:w.getToolInput(),toolUseId:x.toolUseId,executionDurationMs:c,extraHookFields:x.extraHookFields});if(void 0!==e)return w.fireSuccess(c,JSON.stringify(s.createSuccessOutput(n,e))),null===(u=s.runCleanup)||void 0===u||u.call(s,x.toolUseId),e}catch(e){if(f(e))return w.fireFailure(c,e.reason,e.failureType),null===(l=s.runCleanup)||void 0===l||l.call(s,x.toolUseId),s.createRejectedResult(n,e.reason);_.warn(r,"postExecutionHooks error",{toolName:s.toolName,error:e instanceof Error?e.message:String(e)})}return s.isSuccess(o)?w.fireSuccess(c,JSON.stringify(s.createSuccessOutput(n,o))):w.fireFailure(c,s.getErrorMessage(o),null!==(m=null===(d=s.getFailureType)||void 0===d?void 0:d.call(s,o))&&void 0!==m?m:"error",null!==(k=null===(p=s.isInterrupt)||void 0===p?void 0:p.call(s,o))&&void 0!==k&&k),null===(h=s.runCleanup)||void 0===h||h.call(s,x.toolUseId),o}catch(e){const t=j(E.performance.now()-b);throw w.fireFailure(t,e instanceof Error?e.message:String(e),"error"),null===(g=s.runCleanup)||void 0===g||g.call(s,x.toolUseId),e}}}}class P{async readFile(e){try{return await r.readFile(e,"utf-8")}catch(e){if("ENOENT"===(null==e?void 0:e.code))return;throw e}}async exists(e){try{return await r.access(e),!0}catch(e){return!1}}}var O=o("../proto/dist/generated/agent/v1/request_context_exec_pb.js");class F{innerExecutor;hooksAdditionalContextPromise;teamHooksReadyPromise;hooksConfigLease;constructor(e,t,o,s){this.innerExecutor=e,this.hooksAdditionalContextPromise=t,this.teamHooksReadyPromise=o,this.hooksConfigLease=s}async execute(e,t){this.teamHooksReadyPromise&&await this.teamHooksReadyPromise;const o=await this.innerExecutor.execute(e,t),s=await this.hooksAdditionalContextPromise,r=this.hooksConfigLease?new O.Jy({configuredSteps:Array.from(this.hooksConfigLease.getConfiguredSteps())}):void 0;if("success"===o.result.case&&(s||r)){const e=o.result.value.requestContext,t=new O.bb(Object.assign(Object.assign(Object.assign({},e),s&&{hooksAdditionalContext:s}),r&&{hooksConfig:r}));return new O._G({result:{case:"success",value:new O.yW({requestContext:t})}})}return o}}var T=o("../agent-exec/dist/index.js"),I=o("../proto/dist/generated/agent/v1/background_shell_exec_pb.js"),U=o("../proto/dist/generated/agent/v1/shell_exec_pb.js"),N=o("../proto/dist/generated/agent/v1/sandbox_pb.js");function D(e){return!!e&&e.type!==N.v.INSECURE_NONE&&e.type!==N.v.UNSPECIFIED}const q="Shell",$={toolName:q,getToolCallId:C,createToolInput:e=>{const t=e.workingDirectory||"";return{command:e.command,cwd:t}},applyUpdatedInput:(e,t)=>{"string"==typeof t.command&&(e.command=t.command),"string"==typeof t.cwd&&(e.workingDirectory=t.cwd)},createRejectedResult:(e,t)=>new I.Lt({result:{case:"rejected",value:new U.pZ({command:e.command,workingDirectory:e.workingDirectory,reason:t})}}),isSuccess:e=>"success"===e.result.case,getErrorMessage:e=>{switch(e.result.case){case"error":return e.result.value.error||"BackgroundShell error";case"rejected":return e.result.value.reason||"BackgroundShell rejected";case"permissionDenied":return"Permission denied";default:return"Unknown error"}},createSuccessOutput:(e,t)=>"success"===t.result.case?{shell_id:t.result.value.shellId,pid:t.result.value.pid}:{success:!0},getExtraHookFields:e=>({cwd:e.workingDirectory||""}),runPreExecutionHooks:async e=>{const{args:t,baseHookRequest:o,hookExecutor:r}=e,n=t.workingDirectory||"",a=D(t.sandboxPolicy),c=await r.executeHookForStep(s._E.beforeShellExecution,Object.assign(Object.assign({},o),{command:t.command,cwd:n,sandbox:a}));if("deny"===(null==c?void 0:c.permission)){const e=h("Command execution",c.user_message);throw new u(e)}}};class L{wrappedExecutor;constructor(e,t,o){this.wrappedExecutor=R(e,t,o,$)}execute(e,t,o){return this.wrappedExecutor.execute(e,t,o)}}const M={toolName:"WriteShellStdin",createToolInput:e=>({shell_id:e.shellId,chars_length:e.chars.length}),createRejectedResult:(e,t)=>new I.nt({result:{case:"error",value:new I.Gv({error:t})}}),isSuccess:e=>"success"===e.result.case,getErrorMessage:e=>"error"===e.result.case?e.result.value.error||"WriteShellStdin error":"Unknown error",createSuccessOutput:e=>({shell_id:e.shellId,success:!0})};class A{wrappedExecutor;constructor(e,t,o){this.wrappedExecutor=R(e,t,o,M)}execute(e,t,o){return this.wrappedExecutor.execute(e,t,o)}}var J=o("../proto/dist/generated/agent/v1/computer_use_tool_pb.js");const K={toolName:"ComputerUse",getToolCallId:C,createToolInput:e=>({actions_count:e.actions.length}),createRejectedResult:(e,t)=>new J.ks({result:{case:"error",value:new J.Jb({error:t})}}),isSuccess:e=>"success"===e.result.case,getErrorMessage:e=>"error"===e.result.case?e.result.value.error||"ComputerUse error":"Unknown error",createSuccessOutput:(e,t)=>"success"===t.result.case?{action_count:t.result.value.actionCount,duration_ms:t.result.value.durationMs}:{success:!0}};class W{wrappedExecutor;constructor(e,t,o){this.wrappedExecutor=R(e,t,o,K)}execute(e,t,o){return this.wrappedExecutor.execute(e,t,o)}}var z=o("../proto/dist/generated/agent/v1/delete_exec_pb.js");const B={toolName:"Delete",getToolCallId:C,createToolInput:e=>({file_path:e.path}),applyUpdatedInput:(e,t)=>{"string"==typeof t.file_path&&(e.path=t.file_path)},createRejectedResult:(e,t)=>new z.Pi({result:{case:"rejected",value:new z.iq({path:e.path,reason:t})}}),isSuccess:e=>"success"===e.result.case,getErrorMessage:e=>{switch(e.result.case){case"fileNotFound":return`File not found: ${e.result.value.path}`;case"notFile":return`Not a file: ${e.result.value.path}`;case"permissionDenied":return`Permission denied: ${e.result.value.path}`;case"fileBusy":return`File busy: ${e.result.value.path}`;case"rejected":return e.result.value.reason||"Delete rejected";case"error":return e.result.value.error||"Delete error";default:return"Unknown error"}},createSuccessOutput:e=>({file_path:e.path,deleted:!0})};class Z{wrappedExecutor;constructor(e,t,o){this.wrappedExecutor=R(e,t,o,B)}execute(e,t,o){return this.wrappedExecutor.execute(e,t,o)}}var Q=o("../proto/dist/generated/agent/v1/diagnostics_exec_pb.js");const V={toolName:"ReadLints",getToolCallId:C,createToolInput:e=>({file_path:e.path}),applyUpdatedInput:(e,t)=>{"string"==typeof t.file_path&&(e.path=t.file_path)},createRejectedResult:(e,t)=>new Q.Ek({result:{case:"rejected",value:new Q.J6({path:e.path,reason:t})}}),isSuccess:e=>"success"===e.result.case,getErrorMessage:e=>{switch(e.result.case){case"error":return e.result.value.error||"Diagnostics error";case"rejected":return e.result.value.reason||"Diagnostics rejected";case"fileNotFound":return`File not found: ${e.result.value.path}`;case"permissionDenied":return`Permission denied: ${e.result.value.path}`;default:return"Unknown error"}},createSuccessOutput:(e,t)=>"success"===t.result.case?{file_path:e.path,diagnostics_count:t.result.value.totalDiagnostics}:{file_path:e.path,success:!0}};class G{wrappedExecutor;constructor(e,t,o){this.wrappedExecutor=R(e,t,o,V)}execute(e,t,o){return this.wrappedExecutor.execute(e,t,o)}}var Y=o("../proto/dist/generated/agent/v1/fetch_exec_pb.js");const X={toolName:"Fetch",getToolCallId:C,createToolInput:e=>({url:e.url}),applyUpdatedInput:(e,t)=>{"string"==typeof t.url&&(e.url=t.url)},createRejectedResult:(e,t)=>new Y.uN({result:{case:"error",value:new Y.fk({url:e.url,error:t})}}),isSuccess:e=>"success"===e.result.case,getErrorMessage:e=>"error"===e.result.case?e.result.value.error||"Fetch error":"Unknown error",createSuccessOutput:(e,t)=>"success"===t.result.case?{url:e.url,status_code:t.result.value.statusCode,content_length:t.result.value.content.length}:{url:e.url,success:!0}};class ee{wrappedExecutor;constructor(e,t,o){this.wrappedExecutor=R(e,t,o,X)}execute(e,t,o){return this.wrappedExecutor.execute(e,t,o)}}var te=o("../proto/dist/generated/agent/v1/grep_exec_pb.js");const oe={toolName:"Grep",getToolCallId:C,createToolInput:e=>({pattern:e.pattern,file_path:e.path,glob:e.glob,output_mode:e.outputMode}),applyUpdatedInput:(e,t)=>{"string"==typeof t.pattern&&(e.pattern=t.pattern),"string"==typeof t.file_path&&(e.path=t.file_path)},createRejectedResult:(e,t)=>new te.Ud({result:{case:"error",value:new te.ts({error:t})}}),isSuccess:e=>"success"===e.result.case,getErrorMessage:e=>"error"===e.result.case?e.result.value.error||"Grep error":"Unknown error",createSuccessOutput:e=>({pattern:e.pattern,success:!0})};class se{wrappedExecutor;constructor(e,t,o){this.wrappedExecutor=R(e,t,o,oe)}execute(e,t,o){return this.wrappedExecutor.execute(e,t,o)}}var re=o("../proto/dist/generated/agent/v1/ls_exec_pb.js");const ne={toolName:"List",getToolCallId:C,createToolInput:e=>({file_path:e.path,ignore:e.ignore}),applyUpdatedInput:(e,t)=>{"string"==typeof t.file_path&&(e.path=t.file_path)},createRejectedResult:(e,t)=>new re.fv({result:{case:"rejected",value:new re.k2({path:e.path,reason:t})}}),isSuccess:e=>"success"===e.result.case,getErrorMessage:e=>{switch(e.result.case){case"error":return e.result.value.error||"Ls error";case"rejected":return e.result.value.reason||"Ls rejected";case"timeout":return"Ls operation timed out";default:return"Unknown error"}},getFailureType:e=>"timeout"===e.result.case?"timeout":"error",createSuccessOutput:e=>({file_path:e.path,success:!0})};class ae{wrappedExecutor;constructor(e,t,o){this.wrappedExecutor=R(e,t,o,ne)}execute(e,t,o){return this.wrappedExecutor.execute(e,t,o)}}var ce=o("../proto/dist/generated/agent/v1/mcp_exec_pb.js"),ie=o("../../node_modules/.pnpm/@bufbuild+protobuf@1.10.0/node_modules/@bufbuild/protobuf/dist/esm/google/protobuf/struct_pb.js");const ue=(0,c.h)("hooks-exec:mcp");class le{innerExecutor;hookExecutor;baseHookRequestExtractor;mcpLease;constructor(e,t,o,s){this.innerExecutor=e,this.hookExecutor=t,this.baseHookRequestExtractor=o,this.mcpLease=s}async execute(e,t,o){var r,n,a,c,i;const u=this.baseHookRequestExtractor(e),l=(0,v.randomUUID)();let d=Object.fromEntries(Object.entries(t.args).map((([e,t])=>[e,null==t?void 0:t.toJson()])));const f=`MCP:${t.toolName}`;try{const o=await this.hookExecutor.executeHookForStep(s._E.preToolUse,Object.assign(Object.assign({},u),{tool_name:f,tool_input:d,tool_use_id:l}));if("deny"===(null==o?void 0:o.permission)){const t=o.user_message||"MCP tool blocked by preToolUse hook";return this.firePostToolUseFailure(e,u,f,d,t,"permission_denied",0,l,!1),new ce.iz({result:{case:"permissionDenied",value:new ce.HQ({error:h("MCP tool execution",t),isReadonly:!1})}})}if(null==o?void 0:o.updated_input)try{for(const[e,s]of Object.entries(o.updated_input))void 0!==s&&(t.args[e]=ie.WT.fromJson(s));d=Object.fromEntries(Object.entries(t.args).map((([e,t])=>[e,null==t?void 0:t.toJson()])))}catch(t){ue.warn(e,"Failed to merge updated_input for MCP",{error:t instanceof Error?t.message:String(t)})}}catch(t){if(null!==(c=null===(n=(r=this.hookExecutor).hasFailClosedHooksForStep)||void 0===n?void 0:n.call(r,s._E.preToolUse,f))&&void 0!==c&&c){const o=p(`preToolUse hook failed: ${t instanceof Error?t.message:"preToolUse hook error"}`);return this.firePostToolUseFailure(e,u,f,d,o,"error",0,l,!1),new ce.iz({result:{case:"permissionDenied",value:new ce.HQ({error:h("MCP tool execution",o),isReadonly:!1})}})}ue.warn(e,"preToolUse hook error in MCP executor",{toolName:f,error:t instanceof Error?t.message:String(t)})}const g=await(null===(a=this.mcpLease)||void 0===a?void 0:a.getClient(t.providerIdentifier)),m=null==g?void 0:g.config;let k;k=m&&"url"in m&&m.url?{url:m.url}:m&&"command"in m?{command:[m.command,...null!==(i=m.args)&&void 0!==i?i:[]].filter(Boolean).join(" ")}:{command:t.providerIdentifier};const x=Object.assign(Object.assign(Object.assign({},u),{tool_name:t.toolName,tool_input:JSON.stringify(d)}),k),w=await this.hookExecutor.executeHookForStep(s._E.beforeMCPExecution,x);if("deny"===(null==w?void 0:w.permission)){const t=h("MCP tool execution",w.user_message);return this.firePostToolUseFailure(e,u,f,d,t,"permission_denied",0,l,!1),new ce.iz({result:{case:"permissionDenied",value:new ce.HQ({error:t,isReadonly:!1})}})}const y=E.performance.now();try{const r=await this.innerExecutor.execute(e,t,o),n=j(E.performance.now()-y);let a="{}";if("success"===r.result.case)try{const e=r.result.value.content.map((e=>"text"===e.content.case?{type:"text",text:e.content.value.text}:"image"===e.content.case?{type:"image",data:Buffer.from(e.content.value.data).toString("base64"),mimeType:e.content.value.mimeType}:{type:"unknown"}));a=JSON.stringify({content:e,isError:r.result.value.isError})}catch(t){ue.warn(e,"Failed to serialize MCP result",{error:t instanceof Error?t.message:String(t)}),a=JSON.stringify({error:"Failed to serialize result"})}else"error"===r.result.case?a=JSON.stringify({error:r.result.value.error}):"rejected"===r.result.case?a=JSON.stringify({rejected:!0,reason:r.result.value.reason}):"permissionDenied"===r.result.case&&(a=JSON.stringify({permissionDenied:!0,error:r.result.value.error}));const c=Object.assign(Object.assign({},u),{tool_name:t.toolName,tool_input:JSON.stringify(d),result_json:a,duration:n});await this.hookExecutor.executeHookForStep(s._E.afterMCPExecution,c);const i=await this.firePostToolUse(e,u,f,d,a,n,l);if(void 0!==(null==i?void 0:i.updated_mcp_tool_output))try{const e=i.updated_mcp_tool_output,t=[];if("string"==typeof e)t.push(new ce._Z({content:{case:"text",value:new ce.zN({text:e})}}));else if("object"==typeof e&&null!==e&&"content"in e&&Array.isArray(e.content)){const o=e.content;for(const e of o)"object"==typeof e&&null!==e&&"type"in e&&"text"===e.type&&"text"in e?t.push(new ce._Z({content:{case:"text",value:new ce.zN({text:String(e.text)})}})):t.push(new ce._Z({content:{case:"text",value:new ce.zN({text:JSON.stringify(e)})}}))}else t.push(new ce._Z({content:{case:"text",value:new ce.zN({text:JSON.stringify(e)})}}));const o="object"==typeof e&&null!==e&&"isError"in e&&Boolean(e.isError);return new ce.iz({result:{case:"success",value:new ce.QW({content:t,isError:o})}})}catch(t){return ue.warn(e,"Failed to process updated_mcp_tool_output",{error:t instanceof Error?t.message:String(t)}),r}return r}catch(t){const o=j(E.performance.now()-y),s=t instanceof Error?t.message:String(t);throw this.firePostToolUseFailure(e,u,f,d,s,"error",o,l,!1),t}}async firePostToolUse(e,t,o,r,n,a,c){try{return await this.hookExecutor.executeHookForStep(s._E.postToolUse,Object.assign(Object.assign({},t),{tool_name:o,tool_input:r,tool_output:n,duration:a,tool_use_id:c}))}catch(t){return void ue.warn(e,"postToolUse hook error in MCP executor",{error:t instanceof Error?t.message:String(t)})}}firePostToolUseFailure(e,t,o,r,n,a,c,i,u){this.hookExecutor.executeHookForStep(s._E.postToolUseFailure,Object.assign(Object.assign({},t),{tool_name:o,tool_input:r,error_message:n,failure_type:a,duration:c,tool_use_id:i,is_interrupt:u})).catch((t=>{ue.warn(e,"postToolUseFailure hook error in MCP executor",{error:t instanceof Error?t.message:String(t)})}))}}const de={toolName:"ListMcpResources",createToolInput:e=>({server:e.server}),applyUpdatedInput:(e,t)=>{"string"==typeof t.server&&(e.server=t.server)},createRejectedResult:(e,t)=>new ce.kP({result:{case:"error",value:new ce.w2({error:t})}}),isSuccess:e=>"success"===e.result.case,getErrorMessage:e=>{switch(e.result.case){case"error":return e.result.value.error||"ListMcpResources error";case"rejected":return e.result.value.reason||"ListMcpResources rejected";default:return"Unknown error"}},createSuccessOutput:(e,t)=>"success"===t.result.case?{resources_count:t.result.value.resources.length}:{success:!0}};class pe{wrappedExecutor;constructor(e,t,o){this.wrappedExecutor=R(e,t,o,de)}execute(e,t,o){return this.wrappedExecutor.execute(e,t,o)}}const he={toolName:"FetchMcpResource",createToolInput:e=>({server:e.server,uri:e.uri,download_path:e.downloadPath}),applyUpdatedInput:(e,t)=>{"string"==typeof t.server&&(e.server=t.server),"string"==typeof t.uri&&(e.uri=t.uri),"string"==typeof t.download_path&&(e.downloadPath=t.download_path)},createRejectedResult:(e,t)=>new ce.ZD({result:{case:"error",value:new ce.Jx({error:t})}}),isSuccess:e=>"success"===e.result.case,getErrorMessage:e=>{switch(e.result.case){case"error":return e.result.value.error||"ReadMcpResource error";case"rejected":return e.result.value.reason||"ReadMcpResource rejected";case"notFound":return"Resource not found";default:return"Unknown error"}},createSuccessOutput:(e,t)=>{if("success"===t.result.case){const o=t.result.value;return{uri:e.uri,name:o.name,mime_type:o.mimeType,download_path:o.downloadPath,content_type:o.content.case,content_length:"text"===o.content.case||"blob"===o.content.case?o.content.value.length:void 0}}return{uri:e.uri,success:!0}}};class fe{wrappedExecutor;constructor(e,t,o){this.wrappedExecutor=R(e,t,o,he)}execute(e,t,o){return this.wrappedExecutor.execute(e,t,o)}}var ge=o("../proto/dist/generated/agent/v1/read_exec_pb.js");const me={toolName:"Read",getToolCallId:C,createToolInput:e=>({file_path:e.path}),applyUpdatedInput:(e,t)=>{"string"==typeof t.file_path&&(e.path=t.file_path)},createRejectedResult:(e,t)=>new ge.sV({result:{case:"rejected",value:new ge.f4({path:e.path,reason:t})}}),isSuccess:e=>"success"===e.result.case,getErrorMessage:e=>{switch(e.result.case){case"error":return e.result.value.error||"Read error";case"rejected":return e.result.value.reason||"Read rejected";case"fileNotFound":return`File not found: ${e.result.value.path}`;case"permissionDenied":return`Permission denied: ${e.result.value.path}`;case"invalidFile":return`Invalid file: ${e.result.value.path}`;default:return"Unknown error"}},createSuccessOutput:(e,t)=>{if("success"===t.result.case){const o="content"===t.result.value.output.case?t.result.value.output.value:"";return{file_path:e.path,content_length:o.length}}return{file_path:e.path,success:!0}},runPostExecutionHooks:async e=>{const{args:t,result:o,baseHookRequest:r,hookExecutor:n}=e;if("success"!==o.result.case)return;const a="content"===o.result.value.output.case?o.result.value.output.value:"",c=await async function(e,t){try{return await e()}catch(e){const o=function(e,t){return`${null!=e?e:"Action"} was blocked because a configured hook failed to execute${t?`: ${t}`:"."}\n\nThis is a safety measure (fail-closed) - when hooks cannot be evaluated, the action is blocked to prevent potentially unsafe operations.\n\n${d}`}(t,e instanceof Error?e.message:String(e));throw new l(o,e)}}((()=>n.executeHookForStep(s._E.beforeReadFile,Object.assign(Object.assign({},r),{content:a,file_path:t.path,attachments:[]}))),"File read");if("deny"===(null==c?void 0:c.permission)){const e=h("File read",c.user_message);throw new u(e)}}};class ke{wrappedExecutor;constructor(e,t,o){this.wrappedExecutor=R(e,t,o,me)}execute(e,t,o){return this.wrappedExecutor.execute(e,t,o)}}var xe=o("../proto/dist/generated/agent/v1/record_screen_exec_pb.js");const we={toolName:"RecordScreen",getToolCallId:C,createToolInput:e=>({mode:e.mode,save_as_filename:e.saveAsFilename}),createRejectedResult:(e,t)=>new xe.Tj({result:{case:"failure",value:new xe.yH({error:t})}}),isSuccess:e=>"failure"!==e.result.case,getErrorMessage:e=>"failure"===e.result.case?e.result.value.error||"RecordScreen failed":"Unknown error",createSuccessOutput:(e,t)=>({result_type:t.result.case})};class ye{wrappedExecutor;constructor(e,t,o){this.wrappedExecutor=R(e,t,o,we)}execute(e,t,o){return this.wrappedExecutor.execute(e,t,o)}}function be(e){return"success"===e.result.case||"failure"===e.result.case?e.result.value.stdout+e.result.value.stderr:""}const ve={toolName:q,createToolInput:e=>{const t=e.workingDirectory||"",o=e.timeout;return Object.assign({command:e.command,cwd:t},"number"==typeof o&&o>0&&{timeout:o})},applyUpdatedInput:(e,t)=>{"string"==typeof t.command&&(e.command=t.command),"string"==typeof t.cwd&&(e.workingDirectory=t.cwd),"number"==typeof t.timeout&&t.timeout>=0&&(e.timeout=t.timeout)},createRejectedResult:(e,t)=>new U.W4({result:{case:"rejected",value:new U.pZ({command:e.command,workingDirectory:e.workingDirectory,reason:t})}}),isSuccess:e=>"success"===e.result.case||"failure"===e.result.case&&!e.result.value.aborted,getErrorMessage:e=>{switch(e.result.case){case"timeout":return`Command timed out after ${e.result.value.timeoutMs}ms`;case"spawnError":return e.result.value.error||"Failed to spawn command";case"failure":return e.result.value.aborted?"Command was aborted":"Command failed";case"rejected":return e.result.value.reason||"Command rejected";default:return"Unknown error"}},getFailureType:e=>"timeout"===e.result.case?"timeout":"error",isInterrupt:e=>"failure"===e.result.case&&!0===e.result.value.aborted,createSuccessOutput:(e,t)=>({output:be(t),exitCode:"success"===t.result.case?0:1}),getExtraHookFields:e=>({cwd:e.workingDirectory||""}),runPreExecutionHooks:async e=>{const{args:t,baseHookRequest:o,hookExecutor:r}=e,n=t.workingDirectory||"",a=await r.executeHookForStep(s._E.beforeShellExecution,Object.assign(Object.assign({},o),{command:t.command,cwd:n,sandbox:D(t.requestedSandboxPolicy)}));if("deny"===(null==a?void 0:a.permission)){const e=h("Command execution",a.user_message);throw new u(e)}},runPostExecutionHooks:async e=>{const{args:t,result:o,baseHookRequest:r,hookExecutor:n,executionDurationMs:a}=e,c=be(o);await n.executeHookForStep(s._E.afterShellExecution,Object.assign(Object.assign({},r),{command:t.command,output:c,duration:a,sandbox:D(t.requestedSandboxPolicy)}))}};class Ee{wrappedExecutor;constructor(e,t,o){this.wrappedExecutor=R(e,t,o,ve)}execute(e,t,o){return this.wrappedExecutor.execute(e,t,o)}}class _e{output="";exitEvent;onEvent(e){"stdout"===e.event.case||"stderr"===e.event.case?this.output+=e.event.value.data:"exit"===e.event.case&&(this.exitEvent=e.event.value)}getOutput(){return this.output}isAborted(){var e,t;return null!==(t=null===(e=this.exitEvent)||void 0===e?void 0:e.aborted)&&void 0!==t&&t}getExitCode(){var e,t;return null!==(t=null===(e=this.exitEvent)||void 0===e?void 0:e.code)&&void 0!==t?t:0}}const je={toolName:q,createToolInput:e=>{const t=e.workingDirectory||"",o=e.timeout;return Object.assign({command:e.command,cwd:t},"number"==typeof o&&o>0&&{timeout:o})},applyUpdatedInput:(e,t)=>{"string"==typeof t.command&&(e.command=t.command),"string"==typeof t.cwd&&(e.workingDirectory=t.cwd),"number"==typeof t.timeout&&t.timeout>=0&&(e.timeout=t.timeout)},createRejectedEvent:(e,t)=>new U.FI({event:{case:"rejected",value:new U.pZ({command:e.command,workingDirectory:e.workingDirectory,reason:t})}}),getExtraHookFields:e=>({cwd:e.workingDirectory||""}),createResultCollector:()=>new _e,createSuccessOutput:(e,t)=>({output:t.getOutput(),exitCode:t.getExitCode()}),runPreExecutionHooks:async e=>{const{args:t,baseHookRequest:o,hookExecutor:r}=e,n=t.workingDirectory||"",a=D(t.requestedSandboxPolicy),c=await r.executeHookForStep(s._E.beforeShellExecution,Object.assign(Object.assign({},o),{command:t.command,cwd:n,sandbox:a}));if("deny"===(null==c?void 0:c.permission)){const e=h("Command execution",c.user_message);throw new u(e)}},runPostExecutionHooks:async e=>{const{args:t,baseHookRequest:o,hookExecutor:r,collector:n,executionDurationMs:a}=e,c=D(t.requestedSandboxPolicy);await r.executeHookForStep(s._E.afterShellExecution,Object.assign(Object.assign({},o),{command:t.command,output:n.getOutput(),duration:a,sandbox:c}))}};class He{wrappedExecutor;constructor(e,t,o){this.wrappedExecutor=function(e,t,o,s){return{async*execute(r,n,a){const{hookContext:c,helpers:i}=H(r,n,t,o,s),u=s.runPreExecutionHooks?async e=>{await s.runPreExecutionHooks(e)}:void 0,l=await S(r,n,t,c,i,s,((e,t)=>s.createRejectedEvent(e,t)),u);if("rejected"===l.type)return void(yield l.result);const d=E.performance.now(),p=s.createResultCollector();let h=!1;try{for await(const t of e.execute(r,n,a))p.onEvent(t),yield t}catch(e){h=!0;const t=j(E.performance.now()-d),o=e instanceof Error?e.message:String(e);throw i.fireFailure(t,o,"error"),e}const f=j(E.performance.now()-d);if(s.runPostExecutionHooks)try{await s.runPostExecutionHooks({ctx:r,args:n,baseHookRequest:c.baseHookRequest,hookExecutor:t,toolInput:i.getToolInput(),toolUseId:c.toolUseId,extraHookFields:c.extraHookFields,collector:p,executionDurationMs:f})}catch(e){_.warn(r,"postExecutionHooks error",{toolName:s.toolName,error:e instanceof Error?e.message:String(e)})}h||(p.isAborted()?i.fireFailure(f,"Command was aborted","error",!0):i.fireSuccess(f,JSON.stringify(s.createSuccessOutput(n,p))))}}}(e,t,o,je)}execute(e,t,o){return this.wrappedExecutor.execute(e,t,o)}}var Se=o("../local-exec/dist/index.js"),Ce=o("../proto/dist/generated/agent/v1/write_exec_pb.js"),Re=o("../../node_modules/.pnpm/diff@8.0.2/node_modules/diff/libesm/patch/create.js");class Pe{wrappedExecutor;constructor(e,t,o){const n=new Map;this.wrappedExecutor=R(e,t,o,function(e,t){return{toolName:"Write",getToolCallId:C,createToolInput:e=>({file_path:e.path,content:e.fileText}),applyUpdatedInput:(e,t)=>{"string"==typeof t.file_path&&(e.path=t.file_path)},createRejectedResult:(e,t)=>new Ce.v3({result:{case:"error",value:new Ce.QM({path:e.path,error:t})}}),isSuccess:e=>"success"===e.result.case,getErrorMessage:e=>"error"===e.result.case?e.result.value.error||"Write error":"Unknown error",createSuccessOutput:e=>({file_path:e.path,success:!0}),runPreExecutionHooks:async e=>{const{args:o,toolUseId:s}=e;let n,a=!1;try{(await(0,r.stat)(o.path)).size>262144?a=!0:n=await(0,Se.yR)(o.path)}catch(e){}t.set(s,{contentBeforeWrite:n,fileTooLarge:a})},runCleanup:e=>{t.delete(e)},runPostExecutionHooks:async o=>{const{args:r,result:n,baseHookRequest:a,toolUseId:c}=o,i=t.get(c);if("success"!==n.result.case)return;const{contentBeforeWrite:u,fileTooLarge:l}=null!=i?i:{fileTooLarge:!1};let d;d=l||void 0===u?[{old_string:"",new_string:r.fileText}]:u===r.fileText?[]:function(e,t){const o=(0,Re.YB)("","",e,t,"","",{context:0});return 0===o.hunks.length?[]:o.hunks.map((e=>{const t=[],o=[];for(const s of e.lines)s.startsWith("-")?t.push(s.slice(1)):s.startsWith("+")&&o.push(s.slice(1));return{old_string:t.join("\n"),new_string:o.join("\n")}}))}(u,r.fileText);const p=Object.assign(Object.assign({},a),{file_path:r.path,edits:d}),h=await e.executeHookForStep(s._E.afterFileEdit,p);if(r.returnFileContentAfterWrite&&void 0!==h){const e=n.result.value.path;try{const t=await(0,Se.yR)(e),o=(0,Se.lt)(t),s=Buffer.byteLength(t,"utf8");return new Ce.v3({result:{case:"success",value:new Ce.j6(Object.assign(Object.assign({},n.result.value),{fileContentAfterWrite:t,linesCreated:o,fileSize:s}))}})}catch(e){return}}}}}(t,n))}execute(e,t,o){return this.wrappedExecutor.execute(e,t,o)}}class Oe{innerAccessor;hookExecutor;baseHookRequestExtractor;mcpLease;hooksAdditionalContextPromise;teamHooksReadyPromise;hooksConfigLease;constructor(e,t,o,s,r,n,a){this.innerAccessor=e,this.hookExecutor=t,this.baseHookRequestExtractor=o,this.mcpLease=s,this.hooksAdditionalContextPromise=r,this.teamHooksReadyPromise=n,this.hooksConfigLease=a}get(e){var t;if(e.symbol===T.bo.symbol)return new T.gl(this.hookExecutor);const o=this.innerAccessor.get(e);return e.symbol===T.qk.symbol?new Ee(o,this.hookExecutor,this.baseHookRequestExtractor):e.symbol===T.wv.symbol?new He(o,this.hookExecutor,this.baseHookRequestExtractor):e.symbol===T.Ln.symbol?new Pe(o,this.hookExecutor,this.baseHookRequestExtractor):e.symbol===T.Yi.symbol?new le(o,this.hookExecutor,this.baseHookRequestExtractor,this.mcpLease):e.symbol===T._A.symbol?new ke(o,this.hookExecutor,this.baseHookRequestExtractor):e.symbol===T.bL.symbol?new ae(o,this.hookExecutor,this.baseHookRequestExtractor):e.symbol===T.u8.symbol?new se(o,this.hookExecutor,this.baseHookRequestExtractor):e.symbol===T.IG.symbol?new ee(o,this.hookExecutor,this.baseHookRequestExtractor):e.symbol===T.Rp.symbol?new Z(o,this.hookExecutor,this.baseHookRequestExtractor):e.symbol===T.w4.symbol?new G(o,this.hookExecutor,this.baseHookRequestExtractor):e.symbol===T.rn.symbol?new pe(o,this.hookExecutor,this.baseHookRequestExtractor):e.symbol===T.ml.symbol?new fe(o,this.hookExecutor,this.baseHookRequestExtractor):e.symbol===T.Ok.symbol?new L(o,this.hookExecutor,this.baseHookRequestExtractor):e.symbol===T.TQ.symbol?new A(o,this.hookExecutor,this.baseHookRequestExtractor):e.symbol===T.iZ.symbol?new W(o,this.hookExecutor,this.baseHookRequestExtractor):e.symbol===T.pq.symbol?new ye(o,this.hookExecutor,this.baseHookRequestExtractor):e.symbol===T.MZ.symbol&&(this.hooksAdditionalContextPromise||this.hooksConfigLease)?new F(o,null!==(t=this.hooksAdditionalContextPromise)&&void 0!==t?t:Promise.resolve(void 0),this.teamHooksReadyPromise,this.hooksConfigLease):o}*entries(){var e;for(const[t,o]of this.innerAccessor.entries())t.symbol===T.qk.symbol?yield[t,new Ee(o,this.hookExecutor,this.baseHookRequestExtractor)]:t.symbol===T.wv.symbol?yield[t,new He(o,this.hookExecutor,this.baseHookRequestExtractor)]:t.symbol===T.Ln.symbol?yield[t,new Pe(o,this.hookExecutor,this.baseHookRequestExtractor)]:t.symbol===T.Yi.symbol?yield[t,new le(o,this.hookExecutor,this.baseHookRequestExtractor,this.mcpLease)]:t.symbol===T._A.symbol?yield[t,new ke(o,this.hookExecutor,this.baseHookRequestExtractor)]:t.symbol===T.bL.symbol?yield[t,new ae(o,this.hookExecutor,this.baseHookRequestExtractor)]:t.symbol===T.u8.symbol?yield[t,new se(o,this.hookExecutor,this.baseHookRequestExtractor)]:t.symbol===T.IG.symbol?yield[t,new ee(o,this.hookExecutor,this.baseHookRequestExtractor)]:t.symbol===T.Rp.symbol?yield[t,new Z(o,this.hookExecutor,this.baseHookRequestExtractor)]:t.symbol===T.w4.symbol?yield[t,new G(o,this.hookExecutor,this.baseHookRequestExtractor)]:t.symbol===T.rn.symbol?yield[t,new pe(o,this.hookExecutor,this.baseHookRequestExtractor)]:t.symbol===T.ml.symbol?yield[t,new fe(o,this.hookExecutor,this.baseHookRequestExtractor)]:t.symbol===T.Ok.symbol?yield[t,new L(o,this.hookExecutor,this.baseHookRequestExtractor)]:t.symbol===T.TQ.symbol?yield[t,new A(o,this.hookExecutor,this.baseHookRequestExtractor)]:t.symbol===T.iZ.symbol?yield[t,new W(o,this.hookExecutor,this.baseHookRequestExtractor)]:t.symbol===T.pq.symbol?yield[t,new ye(o,this.hookExecutor,this.baseHookRequestExtractor)]:t.symbol===T.MZ.symbol&&(this.hooksAdditionalContextPromise||this.hooksConfigLease)?yield[t,new F(o,null!==(e=this.hooksAdditionalContextPromise)&&void 0!==e?e:Promise.resolve(void 0),this.teamHooksReadyPromise,this.hooksConfigLease)]:yield[t,o];yield[T.bo,new T.gl(this.hookExecutor)]}}}};